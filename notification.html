<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 알림</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        deepBlue: '#1D4ED8',
                        electricPurple: '#7C3AED',
                        softBlue: '#EFF6FF'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    animation: {
                        'swing': 'swing 3s ease-in-out infinite'
                    },
                    keyframes: {
                        swing: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '20%': { transform: 'rotate(15deg)' },
                            '40%': { transform: 'rotate(-10deg)' },
                            '60%': { transform: 'rotate(5deg)' },
                            '80%': { transform: 'rotate(-5deg)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-24 select-none">
    <!-- Header -->
    <header class="bg-white h-16 sticky top-0 z-20 flex items-center justify-center shadow-sm px-4 relative">
        <h1 class="text-lg font-bold text-gray-900">알림</h1>
        <button id="markAllReadBtn" onclick="markAllAsRead()" class="absolute right-4 text-xs text-gray-500 font-bold hover:text-deepBlue transition hidden">모두 읽음</button>
    </header>

    <!-- Pull to Refresh Indicator -->
    <div id="ptr-indicator" class="fixed top-16 left-0 right-0 flex justify-center items-center h-16 -mt-16 transition-transform z-10 pointer-events-none">
        <div class="bg-white p-2 rounded-full shadow-md border border-gray-100 flex items-center justify-center">
            <i id="ptr-icon" data-lucide="arrow-down" class="w-5 h-5 text-deepBlue"></i>
        </div>
    </div>

    <!-- Main Content -->
    <main class="p-5 max-w-md mx-auto min-h-[calc(100vh-8rem)] relative" style="overscroll-behavior-y: contain;">
        <!-- Filter Buttons -->
        <div class="flex gap-2 mb-4">
            <button onclick="setFilter('all')" id="filter-all" class="px-4 py-2 rounded-full text-sm font-bold bg-deepBlue text-white transition shadow-sm">전체</button>
            <button onclick="setFilter('transfer')" id="filter-transfer" class="px-4 py-2 rounded-full text-sm font-bold bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 transition shadow-sm">입출금</button>
            <button onclick="setFilter('loan')" id="filter-loan" class="px-4 py-2 rounded-full text-sm font-bold bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 transition shadow-sm">대출</button>
        </div>
        <div id="notificationList" class="space-y-3">
            <!-- JS Rendering -->
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-16 z-50 pb-1">
        <a href="home.html" class="flex flex-col items-center text-gray-400 w-full h-full justify-center hover:text-gray-600">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium">홈</span>
        </a>
        <a href="assets.html" class="flex flex-col items-center text-gray-400 w-full h-full justify-center hover:text-gray-600">
            <i data-lucide="pie-chart" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium">자산</span>
        </a>
        <a href="notification.html" class="flex flex-col items-center text-deepBlue w-full h-full justify-center">
            <i data-lucide="bell" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium">알림</span>
        </a>
        <a href="#" class="flex flex-col items-center text-gray-400 w-full h-full justify-center hover:text-gray-600">
            <i data-lucide="menu" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1 font-medium">전체</span>
        </a>
    </nav>

    <!-- Snackbar -->
    <div id="snackbar" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-4 transition-all duration-300 opacity-0 translate-y-10 z-50 pointer-events-none">
        <span class="text-sm">알림이 삭제되었습니다.</span>
        <button onclick="undoDelete()" class="text-electricPurple font-bold text-sm hover:text-purple-300">실행 취소</button>
    </div>

    <script>
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            renderNotifications();
        });

        // 스와이프 관련 변수
        let startX = 0;
        let currentSwipeElement = null;
        let currentFilter = 'all';
        let isDragging = false;
        let lastDeletedItem = null;
        let lastDeletedIndex = -1;
        let snackbarTimeout = null;
        
        // Pull to Refresh 관련 변수
        const ptrIndicator = document.getElementById('ptr-indicator');
        const ptrIcon = document.getElementById('ptr-icon');
        let ptrStartY = 0;
        let ptrDist = 0;
        let isPtrRefreshing = false;

        function renderNotifications() {
            const listEl = document.getElementById('notificationList');
            const allNotifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');

            // 읽지 않은 알림이 있는지 확인하여 버튼 제어
            const hasUnread = allNotifications.some(n => !n.read);
            const markAllBtn = document.getElementById('markAllReadBtn');
            if (hasUnread) {
                markAllBtn.classList.remove('hidden');
            } else {
                markAllBtn.classList.add('hidden');
            }

            // 필터링 적용
            let notifications = allNotifications.map((n, i) => ({...n, originalIndex: i}));
            if (currentFilter !== 'all') {
                notifications = notifications.filter(n => n.type === currentFilter);
            }

            if (notifications.length === 0) {
                listEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i data-lucide="bell-off" class="w-12 h-12 mb-3 opacity-50 animate-swing"></i>
                        <p>새로운 알림이 없습니다.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            listEl.innerHTML = notifications.map((noti) => {
                const isRead = noti.read || false;
                const icon = noti.type === 'transfer' ? 'arrow-right-left' : 'file-check';
                
                const containerBg = isRead ? 'bg-gray-50' : 'bg-white';
                const titleStyle = isRead ? 'font-medium text-gray-500' : 'font-bold text-gray-900';
                const iconStyle = isRead ? 'bg-gray-200 text-gray-400' : (noti.type === 'transfer' ? 'bg-blue-50 text-deepBlue' : 'bg-purple-50 text-electricPurple');

                return `
                    <div class="relative overflow-hidden rounded-xl group select-none">
                        <!-- 삭제 버튼 (뒤) -->
                        <div class="absolute right-0 top-0 bottom-0 w-20 bg-red-500 flex items-center justify-center text-white font-bold text-sm cursor-pointer z-0" onclick="deleteNotification(${noti.originalIndex})">
                            삭제
                        </div>
                        
                        <!-- 컨텐츠 (앞) -->
                        <div class="relative ${containerBg} p-4 border border-gray-100 shadow-sm flex gap-4 z-10 transition-transform duration-200 ease-out"
                             ontouchstart="handleTouchStart(event)"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="handleTouchEnd(event)"
                             onclick="onNotificationClick('${noti.type}', '${noti.productId || ''}')">
                            <div class="w-10 h-10 rounded-full ${iconStyle} flex-shrink-0 flex items-center justify-center transition-colors">
                                <i data-lucide="${icon}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="${titleStyle} text-sm transition-colors">${noti.title}</h3>
                                    <span class="text-xs text-gray-400">${noti.date}</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-snug">${noti.message}</p>
                            </div>
                            ${!isRead ? `<div class="absolute top-4 right-4 w-2 h-2 bg-red-500 rounded-full"></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function handleTouchStart(e) {
            isDragging = false;
            startX = e.touches[0].clientX;
            currentSwipeElement = e.currentTarget;
            currentSwipeElement.style.transition = 'none'; // 드래그 중에는 트랜지션 끔
        }

        function handleTouchMove(e) {
            if (!currentSwipeElement) return;
            const currentX = e.touches[0].clientX;
            const diff = currentX - startX;

            if (Math.abs(diff) > 5) isDragging = true;

            // 왼쪽으로만 스와이프 허용 (최대 -80px)
            if (diff < 0 && diff > -100) {
                currentSwipeElement.style.transform = `translateX(${diff}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!currentSwipeElement) return;
            const currentX = e.changedTouches[0].clientX;
            const diff = currentX - startX;

            currentSwipeElement.style.transition = 'transform 0.2s ease-out'; // 트랜지션 복구

            if (diff < -50) { // 50px 이상 밀었으면 삭제 버튼 노출
                currentSwipeElement.style.transform = 'translateX(-80px)';
            } else {
                currentSwipeElement.style.transform = 'translateX(0)';
            }
            currentSwipeElement = null;
        }

        function deleteNotification(originalIndex) {
            const notifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');
            
            // 백업
            lastDeletedItem = notifications[originalIndex];
            lastDeletedIndex = originalIndex;

            // 삭제
            notifications.splice(originalIndex, 1);
            localStorage.setItem('trustFinNotifications', JSON.stringify(notifications));
            
            renderNotifications();
            showSnackbar();
        }

        function showSnackbar() {
            const snackbar = document.getElementById('snackbar');
            if (snackbarTimeout) clearTimeout(snackbarTimeout);
            
            snackbar.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            
            snackbarTimeout = setTimeout(() => {
                snackbar.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            }, 3000);
        }

        function undoDelete() {
            if (lastDeletedItem && lastDeletedIndex > -1) {
                const notifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');
                
                // 복구
                notifications.splice(lastDeletedIndex, 0, lastDeletedItem);
                localStorage.setItem('trustFinNotifications', JSON.stringify(notifications));
                
                renderNotifications();
                
                // 스낵바 숨김
                const snackbar = document.getElementById('snackbar');
                snackbar.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                if (snackbarTimeout) clearTimeout(snackbarTimeout);
                
                lastDeletedItem = null;
                lastDeletedIndex = -1;
            }
        }

        function markAllAsRead() {
            const notifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');
            const updated = notifications.map(n => ({ ...n, read: true }));
            localStorage.setItem('trustFinNotifications', JSON.stringify(updated));
            renderNotifications();
        }

        function setFilter(filter) {
            currentFilter = filter;
            
            // 버튼 스타일 업데이트
            const buttons = ['all', 'transfer', 'loan'];
            buttons.forEach(btn => {
                const el = document.getElementById(`filter-${btn}`);
                if (btn === filter) {
                    el.className = 'px-4 py-2 rounded-full text-sm font-bold bg-deepBlue text-white transition shadow-sm';
                } else {
                    el.className = 'px-4 py-2 rounded-full text-sm font-bold bg-white text-gray-500 border border-gray-200 hover:bg-gray-50 transition shadow-sm';
                }
            });
            renderNotifications();
        }

        function onNotificationClick(type, productId) {
            if (isDragging) return; // 스와이프 중이면 클릭 무시

            if (type === 'loan') {
                if (productId) {
                    localStorage.setItem('selectedProductId', productId);
                    window.location.href = 'xai_detail.html';
                }
            } else if (type === 'transfer') {
                window.location.href = 'assets.html';
            }
        }

        // Pull to Refresh Logic
        const mainContent = document.querySelector('main');

        mainContent.addEventListener('touchstart', (e) => {
            if (mainContent.scrollTop === 0) {
                ptrStartY = e.touches[0].clientY;
            }
        }, { passive: true });

        mainContent.addEventListener('touchmove', (e) => {
            const y = e.touches[0].clientY;
            const diff = y - ptrStartY;
            
            // 최상단에서 아래로 당길 때만
            if (mainContent.scrollTop === 0 && diff > 0 && !isPtrRefreshing) {
                ptrDist = diff;
                // 저항감 적용 (0.4배)
                const translateY = Math.min(ptrDist * 0.4, 80);
                
                ptrIndicator.style.transform = `translateY(${translateY}px)`;
                ptrIndicator.style.transition = 'none'; // 드래그 중에는 즉시 반응

                // 아이콘 회전 효과
                const rotation = Math.min(translateY * 4, 180);
                ptrIcon.style.transform = `rotate(${rotation}deg)`;
            }
        }, { passive: true });

        mainContent.addEventListener('touchend', () => {
            if (isPtrRefreshing) return;
            
            ptrIndicator.style.transition = 'transform 0.3s ease'; // 놓았을 때 부드럽게

            if (ptrDist * 0.4 > 50) { // 임계값 도달
                isPtrRefreshing = true;
                ptrIndicator.style.transform = `translateY(50px)`;
                
                // 로딩 아이콘으로 변경
                ptrIcon.setAttribute('data-lucide', 'loader-2');
                ptrIcon.classList.add('animate-spin');
                ptrIcon.style.transform = 'rotate(0deg)';
                lucide.createIcons();

                // 새로고침 시뮬레이션
                setTimeout(() => {
                    renderNotifications();
                    resetPtr();
                }, 1500);
            } else {
                resetPtr();
            }
            ptrDist = 0;
        });

        function resetPtr() {
            isPtrRefreshing = false;
            ptrIndicator.style.transform = `translateY(0px)`;
            
            // 아이콘 복구
            setTimeout(() => {
                ptrIcon.setAttribute('data-lucide', 'arrow-down');
                ptrIcon.classList.remove('animate-spin');
                ptrIcon.style.transform = 'rotate(0deg)';
                lucide.createIcons();
            }, 300);
        }
    </script>
</body>
</html>