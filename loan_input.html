<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 대출 상담</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="common.js"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans pb-24 select-none transition-colors duration-300">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 sticky top-0 z-20 shadow-sm dark:shadow-gray-900/50 transition-colors duration-300">
        <div class="flex items-center gap-4 p-4">
            <button onclick="history.back()" class="hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded transition">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
            <h1 class="text-base font-bold text-gray-900 dark:text-white">대출 상담</h1>
        </div>
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 dark:bg-gray-700 h-1">
            <div id="progressBar" class="bg-black dark:bg-white h-1 transition-all duration-500 ease-out" style="width: 50%"></div>
        </div>
    </header>

    <!-- Main Form -->
    <main class="p-4 max-w-md mx-auto space-y-3">
        
        <!-- Step 1: Purpose Selection -->
        <div id="step1-section" class="animate-slide-in-right">
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">대출 목적을<br>선택해주세요.</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2 text-xs">목적에 맞는 최적의 상품을 추천해드립니다.</p>
            </div>
            <div class="space-y-3 mt-6">
                <button type="button" onclick="selectPurpose('living', this)" class="survey-option w-full p-3 rounded-card border border-gray-200 dark:border-gray-700 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition flex justify-between items-center group bg-white dark:bg-gray-800">
                    <span class="text-gray-700 dark:text-gray-300 text-sm">생활비</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 transition-opacity"></i>
                </button>
                <button type="button" onclick="selectPurpose('refinance', this)" class="survey-option w-full p-3 rounded-card border border-gray-200 dark:border-gray-700 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition flex justify-between items-center group bg-white dark:bg-gray-800">
                    <span class="text-gray-700 dark:text-gray-300 text-sm">대환대출 (갈아타기)</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 transition-opacity"></i>
                </button>
                <button type="button" onclick="selectPurpose('housing', this)" class="survey-option w-full p-3 rounded-card border border-gray-200 dark:border-gray-700 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition flex justify-between items-center group bg-white dark:bg-gray-800">
                    <span class="text-gray-700 dark:text-gray-300 text-sm">주택/전세 자금</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 transition-opacity"></i>
                </button>
                <button type="button" onclick="selectPurpose('business', this)" class="survey-option w-full p-3 rounded-card border border-gray-200 dark:border-gray-700 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition flex justify-between items-center group bg-white dark:bg-gray-800">
                    <span class="text-gray-700 dark:text-gray-300 text-sm">사업 자금</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 transition-opacity"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Info Form (Initially Hidden) -->
        <div id="step2-section" class="hidden">
            <div>
                <h1 class="text-xl font-bold text-gray-900 dark:text-white">고객님께 딱 맞는<br>상품을 찾아드릴게요.</h1>
                <div class="flex items-center gap-1 mt-2 relative">
                    <p class="text-gray-500 dark:text-gray-400 text-xs">기본 정보를 확인해주세요.</p>
                    <button onclick="toggleEditTooltip(event)" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition p-0.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i data-lucide="info" class="w-3 h-3"></i>
                    </button>
                    <div id="editTooltip" class="absolute top-7 left-0 z-20 w-60 bg-gray-900/95 dark:bg-white/95 backdrop-blur text-white dark:text-gray-900 text-[10px] p-3 rounded-xl shadow-xl hidden animate-fade-in-up border border-white/10 dark:border-gray-200">
                        자동으로 입력된 정보가 실제와 다를 경우,<br>해당 항목을 눌러 직접 수정하실 수 있습니다.
                    </div>
                </div>
            </div>

            <form id="infoForm" class="space-y-5 mt-6 transition-colors duration-300">
            <!-- Income -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400">연소득 (만원)</label>
                    <span class="text-[8px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 px-1.5 py-0.5 rounded flex items-center gap-0.5">
                        <i data-lucide="link" class="w-2 h-2"></i> 국세청 자동 연동
                    </span>
                </div>
                <input type="tel" inputmode="numeric" enterkeyhint="next" id="income" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',')" placeholder="예: 5,000" class="w-full text-sm font-bold border border-gray-200 dark:border-gray-700 rounded-card px-4 py-3 bg-white dark:bg-gray-800 focus:border-black dark:focus:border-white outline-none transition placeholder-gray-300 dark:placeholder-gray-600 dark:text-white" required>
            </div>

            <!-- Credit Score -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400">신용점수 (0~1000)</label>
                    <span class="text-[8px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 px-1.5 py-0.5 rounded flex items-center gap-0.5">
                        <i data-lucide="link" class="w-2 h-2"></i> KCB 자동 연동
                    </span>
                </div>
                <input type="tel" inputmode="numeric" enterkeyhint="done" id="creditScore" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',')" placeholder="예: 850" class="w-full text-sm font-bold border border-gray-200 dark:border-gray-700 rounded-card px-4 py-3 bg-white dark:bg-gray-800 focus:border-black dark:focus:border-white outline-none transition placeholder-gray-300 dark:placeholder-gray-600 dark:text-white" required>
            </div>

            <!-- Employment Type -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400">고용 형태</label>
                    <span class="text-[8px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 px-1.5 py-0.5 rounded flex items-center gap-0.5">
                        <i data-lucide="link" class="w-2 h-2"></i> 건강보험공단 연동
                    </span>
                </div>
                <div onclick="openEmploymentModal()" class="w-full border border-gray-200 dark:border-gray-700 rounded-card px-4 py-3 bg-white dark:bg-gray-800 cursor-pointer flex justify-between items-center hover:border-black dark:hover:border-white transition group">
                    <span id="selectedEmploymentText" class="text-sm font-bold text-gray-900 dark:text-white transition">직장인</span>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition group-hover:text-black dark:group-hover:text-white"></i>
                </div>
                <input type="hidden" id="employmentType" value="regular">
            </div>

            <!-- Account Selection -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400">입금 받을 계좌</label>
                    <span class="text-[8px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 px-1.5 py-0.5 rounded flex items-center gap-0.5">
                        <i data-lucide="link" class="w-2 h-2"></i> 마이데이터 연동
                    </span>
                </div>
                <div onclick="openAccountModal()" class="w-full border border-gray-200 dark:border-gray-700 rounded-card px-4 py-3 bg-white dark:bg-gray-800 cursor-pointer flex justify-between items-center hover:border-black dark:hover:border-white transition group">
                    <span id="selectedAccountText" class="text-sm font-bold text-gray-400 dark:text-gray-500 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition">계좌를 선택해주세요</span>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition group-hover:text-black dark:group-hover:text-white"></i>
                </div>
                <input type="hidden" id="accountSelect">
            </div>

            <!-- Terms Agreement -->
            <div class="pt-2">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-900 dark:text-white">약관 및 동의</h3>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-card border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div onclick="toggleAllTerms()" class="p-4 border-b border-gray-200 dark:border-gray-600 flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                        <div id="checkAll" class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-500 flex items-center justify-center transition-colors">
                            <i data-lucide="check" class="w-4 h-4 text-white"></i>
                        </div>
                        <span class="text-sm font-bold text-gray-900 dark:text-white">약관 전체 동의</span>
                    </div>
                    <div class="p-4 space-y-3">
                        <div onclick="openTermModal(0)" class="flex items-center gap-3 cursor-pointer">
                            <div id="check0" onclick="toggleTerm(0); event.stopPropagation()" class="term-check w-5 h-5 rounded border border-gray-300 dark:border-gray-500 flex items-center justify-center bg-gray-50 dark:bg-gray-600 transition-colors">
                                <i data-lucide="check" class="w-3 h-3 text-white"></i>
                            </div>
                            <span class="text-xs text-gray-600 dark:text-gray-300">[필수] 서비스 이용약관</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 ml-auto"></i>
                        </div>
                        <div onclick="openTermModal(1)" class="flex items-center gap-3 cursor-pointer">
                            <div id="check1" onclick="toggleTerm(1); event.stopPropagation()" class="term-check w-5 h-5 rounded border border-gray-300 dark:border-gray-500 flex items-center justify-center bg-gray-50 dark:bg-gray-600 transition-colors">
                                <i data-lucide="check" class="w-3 h-3 text-white"></i>
                            </div>
                            <span class="text-xs text-gray-600 dark:text-gray-300">[필수] 개인정보 수집 및 이용</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 ml-auto"></i>
                        </div>
                        <div onclick="openTermModal(2)" class="flex items-center gap-3 cursor-pointer">
                            <div id="check2" onclick="toggleTerm(2); event.stopPropagation()" class="term-check w-5 h-5 rounded border border-gray-300 dark:border-gray-500 flex items-center justify-center bg-gray-50 dark:bg-gray-600 transition-colors">
                                <i data-lucide="check" class="w-3 h-3 text-white"></i>
                            </div>
                            <span class="text-xs text-gray-600 dark:text-gray-300">[필수] 제3자 정보 제공 동의</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 dark:text-gray-500 ml-auto"></i>
                        </div>
                    </div>
                </div>
            </div>
            </form>
        </div>

    </main>

    <!-- Bottom Fixed Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 max-w-md mx-auto z-40 transition-colors duration-300">
        <button id="nextBtn" type="button" onclick="goToStep2()" disabled class="w-full bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold text-sm py-3 rounded-xl shadow-none transition-all flex justify-center items-center gap-2 cursor-not-allowed">
            <span>다음</span>
        </button>
        <button id="analyzeBtn" type="button" onclick="startAnalysis()" disabled class="hidden w-full bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold text-sm py-3 rounded-xl shadow-none transition-all flex justify-center items-center gap-2 cursor-not-allowed">
            <span>약관에 동의해주세요</span>
        </button>
    </div>

    <!-- Analysis Loading Overlay -->
    <div id="analysisLoading" class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-card shadow-2xl flex flex-col items-center text-center max-w-xs w-full mx-6 animate-slide-up">
            <div class="relative w-16 h-16 mb-6">
                <div class="absolute inset-0 border-4 border-gray-100 dark:border-gray-700 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-black dark:border-white rounded-full border-t-transparent animate-spin"></div>
                <i data-lucide="sparkles" class="absolute inset-0 m-auto w-6 h-6 text-black dark:text-white animate-pulse"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">AI 분석 시작</h3>
            <p class="text-gray-500 dark:text-gray-400 text-sm">고객님의 금융 데이터를 바탕으로<br>최적의 상품을 비교 분석합니다.</p>
        </div>
    </div>

    <!-- Account Selection Modal -->
    <div id="accountModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeAccountModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up max-h-[70vh] flex flex-col">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6 flex-shrink-0"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex-shrink-0">입금 받을 계좌를 선택해주세요</h3>
            <div id="accountListContainer" class="flex-1 overflow-y-auto space-y-3 pb-6">
                <!-- Accounts will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Employment Type Modal -->
    <div id="employmentModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeEmploymentModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up max-h-[70vh] flex flex-col">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6 flex-shrink-0"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex-shrink-0">고용 형태를 선택해주세요</h3>
            <div class="flex-1 overflow-y-auto space-y-3 pb-6">
                <div onclick="selectEmploymentType('regular', '직장인')" class="p-4 rounded-card border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex items-center justify-between group">
                    <span class="font-bold text-gray-900 dark:text-white">직장인</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
                <div onclick="selectEmploymentType('business_owner', '사업자')" class="p-4 rounded-card border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex items-center justify-between group">
                    <span class="font-bold text-gray-900 dark:text-white">사업자</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
                <div onclick="selectEmploymentType('freelancer', '프리랜서')" class="p-4 rounded-card border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex items-center justify-between group">
                    <span class="font-bold text-gray-900 dark:text-white">프리랜서</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
                <div onclick="selectEmploymentType('unemployed', '기타')" class="p-4 rounded-card border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex items-center justify-between group">
                    <span class="font-bold text-gray-900 dark:text-white">기타</span>
                    <i data-lucide="check" class="w-5 h-5 text-black dark:text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Term Detail Modal -->
    <div id="termModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeTermModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up h-[80vh] flex flex-col">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6 flex-shrink-0"></div>
            <h3 id="termTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex-shrink-0">약관 제목</h3>
            <div id="termContent" class="flex-1 overflow-y-auto text-sm text-gray-600 dark:text-gray-300 leading-relaxed mb-4 pr-2 whitespace-pre-line">
                약관 내용...
            </div>
            <button onclick="agreeCurrentTerm()" class="w-full bg-black text-white font-bold py-3 rounded-xl hover:bg-gray-700 transition flex-shrink-0">동의하고 닫기</button>
        </div>
    </div>

    <script>
        // 페이지 로드 시 퍼소나 데이터 자동 입력
        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);

            const personaData = localStorage.getItem('trustFinPersona');
            if (personaData) {
                const persona = JSON.parse(personaData);
                
                // 값 자동 입력
                if (persona.income) document.getElementById('income').value = Number(persona.income).toLocaleString();
                if (persona.creditScore) document.getElementById('creditScore').value = Number(persona.creditScore).toLocaleString();

                // 고용 형태 선택
                if (persona.job) {
                    selectEmploymentType(persona.job, getEmploymentLabel(persona.job));
                }
            }
            
            // 이전에 입력한 데이터가 있다면 불러오기 (수정 모드)
            const userDataStr = localStorage.getItem('trustFinUserData');
            if (userDataStr) {
                const userData = JSON.parse(userDataStr);
                if (userData.income) document.getElementById('income').value = Number(userData.income).toLocaleString();
                if (userData.creditScore) document.getElementById('creditScore').value = Number(userData.creditScore).toLocaleString();
                if (userData.employmentType) {
                    selectEmploymentType(userData.employmentType, getEmploymentLabel(userData.employmentType));
                }
                if (userData.selectedAccount && document.getElementById('accountSelect')) {
                    const acc = persona.accounts.find(a => a.accountNumber === userData.selectedAccount);
                    if (acc) {
                        document.getElementById('accountSelect').value = acc.accountNumber;
                        const displayEl = document.getElementById('selectedAccountText');
                        displayEl.innerText = `${acc.bank} (${acc.accountNumber})`;
                        displayEl.classList.remove('text-gray-400', 'dark:text-gray-500');
                        displayEl.classList.add('text-gray-900', 'dark:text-white');
                    }
                }
            }

            // 모달 드래그 기능 초기화
            initBottomSheetDrag('termModal', closeTermModal);
            initBottomSheetDrag('accountModal', closeAccountModal);
            initBottomSheetDrag('employmentModal', closeEmploymentModal);

            // 입력 필드 에러 초기화 리스너 (입력 시 빨간 테두리 제거)
            ['income', 'creditScore'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    this.classList.remove('border-[#e50914]', 'focus:border-[#e50914]', 'animate-shake');
                    this.classList.add('border-gray-200', 'dark:border-gray-700', 'focus:border-black', 'dark:focus:border-white');
                });
            });

            // 입력 필드 포커스 시 스크롤 조정 (키패드 가림 방지)
            const textInputs = document.querySelectorAll('input[type="tel"]');
            textInputs.forEach(input => {
                input.addEventListener('focus', function() {
                    // 커서 끝으로 이동 (기존 값 유지)
                    const len = this.value.length;
                    setTimeout(() => {
                        this.setSelectionRange(len, len);
                    }, 10);

                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });

            // 엔터 키 네비게이션 (다음 필드로 이동)
            document.getElementById('income').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('creditScore').focus();
                }
            });
            document.getElementById('creditScore').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur(); // 키패드 닫기
                }
            });
        });

        let termsAgreed = [false, false, false];
        let currentTermIndex = -1;

        function toggleAllTerms() {
            const allChecked = termsAgreed.every(t => t);
            const newState = !allChecked;
            termsAgreed = termsAgreed.map(() => newState);
            updateTermUI();
        }

        function toggleTerm(index) {
            termsAgreed[index] = !termsAgreed[index];
            updateTermUI();
        }

        function updateTermUI() {
            const allChecked = termsAgreed.every(t => t);
            
            // 전체 동의 체크박스
            const checkAll = document.getElementById('checkAll');
            if (allChecked) {
                checkAll.classList.remove('border-gray-300', 'dark:border-gray-500');
                checkAll.classList.add('bg-black', 'border-black', 'dark:border-gray-500');
            } else {
                checkAll.classList.add('border-gray-300', 'dark:border-gray-500');
                checkAll.classList.remove('bg-black', 'border-black', 'dark:border-gray-500');
            }

            // 개별 체크박스
            termsAgreed.forEach((checked, i) => {
                const el = document.getElementById(`check${i}`);
                if (checked) {
                    el.classList.remove('border-gray-300', 'dark:border-gray-500', 'bg-gray-50', 'dark:bg-gray-600');
                    el.classList.add('bg-black', 'border-black', 'dark:border-gray-500');
                } else {
                    el.classList.add('border-gray-300', 'dark:border-gray-500', 'bg-gray-50', 'dark:bg-gray-600');
                    el.classList.remove('bg-black', 'border-black', 'dark:border-gray-500');
                }
            });

            // 버튼 상태 업데이트
            const btn = document.getElementById('analyzeBtn');
            if (allChecked) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-black', 'text-white', 'shadow-lg', 'hover:bg-gray-700', 'active:scale-95');
                btn.innerHTML = `<span>무료로 금리 분석하기</span><i data-lucide="arrow-right" class="w-5 h-5"></i>`;
                lucide.createIcons();
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-black', 'text-white', 'shadow-lg', 'hover:bg-gray-700', 'active:scale-95');
                btn.innerHTML = `<span>약관에 동의해주세요</span>`;
            }
        }

        const termsData = [
            {
                title: "서비스 이용약관",
                content: "제1조 (목적)\n본 약관은 TrustFin(이하 '회사')이 제공하는 대출 비교 및 추천 서비스(이하 '서비스')의 이용 조건 및 절차, 회사와 회원의 권리, 의무 및 책임사항을 규정함을 목적으로 합니다.\n\n제2조 (용어의 정의)\n1. '회원'이란 본 약관에 동의하고 회사가 제공하는 서비스를 이용하는 자를 말합니다.\n2. '서비스'란 회사가 이용자의 금융 정보를 바탕으로 최적의 대출 상품을 추천해주는 서비스를 말합니다.\n\n제3조 (약관의 효력 및 변경)\n본 약관은 서비스를 이용하고자 하는 모든 회원에게 효력이 발생합니다."
            },
            {
                title: "개인정보 수집 및 이용",
                content: "1. 수집하는 개인정보 항목\n- 필수항목: 성명, 연소득, 신용점수, 고용형태, 보유 계좌 정보\n\n2. 개인정보의 수집 및 이용 목적\n- 대출 상품 추천 및 금리/한도 시뮬레이션\n- 서비스 이용에 따른 본인 확인\n\n3. 보유 및 이용 기간\n- 회원 탈퇴 시까지 또는 법령에 따른 보존 기간까지\n\n귀하는 개인정보 수집 및 이용에 거부할 권리가 있으나, 동의 거부 시 서비스 이용이 제한될 수 있습니다."
            },
            {
                title: "제3자 정보 제공 동의",
                content: "회사는 다음과 같이 개인정보를 제3자에게 제공하고 있습니다.\n\n1. 제공받는 자\n- 제휴 금융사 (우리은행, 카카오뱅크, 토스뱅크, 현대캐피탈 등)\n\n2. 제공하는 항목\n- 연소득, 신용점수, 고용형태\n\n3. 제공받는 자의 이용 목적\n- 대출 한도 및 금리 조회, 대출 심사\n\n4. 보유 및 이용 기간\n- 제공 목적 달성 시까지"
            }
        ];

        function openTermModal(index) {
            currentTermIndex = index;
            document.getElementById('termTitle').innerText = termsData[index].title;
            document.getElementById('termContent').innerText = termsData[index].content;
            
            const modal = document.getElementById('termModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
        }

        function closeTermModal() {
            const modal = document.getElementById('termModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
        }

        function agreeCurrentTerm() {
            if (currentTermIndex >= 0 && !termsAgreed[currentTermIndex]) {
                toggleTerm(currentTermIndex);
            }
            closeTermModal();
        }

        function openAccountModal() {
            const modal = document.getElementById('accountModal');
            const listContainer = document.getElementById('accountListContainer');
            const personaData = localStorage.getItem('trustFinPersona');
            const selectedValue = document.getElementById('accountSelect').value;
            
            if (personaData) {
                const persona = JSON.parse(personaData);
                if (persona.accounts && persona.accounts.length > 0) {
                    listContainer.innerHTML = persona.accounts.map((acc, index) => {
                        const isSelected = acc.accountNumber === selectedValue;
                        const borderClass = isSelected ? 'border-black dark:border-white ring-1 ring-black dark:ring-white' : 'border-gray-100 dark:border-gray-700';
                        const checkIcon = isSelected ? '<i data-lucide="check" class="w-5 h-5 text-black dark:text-white"></i>' : '';

                        return `
                        <div onclick="selectAccount('${acc.accountNumber}', '${acc.bank}')" class="p-4 rounded-card border ${borderClass} bg-gray-50 dark:bg-gray-700/30 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-white dark:bg-gray-600 flex items-center justify-center border border-gray-200 dark:border-gray-500 overflow-hidden">
                                    <img src="${getBankLogoUrl(acc.bank)}" onerror="handleImageError(this, '${acc.bank[0]}')" class="w-full h-full object-cover" alt="${acc.bank}">
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-0.5">
                                        <span class="text-xs font-bold text-gray-900 dark:text-white">${acc.bank}</span>
                                        <span class="text-[10px] text-gray-400 tracking-tight">${acc.accountNumber}</span>
                                        ${index === 0 ? '<span class="text-[8px] font-bold text-deepBlue bg-blue-50 dark:bg-blue-900/30 dark:text-blue-300 px-1.5 py-0.5 rounded">주계좌</span>' : ''}
                                    </div>
                                    <p class="font-bold text-gray-900 dark:text-white text-sm">${acc.balance ? acc.balance.toLocaleString() : 0}원</p>
                                </div>
                            </div>
                            ${checkIcon}
                        </div>
                    `}).join('');
                } else {
                    listContainer.innerHTML = '<div class="text-center text-gray-500 py-4">등록된 계좌가 없습니다.</div>';
                }
            }

            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
            
            if (window.lucide) window.lucide.createIcons();
        }

        function closeAccountModal() {
            const modal = document.getElementById('accountModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
        }

        function selectAccount(accountNumber, bankName) {
            document.getElementById('accountSelect').value = accountNumber;
            
            const displayEl = document.getElementById('selectedAccountText');
            displayEl.innerText = `${bankName} (${accountNumber})`;
            displayEl.classList.remove('text-gray-400', 'dark:text-gray-500');
            displayEl.classList.add('text-gray-900', 'dark:text-white');
            
            // 에러 스타일 초기화
            const div = document.getElementById('accountSelect').previousElementSibling;
            div.classList.remove('border-[#e50914]', 'animate-shake');
            div.classList.add('border-gray-200', 'dark:border-gray-700', 'hover:border-black', 'dark:hover:border-white');

            closeAccountModal();
        }

        function openEmploymentModal() {
            const modal = document.getElementById('employmentModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
        }

        function closeEmploymentModal() {
            const modal = document.getElementById('employmentModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
        }

        function selectEmploymentType(value, text) {
            document.getElementById('employmentType').value = value;
            document.getElementById('selectedEmploymentText').innerText = text;
            closeEmploymentModal();
        }

        function getEmploymentLabel(value) {
            const map = { 'regular': '직장인', 'business_owner': '사업자', 'freelancer': '프리랜서', 'unemployed': '기타' };
            return map[value] || '직장인';
        }

        let selectedPurpose = '';

        function selectPurpose(purpose, element) {
            selectedPurpose = purpose;
            
            // UI Update
            document.querySelectorAll('.survey-option').forEach(el => {
                el.classList.remove('border-black', 'dark:border-white', 'ring-1', 'ring-black', 'dark:ring-white');
                const icon = el.querySelector('svg') || el.querySelector('i');
                if (icon) icon.classList.add('opacity-0');
            });
            
            element.classList.add('border-black', 'dark:border-white', 'ring-1', 'ring-black', 'dark:ring-white');
            const targetIcon = element.querySelector('svg') || element.querySelector('i');
            if (targetIcon) targetIcon.classList.remove('opacity-0');

            // Enable Next Button
            const btn = document.getElementById('nextBtn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'dark:bg-gray-700', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed', 'shadow-none');
            btn.classList.add('bg-black', 'text-white', 'shadow-lg', 'hover:bg-gray-700', 'active:scale-95');
        }

        function goToStep2() {
            // Save purpose
            const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');
            userData.loanPurpose = selectedPurpose;
            localStorage.setItem('trustFinUserData', JSON.stringify(userData));

            // Update Progress Bar
            document.getElementById('progressBar').style.width = '100%';

            // Transition
            document.getElementById('step1-section').classList.add('hidden');
            const step2 = document.getElementById('step2-section');
            step2.classList.remove('hidden');
            step2.classList.add('animate-slide-in-right');

            // Button Swap
            document.getElementById('nextBtn').classList.add('hidden');
            document.getElementById('analyzeBtn').classList.remove('hidden');
            
            lucide.createIcons();
        }

        function toggleEditTooltip(event) {
            if (event) event.stopPropagation();
            const tooltip = document.getElementById('editTooltip');
            tooltip.classList.toggle('hidden');
            
            if (!tooltip.classList.contains('hidden')) {
                setTimeout(() => {
                    tooltip.classList.add('hidden');
                }, 4000);
            }
        }

        function startAnalysis() {
            const incomeInput = document.getElementById('income');
            const creditScoreInput = document.getElementById('creditScore');
            const accountSelectInput = document.getElementById('accountSelect');
            const accountSelectDiv = accountSelectInput.previousElementSibling;

            const income = incomeInput.value.replace(/,/g, '');
            const creditScore = creditScoreInput.value.replace(/,/g, '');
            const employmentType = document.getElementById('employmentType').value;
            const selectedAccount = accountSelectInput.value;

            let isValid = true;

            if (!income) {
                incomeInput.classList.remove('border-gray-200', 'dark:border-gray-700', 'focus:border-black', 'dark:focus:border-white');
                incomeInput.classList.add('border-[#e50914]', 'focus:border-[#e50914]', 'animate-shake');
                isValid = false;
            }
            if (!creditScore) {
                creditScoreInput.classList.remove('border-gray-200', 'dark:border-gray-700', 'focus:border-black', 'dark:focus:border-white');
                creditScoreInput.classList.add('border-[#e50914]', 'focus:border-[#e50914]', 'animate-shake');
                isValid = false;
            }
            if (!selectedAccount) {
                accountSelectDiv.classList.remove('border-gray-200', 'dark:border-gray-700', 'hover:border-black', 'dark:hover:border-white');
                accountSelectDiv.classList.add('border-[#e50914]', 'animate-shake');
                isValid = false;
            }

            if (!isValid) {
                setTimeout(() => {
                    incomeInput.classList.remove('animate-shake');
                    creditScoreInput.classList.remove('animate-shake');
                    accountSelectDiv.classList.remove('animate-shake');
                }, 500);
                return;
            }
            
            // Show Loading
            const loadingEl = document.getElementById('analysisLoading');
            loadingEl.classList.remove('hidden');

            setTimeout(() => {
                // 페르소나 데이터에서 DSR 정보 가져오기
                const personaData = localStorage.getItem('trustFinPersona');
                let dsr = 0;
                if (personaData) {
                    dsr = JSON.parse(personaData).dsr || 0;
                }

                const existingData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');
                const userData = { ...existingData, income, creditScore, employmentType, selectedAccount, dsr };
                localStorage.setItem('trustFinUserData', JSON.stringify(userData));
                window.location.href = 'result.html';
            }, 2000);
        }
    </script>
</body>
</html>