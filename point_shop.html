<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - ν¬μΈνΈ μƒμ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="common.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
        <!-- Header -->
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md h-14 sticky top-0 z-20 shadow-sm dark:shadow-gray-900/50 transition-colors duration-300">
            <div class="max-w-md mx-auto h-full flex items-center justify-center px-4 relative">
                <button onclick="history.back()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
                </button>
                <h1 class="text-lg font-bold text-gray-900 dark:text-white">ν¬μΈνΈ μƒμ </h1>
                <div class="absolute right-4 flex items-center gap-1 bg-purple-50 dark:bg-purple-900/30 px-3 py-1.5 rounded-full">
                    <span class="text-xs font-bold text-electricPurple dark:text-purple-400" id="headerPoints">0 P</span>
                </div>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-6">
            <!-- Category Filter -->
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="filterShop('all')" id="filter-all" class="px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all whitespace-nowrap flex-shrink-0">μ „μ²΄</button>
                <button onclick="filterShop('cafe')" id="filter-cafe" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">μΉ΄ν</button>
                <button onclick="filterShop('store')" id="filter-store" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">νΈμμ </button>
                <button onclick="filterShop('food')" id="filter-food" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">μ™Έμ‹</button>
                <button onclick="filterShop('culture')" id="filter-culture" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">λ¬Έν™”</button>
            </div>

            <div class="grid grid-cols-2 gap-4" id="shopList">
                <!-- JS Rendering -->
            </div>
        </main>
    </div>

    <!-- Purchase Confirm Modal -->
    <div id="purchaseModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closePurchaseModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-3xl p-8 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-8"></div>
            
            <div class="text-center mb-8">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <div class="absolute inset-0 bg-purple-100 dark:bg-purple-900/30 rounded-full blur-xl opacity-70"></div>
                    <div id="modalIcon" class="relative w-full h-full bg-white dark:bg-gray-700 rounded-3xl flex items-center justify-center text-5xl shadow-lg border border-gray-100 dark:border-gray-600">π</div>
                </div>
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 dark:text-white mb-2">μƒν’λ…</h3>
                <div class="inline-flex items-center gap-1 bg-purple-50 dark:bg-purple-900/30 px-3 py-1 rounded-full">
                    <span class="text-electricPurple dark:text-purple-400 font-bold text-lg"><span id="modalPrice">0</span> P</span>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700/30 rounded-2xl p-5 mb-8 space-y-3 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500 dark:text-gray-400">μ ν¨κΈ°κ°„</span>
                    <span id="modalValidity" class="text-sm font-bold text-gray-900 dark:text-white">-</span>
                </div>
                <div class="w-full h-px bg-gray-200 dark:bg-gray-600/50"></div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500 dark:text-gray-400">μ‚¬μ©μ²</span>
                    <span id="modalUsage" class="text-sm font-bold text-gray-900 dark:text-white">-</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closePurchaseModal()" class="flex-1 py-4 rounded-2xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">μ·¨μ†</button>
                <button onclick="confirmPurchase()" class="flex-1 py-4 rounded-2xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold hover:bg-black dark:hover:bg-gray-200 transition shadow-lg shadow-gray-200 dark:shadow-none">κµ¬λ§¤ν•κΈ°</button>
            </div>
        </div>
    </div>

    <!-- Low Point Modal -->
    <div id="lowPointModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeLowPointModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-3xl p-8 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-8"></div>
            
            <div class="text-center mb-8">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <div class="absolute inset-0 bg-red-100 dark:bg-red-900/30 rounded-full blur-xl opacity-70"></div>
                    <div class="relative w-full h-full bg-white dark:bg-gray-700 rounded-3xl flex items-center justify-center text-red-500 dark:text-red-400 shadow-lg border border-gray-100 dark:border-gray-600">
                        <i data-lucide="alert-circle" class="w-10 h-10"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ν¬μΈνΈκ°€ λ¶€μ΅±ν•΄μ”</h3>
                <p class="text-gray-500 dark:text-gray-400">μƒν’μ„ κµ¬λ§¤ν•λ ¤λ©΄ ν¬μΈνΈ μ¶©μ „μ΄ ν•„μ”ν•©λ‹λ‹¤.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeLowPointModal()" class="flex-1 py-4 rounded-2xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">μ·¨μ†</button>
                <button onclick="goToCharge()" class="flex-1 py-4 rounded-2xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold hover:bg-black dark:hover:bg-gray-200 transition shadow-lg shadow-gray-200 dark:shadow-none">μ¶©μ „ν•λ¬ κ°€κΈ°</button>
            </div>
        </div>
    </div>

    <script>
        const products = [
            { id: 'p1', name: 'μ¤νƒ€λ²…μ¤ μ•„λ©”λ¦¬μΉ΄λ…Έ', price: 4500, icon: 'β•οΈ', desc: 'Tall Size', category: 'cafe', validity: '93μΌ', usage: 'μ „κµ­ μ¤νƒ€λ²…μ¤ λ§¤μ¥' },
            { id: 'p2', name: 'GS25 3μ²μ›κ¶', price: 3000, icon: 'π', desc: 'λ¨λ°”μΌ μƒν’κ¶', category: 'store', validity: '365μΌ', usage: 'GS25 μ „ λ§¤μ¥' },
            { id: 'p3', name: 'λ°°μ¤ν‚¨λΌλΉμ¤ νμΈνΈ', price: 9800, icon: 'π¦', desc: '3κ°€μ§€ λ§›', category: 'food', validity: '93μΌ', usage: 'λ°°μ¤ν‚¨λΌλΉμ¤' },
            { id: 'p4', name: 'CGV μν™”κ΄€λκ¶', price: 13000, icon: 'π¬', desc: '2D μΌλ°', category: 'culture', validity: '6κ°μ›”', usage: 'CGV μ „ μ§€μ ' },
            { id: 'p5', name: 'CU 5μ²μ›κ¶', price: 5000, icon: 'π', desc: 'λ¨λ°”μΌ μƒν’κ¶', category: 'store', validity: '365μΌ', usage: 'CU μ „ λ§¤μ¥' },
            { id: 'p6', name: 'κµμ΄μΉν‚¨ ν—λ‹μ½¤λ³΄', price: 23000, icon: 'π—', desc: 'μ›¨μ§€κ°μ μ„ΈνΈ', category: 'food', validity: '93μΌ', usage: 'κµμ΄μΉν‚¨ (μΌλ¶€ λ§¤μ¥ μ μ™Έ)' }
        ];

        let selectedProduct = null;
        let currentCategory = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);
            renderShop();
            initBottomSheetDrag('purchaseModal', closePurchaseModal);
            initBottomSheetDrag('lowPointModal', closeLowPointModal);
        });

        function filterShop(category) {
            currentCategory = category;
            
            const buttons = ['all', 'cafe', 'store', 'food', 'culture'];
            buttons.forEach(btn => {
                const el = document.getElementById(`filter-${btn}`);
                if (btn === category) {
                    el.className = 'px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all whitespace-nowrap flex-shrink-0';
                } else {
                    el.className = 'px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0';
                }
            });
            renderShop();
        }

        function renderShop() {
            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            const currentPoints = persona.points || 0;

            document.getElementById('headerPoints').innerText = `${currentPoints.toLocaleString()} P`;

            const listEl = document.getElementById('shopList');
            
            let filteredProducts = products;
            if (currentCategory !== 'all') {
                filteredProducts = products.filter(p => p.category === currentCategory);
            }

            if (filteredProducts.length === 0) {
                listEl.innerHTML = `<div class="col-span-2 py-10 text-center text-gray-400 dark:text-gray-500">ν•΄λ‹Ή μΉ΄ν…κ³ λ¦¬μ μƒν’μ΄ μ—†μµλ‹λ‹¤.</div>`;
                return;
            }

            listEl.innerHTML = filteredProducts.map(p => {
                const canBuy = currentPoints >= p.price;
                const opacityClass = canBuy ? '' : 'opacity-60 grayscale';
                
                return `
                    <div onclick="${canBuy ? `openPurchaseModal('${p.id}')` : ''}" class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center text-center gap-3 cursor-pointer hover:shadow-md transition active:scale-95 ${opacityClass}">
                        <div class="w-16 h-16 bg-gray-50 dark:bg-gray-700/50 rounded-2xl flex items-center justify-center text-3xl mb-1">
                            ${p.icon}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white text-sm mb-0.5">${p.name}</h4>
                            <p class="text-xs text-gray-400 mb-2">${p.desc}</p>
                            <span class="text-sm font-bold ${canBuy ? 'text-electricPurple dark:text-purple-400' : 'text-gray-400'}">${p.price.toLocaleString()} P</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openPurchaseModal(id) {
            selectedProduct = products.find(p => p.id === id);
            if (!selectedProduct) return;

            document.getElementById('modalIcon').innerText = selectedProduct.icon;
            document.getElementById('modalTitle').innerText = selectedProduct.name;
            document.getElementById('modalPrice').innerText = selectedProduct.price.toLocaleString();
            document.getElementById('modalValidity').innerText = selectedProduct.validity || 'λ³„λ„ ν‘κΈ°';
            document.getElementById('modalUsage').innerText = selectedProduct.usage || 'μ „κµ­ λ§¤μ¥';

            const modal = document.getElementById('purchaseModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            const content = modal.querySelector('.bg-white');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
            selectedProduct = null;
        }

        function confirmPurchase() {
            if (!selectedProduct) return;

            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            
            if ((persona.points || 0) < selectedProduct.price) {
                closePurchaseModal();
                setTimeout(() => openLowPointModal(), 300);
                return;
            }

            // ν¬μΈνΈ μ°¨κ°
            persona.points -= selectedProduct.price;
            localStorage.setItem('trustFinPersona', JSON.stringify(persona));

            // λ‚΄μ—­ μ €μ¥
            const history = JSON.parse(localStorage.getItem('trustFinPointHistory') || '[]');
            const now = new Date();
            const dateStr = `${now.getMonth() + 1}.${now.getDate()}`;
            history.unshift({
                title: selectedProduct.name,
                date: dateStr,
                amount: -selectedProduct.price,
                type: 'use'
            });
            localStorage.setItem('trustFinPointHistory', JSON.stringify(history));

            // μΏ ν°ν•¨ μ €μ¥ (κ°„λ‹¨ κµ¬ν„)
            const coupons = JSON.parse(localStorage.getItem('trustFinCoupons') || '[]');
            coupons.unshift({ ...selectedProduct, date: dateStr });
            localStorage.setItem('trustFinCoupons', JSON.stringify(coupons));

            closePurchaseModal();
            renderShop();
            showGlobalToast('κµ¬λ§¤κ°€ μ™„λ£λμ—μµλ‹λ‹¤. μΏ ν°ν•¨μ—μ„ ν™•μΈν•μ„Έμ”.');
        }

        function openLowPointModal() {
            const modal = document.getElementById('lowPointModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
        }

        function closeLowPointModal() {
            const modal = document.getElementById('lowPointModal');
            const content = modal.querySelector('.bg-white');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
        }

        function goToCharge() {
            closeLowPointModal();
            setTimeout(() => {
                location.href = 'point_charge.html';
            }, 300);
        }
    </script>
</body>
</html>