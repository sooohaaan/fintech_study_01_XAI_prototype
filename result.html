<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - ë¶„ì„ ê²°ê³¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ë¡œì§ íŒŒì¼ ì—°ê²° -->
    <script src="RecommendLogic.js"></script>
    <script src="common.js"></script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans pb-24 select-none transition-colors duration-300">

    <!-- Header (Back Button Included) -->
    <header class="bg-white dark:bg-gray-800 h-16 sticky top-0 z-20 flex items-center justify-center shadow-sm dark:shadow-gray-900/50 px-4 relative transition-colors duration-300">
        <button onclick="history.back()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
        </button>
        <h1 class="text-base font-bold text-gray-900 dark:text-white">AI ë¶„ì„ ê²°ê³¼</h1>
    </header>

    <!-- Loading State (ì´ˆê¸° ë¡œë”© ì‹œë®¬ë ˆì´ì…˜ìš©) -->
    <div id="loading" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col items-center justify-center hidden transition-colors duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black dark:border-white mb-4"></div>
        <p class="text-black dark:text-white font-medium animate-pulse">ê³ ê°ë‹˜ì˜ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- Main Content -->
    <main class="max-w-md mx-auto mt-4 p-4">
        
        <!-- Summary Header -->
        <div class="mb-4">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">
                <span id="matchCount" class="text-black dark:text-white">0ê°œ</span>ì˜ ìƒí’ˆì´ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤.
            </h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">AIê°€ ìŠ¹ì¸ í™•ë¥ ê³¼ ê¸ˆë¦¬ ì í•©ì„±ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- Result List Container -->
        <div id="resultList" class="space-y-4 pb-4">
            <!-- JavaScriptë¡œ ì¹´ë“œê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
        </div>

        <!-- Feedback Section (Moved from xai_detail) -->
        <div id="feedbackSection" class="mt-6 mb-6 animate-fade-in-up" style="animation-delay: 0.5s">
            <h3 class="font-bold text-sm text-gray-900 dark:text-white flex items-center gap-2 mb-2">
                <i data-lucide="message-circle-question" class="w-4 h-4 text-deepBlue"></i>
                ì¡°ê±´ì´ ë¶ˆë§Œì¡±ìŠ¤ëŸ¬ìš°ì‹ ê°€ìš”?
            </h3>
            <div class="bg-white dark:bg-gray-800 rounded-card border border-gray-200 dark:border-gray-700 shadow-lg p-4">
                <p class="text-xs text-gray-600 dark:text-gray-300 mb-3">
                    ì¶”ì²œëœ ìƒí’ˆë“¤ì˜ ê¸ˆë¦¬ì™€ í•œë„ê°€ ì•„ì‰¬ìš°ì‹ ê°€ìš”?<br>
                    AIê°€ ê³ ê°ë‹˜ì˜ ë‹ˆì¦ˆì— ë§ì¶° ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„¤ê³„í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="handleFeedback('limit', this)" class="w-full py-2.5 px-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-xs font-bold text-gray-700 dark:text-gray-200">í•œë„ê°€ ë” í•„ìš”í•´ìš”</span>
                        <i data-lucide="trending-up" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('rate', this)" class="w-full py-2.5 px-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-xs font-bold text-gray-700 dark:text-gray-200">ê¸ˆë¦¬ê°€ ë” ë‚®ì•˜ìœ¼ë©´ í•´ìš”</span>
                        <i data-lucide="percent" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('period', this)" class="w-full py-2.5 px-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-xs font-bold text-gray-700 dark:text-gray-200">ëŒ€ì¶œ ê¸°ê°„ì„ ì—°ì¥í•˜ê³  ì‹¶ì–´ìš”</span>
                        <i data-lucide="calendar-clock" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('method', this)" class="w-full py-2.5 px-3 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-xs font-bold text-gray-700 dark:text-gray-200">ìƒí™˜ ë°©ì‹ì„ ë³€ê²½í•˜ê³  ì‹¶ì–´ìš”</span>
                        <i data-lucide="refresh-ccw" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Prescription (Action Plan) -->
        <div id="prescriptionSection" class="mb-6 hidden">
            <h3 class="font-bold text-sm text-gray-900 dark:text-white flex items-center gap-2 mb-2">
                <span class="w-5 h-5 rounded-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 flex items-center justify-center text-[10px] font-bold">!</span>
                AI Action Plan
            </h3>
            <div id="prescriptionList" class="space-y-3">
                <!-- JS Rendering -->
            </div>
        </div>

    </main>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);

            const loadingEl = document.getElementById('loading');
            const listEl = document.getElementById('resultList');

            // 1. ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œë®¬ë ˆì´ì…˜ (0.8ì´ˆ)
            loadingEl.classList.remove('hidden');
            
            setTimeout(() => {
                loadingEl.classList.add('hidden');
                renderResults();
            }, 800);

            // 2. ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜
            function renderResults() {
                // RecommendLogic.jsì˜ í•¨ìˆ˜ í˜¸ì¶œ
                const recommendations = getRecommendations();

                if (recommendations.length === 0) {
                    const matchCountEl = document.getElementById('matchCount');
                    if (matchCountEl) matchCountEl.textContent = '0ê°œ';
                    listEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-16 text-center animate-fade-in-up">
                            <div class="w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-6">
                                <i data-lucide="search-x" class="w-10 h-10 text-gray-400 dark:text-gray-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ì¶”ì²œ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ì–´ìš”</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-8 max-w-xs mx-auto">
                                ì…ë ¥í•˜ì‹  ì •ë³´ë¡œëŠ” ì í•©í•œ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ì¡°ê±´ì„ ë³€ê²½í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.
                            </p>
                            <button onclick="history.back()" class="bg-black text-white dark:bg-white dark:text-black font-bold py-3 px-8 rounded-xl hover:opacity-80 transition shadow-lg active:scale-95">
                                ì¡°ê±´ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°
                            </button>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                // ë§¤ì¹­ ê°œìˆ˜ í‘œì‹œ
                const matchCountEl = document.getElementById('matchCount');
                if (matchCountEl) matchCountEl.textContent = `${recommendations.length}ê°œ`;

                // ì¹´ë“œ ìƒì„± í•¨ìˆ˜
                const createCardHTML = (item, index) => {
                    const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');
                    const userGrade = getCreditGrade(parseInt(userData.creditScore || 0));
                    const peopleCount = Math.floor(Math.random() * 3000) + 500;
                    const aiSummary = generateOpinionSummary(userData, item);
                    
                    let rankBadge = '';
                    if (index < 3) {
                        const bgColors = [
                            'bg-black dark:bg-white text-white dark:text-black',
                            'bg-gray-700 dark:bg-gray-300 text-white dark:text-gray-900',
                            'bg-gray-500 dark:bg-gray-500 text-white dark:text-gray-100'
                        ];
                        rankBadge = `<div class="w-[calc(100%+1.5rem)] -mx-3 -mt-3 mb-3 py-1.5 text-center text-xs font-bold ${bgColors[index]} rounded-t-card">${index + 1}ìˆœìœ„ ì¶”ì²œ ìƒí’ˆ</div>`;
                    }

                    return `
                    <div class="bg-white dark:bg-gray-800 rounded-card p-3 shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition relative overflow-hidden opacity-0 animate-fade-in-up" style="animation-delay: ${index * 150}ms">
                        
                        ${rankBadge}

                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-gray-50 dark:bg-gray-700 flex items-center justify-center border border-gray-100 dark:border-gray-600 overflow-hidden">
                                    <img src="${getBankLogoUrl(item.bankName)}" onerror="handleImageError(this, '${item.bankName[0]}')" class="w-full h-full object-contain" alt="${item.bankName}">
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm text-gray-900 dark:text-white">${item.bankName}</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${item.productName}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-[10px] text-gray-400 dark:text-gray-500 mb-1">AI ë§¤ì¹­ ì ìˆ˜</span>
                                <span class="text-xl font-extrabold text-black dark:text-white">${item.matchScore}</span>
                                <span class="text-[10px] text-gray-400 dark:text-gray-500">/100</span>
                            </div>
                        </div>

                        <!-- Social Proof Badge -->
                        <div class="mb-3 flex items-center gap-1.5 text-[10px] text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1.5 rounded-lg w-fit">
                            <i data-lucide="users" class="w-3 h-3"></i>
                            ë‚˜ì™€ ê°™ì€ ${userGrade}ë“±ê¸‰ì˜ ì‚¬ëŒë“¤ ${peopleCount.toLocaleString()}ëª…ì´ ì„ íƒí•œ ìƒí’ˆì´ì—ìš”.
                        </div>

                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/30 rounded-xl p-2 mb-2">
                            <div class="text-center w-1/2 border-r border-gray-200 dark:border-gray-600">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 mb-1">ì˜ˆìƒ ê¸ˆë¦¬</p>
                                <p class="text-sm font-bold text-black dark:text-white">${item.finalRate}%</p>
                            </div>
                            <div class="text-center w-1/2">
                                <p class="text-[10px] text-gray-500 dark:text-gray-400 mb-1">ìµœëŒ€ í•œë„</p>
                                <p class="text-sm font-bold text-gray-900 dark:text-white">${(item.finalLimit / 10000).toFixed(0)}ì–µ ${item.finalLimit % 10000}ë§Œì›</p>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="flex gap-2 mb-3">
                            ${item.tags.map(tag => `<span class="text-[10px] bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded">${tag}</span>`).join('')}
                        </div>

                        <!-- AI Opinion Summary -->
                        <div class="mb-3 bg-gray-50 dark:bg-gray-700/30 rounded-lg p-2.5 flex gap-2 items-center">
                            <i data-lucide="bot" class="w-4 h-4 text-deepBlue dark:text-blue-400 flex-shrink-0"></i>
                            <p class="text-[10px] text-gray-600 dark:text-gray-300 leading-snug">
                                <span class="font-bold text-gray-900 dark:text-white">AI ì˜ê²¬:</span> ${aiSummary}
                            </p>
                        </div>

                        <!-- CTA Button: XAI Report -->
                        <button onclick="goToDetail('${item.id}')" 
                            class="w-full border border-gray-900 dark:border-white text-gray-900 dark:text-white text-sm font-bold py-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition flex justify-center items-center gap-2 group">
                            <i data-lucide="sparkles" class="w-4 h-4 group-hover:scale-110 transition"></i>
                            <span>AI ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°</span>
                        </button>
                    </div>
                    `;
                };

                // ìƒìœ„ 3ê°œì™€ ë‚˜ë¨¸ì§€ ë¶„ë¦¬
                const initialItems = recommendations.slice(0, 3);
                const remainingItems = recommendations.slice(3);

                let html = initialItems.map((item, index) => createCardHTML(item, index)).join('');

                if (remainingItems.length > 0) {
                    html += `
                        <div id="moreResults" class="hidden space-y-4">
                            ${remainingItems.map((item, index) => createCardHTML(item, index + 3)).join('')}
                        </div>
                        <button id="showMoreBtn" onclick="showMoreResults()" class="w-full py-3 mt-2 text-sm font-bold text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center justify-center gap-1">
                            <span>ë”ë³´ê¸° (${remainingItems.length}ê°œ)</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                    `;
                }

                listEl.innerHTML = html;
                
                // ì•„ì´ì½˜ ë‹¤ì‹œ ë Œë”ë§ (ë™ì  ìƒì„±ëœ ìš”ì†Œ)
                lucide.createIcons();
            }
        });

        function showMoreResults() {
            const moreResults = document.getElementById('moreResults');
            const btn = document.getElementById('showMoreBtn');
            if (moreResults) {
                moreResults.classList.remove('hidden');
            }
            if (btn) btn.remove();
        }

        // ì‹ ìš©ë“±ê¸‰ ê³„ì‚° (KCB ê¸°ì¤€ ë‹¨ìˆœí™”)
        function getCreditGrade(score) {
            if (score >= 942) return 1;
            if (score >= 891) return 2;
            if (score >= 832) return 3;
            if (score >= 768) return 4;
            if (score >= 698) return 5;
            if (score >= 630) return 6;
            if (score >= 530) return 7;
            return 8;
        }

        // AI ì¢…í•© ì˜ê²¬ ìš”ì•½ ìƒì„±
        function generateOpinionSummary(user, product) {
            const score = parseInt(user.creditScore || 0);
            
            if (score < 800 && user.employmentType === 'regular') {
                return "ì§ì—… ì•ˆì •ì„±ê³¼ ë¯¸ë˜ ì†Œë“ ì ì¬ë ¥ì´ ë†’ê²Œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            if (user.loanPurpose === 'refinance') {
                return "ê¸°ì¡´ ì±„ë¬´ í†µí•© ì‹œ ì‹ ìš©ì ìˆ˜ ìƒìŠ¹ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.";
            }
            if (user.loanPurpose === 'housing') {
                return "ìì‚° ê±´ì „ì„±ì´ ìš°ìˆ˜í•˜ì—¬ ê¸ì •ì ìœ¼ë¡œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }
            if (user.loanPurpose === 'business') {
                return "ì‚¬ì—… ìê¸ˆ ëª©ì ì´ ì¸ì •ë˜ë©° ìš°ëŒ€ ì¡°ê±´ ì ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
            }
            if (score >= 850) {
                return "ì‹ ìš©ë„ê°€ ë†’ì•„ ìš°ëŒ€ ê¸ˆë¦¬ ì ìš© ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.";
            }
            return "ì†Œë“ ëŒ€ë¹„ ìƒí™˜ ì—¬ë ¥ì´ ì¶©ë¶„í•˜ì—¬ ìŠ¹ì¸ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.";
        }

        // ìƒì„¸ í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        function goToDetail(productId) {
            // ì„ íƒí•œ ìƒí’ˆ ID ì €ì¥
            localStorage.setItem('selectedProductId', productId);
            // ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (ë‹¤ìŒ ë‹¨ê³„ íŒŒì¼)
            window.location.href = 'xai_detail.html';
        }

        function handleFeedback(intent, btn) {
            // UI Update: Button Selection State
            if (btn) {
                const buttons = btn.parentElement.querySelectorAll('button');
                buttons.forEach(b => {
                    // Reset
                    b.classList.remove('bg-black', 'text-white', 'border-black', 'dark:bg-white', 'dark:text-black');
                    b.classList.add('border-gray-200', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700');
                    
                    const span = b.querySelector('span');
                    if (span) {
                        span.classList.remove('text-white', 'dark:text-black');
                        span.classList.add('text-gray-700', 'dark:text-gray-200');
                    }
                    
                    const icon = b.querySelector('svg') || b.querySelector('i');
                    if (icon) {
                        icon.classList.remove('text-white', 'dark:text-black');
                        icon.classList.add('text-gray-400');
                    }
                });

                // Active State
                btn.classList.remove('border-gray-200', 'dark:border-gray-600', 'hover:bg-gray-50', 'dark:hover:bg-gray-700');
                btn.classList.add('bg-black', 'text-white', 'border-black', 'dark:bg-white', 'dark:text-black');
                
                const span = btn.querySelector('span');
                if (span) {
                    span.classList.remove('text-gray-700', 'dark:text-gray-200');
                    span.classList.add('text-white', 'dark:text-black');
                }
                
                const icon = btn.querySelector('svg') || btn.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-white', 'dark:text-black');
                }
            }

            const prescriptionSection = document.getElementById('prescriptionSection');
            const prescriptionList = document.getElementById('prescriptionList');
            
            // [UX ê°œì„ ] í”¼ë“œë°± ì„¹ì…˜ì„ ìˆ¨ê¸°ì§€ ì•Šê³  ìœ ì§€í•˜ì—¬ í™”ë©´ ëœì»¹ê±°ë¦¼ ë°©ì§€

            // ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const userDataStr = localStorage.getItem('trustFinUserData');
            const user = JSON.parse(userDataStr);
            
            const personaData = localStorage.getItem('trustFinPersona');
            let totalAssets = 0;
            if (personaData) {
                const persona = JSON.parse(personaData);
                if (persona.accounts) totalAssets = persona.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            }
            const userForAnalysis = { ...user, income: parseInt(user.income||0), creditScore: parseInt(user.creditScore||0), totalAssets };
            
            // ë§ì¶¤í˜• ë¯¸ì…˜ ìƒì„±
            const tailoredMission = getTailoredMission(userForAnalysis, intent);
            
            if (tailoredMission) {
                prescriptionSection.classList.remove('hidden');
                prescriptionSection.classList.add('animate-slide-up');
                
                prescriptionList.innerHTML = `
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-card border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col gap-3 opacity-0 animate-slide-in-right">
                        <div class="flex gap-3 items-start">
                            <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 flex items-center justify-center flex-shrink-0 text-xl shadow-sm">
                                ğŸ¯
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900 dark:text-white text-xs mb-1">AI ë§ì¶¤ ë¯¸ì…˜ (${intent === 'limit' ? 'í•œë„ ìƒí–¥' : (intent === 'rate' ? 'ê¸ˆë¦¬ ì¸í•˜' : (intent === 'period' ? 'ê¸°ê°„ ì—°ì¥' : (intent === 'method' ? 'ìƒí™˜ ë³€ê²½' : 'ì¶”ì²œ')))})</h4>
                                <p class="text-xs text-gray-700 dark:text-gray-300 leading-snug">${tailoredMission.text}</p>
                            </div>
                        </div>
                        <button onclick="handleAction('${tailoredMission.action}', '${tailoredMission.text.replace(/'/g, "\\'")}', '${tailoredMission.label}')" class="w-full mt-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-bold py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition flex justify-center items-center gap-2 text-xs shadow-sm">
                            <span>${tailoredMission.label}</span>
                            <i data-lucide="flag" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                if (window.lucide) window.lucide.createIcons();

                // [UX ê°œì„ ] ì²˜ë°© ì„¹ì…˜ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ ì´ë™
                setTimeout(() => {
                    prescriptionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function handleAction(actionType, missionText, missionTitle) {
            if (actionType === 'mission_challenge') {
                if (confirm('ì´ ë¯¸ì…˜ì— ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¬ì„± ì‹œ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.')) {
                    const missionId = `mission_${Date.now()}`;
                    
                    let subMissions = [
                        { id: 'sub1', text: 'ë¯¸ì…˜ ê°€ì´ë“œ í™•ì¸í•˜ê¸°', status: 'ready' },
                        { id: 'sub2', text: 'ì‹¤ì²œ í›„ ì¸ì¦í•˜ê¸°', status: 'ready' }
                    ];

                    // ë¯¸ì…˜ ì œëª©ì— ë”°ë¼ ì„¸ë¶€ ë¯¸ì…˜ ë§ì¶¤ ì„¤ì • (ê°„ì†Œí™”)
                    if (missionTitle && missionTitle.includes('í•œë„')) {
                        subMissions = [
                            { id: 'sub_l_1', text: 'ë¶€ì±„ ë¹„ìœ¨ 5% ì¤„ì´ê¸°', status: 'ready' },
                            { id: 'sub_l_2', text: 'ì‹ ìš©ì ìˆ˜ 20ì  ì˜¬ë¦¬ê¸°', status: 'ready' }
                        ];
                    } else if (missionTitle && missionTitle.includes('ê¸ˆë¦¬')) {
                        subMissions = [
                            { id: 'sub_r_1', text: 'ë§ˆì´ë°ì´í„° ìì‚° ì—°ê²°í•˜ê¸°', status: 'ready' },
                            { id: 'sub_r_2', text: 'ìš°ëŒ€ê¸ˆë¦¬ ì¡°ê±´ ë‹¬ì„±', status: 'ready' }
                        ];
                    }

                    const newMission = {
                        id: missionId,
                        title: missionTitle || 'ê¸ˆìœµ ëª©í‘œ ë„ì „',
                        desc: missionText,
                        dday: 'D-60',
                        deadline: Date.now() + (60 * 24 * 60 * 60 * 1000),
                        progress: 0,
                        color: 'purple',
                        subMissions: subMissions
                    };
                    
                    const missions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
                    if (!missions.some(m => m.desc === missionText)) {
                        missions.push(newMission);
                        localStorage.setItem('trustFinMissions', JSON.stringify(missions));
                        location.href = `mission_detail.html?id=${missionId}`;
                    } else {
                        alert('ì´ë¯¸ ë„ì „ ì¤‘ì¸ ë¯¸ì…˜ì…ë‹ˆë‹¤.');
                        const existing = missions.find(m => m.desc === missionText);
                        if (existing) location.href = `mission_detail.html?id=${existing.id}`;
                    }
                }
                return;
            }
            if (actionType === 'dsr_calc') {
                // result.htmlì—ëŠ” ê³„ì‚°ê¸° ëª¨ë‹¬ì´ ì—†ìœ¼ë¯€ë¡œ ì•Œë¦¼ë§Œ í‘œì‹œí•˜ê±°ë‚˜ ì´ë™ ì²˜ë¦¬
                alert('DSR ê³„ì‚° ê¸°ëŠ¥ì€ ìƒì„¸ ë¦¬í¬íŠ¸ í™”ë©´ì—ì„œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
        }
    </script>

    <!-- PWA Configuration -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <!-- <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
      }
    </script> -->
</body>
</html>
