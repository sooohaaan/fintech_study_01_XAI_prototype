<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - AI ìƒì„¸ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ë°ì´í„° ì°¸ì¡°ë¥¼ ìœ„í•´ ë¡œì§ íŒŒì¼ ì—°ê²° -->
    <script src="RecommendLogic.js"></script>
    <script src="common.js"></script>
    <style>
        /* Progress Bar ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ íŠ¸ëœì§€ì…˜ ì„¤ì • */
        .progress-bar {
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">

    <!-- Header -->
    <nav class="awwwards-nav">
        <div class="flex items-center gap-2 w-full max-w-md mx-auto relative justify-center">
            <button onclick="history.back()" class="absolute left-0 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-900 dark:text-white">AI ìƒì„¸ ë¦¬í¬íŠ¸</h1>
            <!-- Desktop Menu (Hidden on mobile, shown for demo) -->
            <div class="hidden md:flex absolute right-0 gap-6 text-sm font-bold text-gray-600 dark:text-gray-300">
                <a href="#" class="nav-item-link">Home</a>
                <a href="#" class="nav-item-link">Analysis</a>
            </div>
        </div>
    </nav>

    <!-- Sticky Process Flow Indicator -->
    <div class="sticky top-16 z-10 bg-gray-50/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 py-3 transition-colors duration-300 mt-16">
        <div class="max-w-md mx-auto px-6">
            <div class="flex items-center justify-between relative px-2">
                <!-- Connecting Line -->
                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-200 dark:bg-gray-700 -z-10 transform -translate-y-1/2"></div>
                
                <!-- Step 1: Diagnosis -->
                <button onclick="scrollToSection('section-diagnosis')" class="flex flex-col items-center bg-gray-50 dark:bg-gray-900 px-2 z-10 transition-transform active:scale-95">
                    <div class="w-8 h-8 rounded-full bg-deepBlue text-white flex items-center justify-center font-bold text-xs mb-1 shadow-md ring-4 ring-gray-50 dark:ring-gray-900">1</div>
                    <span class="text-[10px] font-bold text-deepBlue dark:text-blue-400">ì§„ë‹¨ (SHAP)</span>
                </button>
                
                <!-- Step 2: Explanation -->
                <button onclick="scrollToSection('section-explanation')" class="flex flex-col items-center bg-gray-50 dark:bg-gray-900 px-2 z-10 transition-transform active:scale-95">
                    <div class="w-8 h-8 rounded-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 flex items-center justify-center font-bold text-xs mb-1 shadow-md ring-4 ring-gray-50 dark:ring-gray-900">2</div>
                    <span class="text-[10px] font-bold text-gray-900 dark:text-white">ì„¤ëª… (LIME)</span>
                </button>
                
                <!-- Step 3: Prescription -->
                <button onclick="scrollToSection('prescriptionSection')" class="flex flex-col items-center bg-gray-50 dark:bg-gray-900 px-2 z-10 transition-transform active:scale-95">
                    <div class="w-8 h-8 rounded-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 flex items-center justify-center font-bold text-xs mb-1 shadow-md ring-4 ring-gray-50 dark:ring-gray-900">3</div>
                    <span class="text-[10px] font-bold text-gray-900 dark:text-white">ì²˜ë°© (Action)</span>
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto p-5">
        
        <!-- 1. Selected Product Header -->
        <div class="flex flex-col items-center mb-8">
            <div class="flex flex-col items-center gap-2 mb-1">
                <div class="w-16 h-16 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center border border-gray-100 dark:border-gray-600 overflow-hidden mb-1">
                    <img id="bankLogo" src="" onerror="handleImageError(this)" class="w-full h-full object-cover" alt="bank">
                </div>
                <h2 id="bankName" class="text-xl font-bold text-gray-900 dark:text-white">ì€í–‰ëª… ë¡œë”©ì¤‘</h2>
            </div>
            <p id="productName" class="text-gray-500 dark:text-gray-400 mb-4">ìƒí’ˆëª… ë¡œë”©ì¤‘</p>
        </div>

        <!-- 3. XAI Analysis (Progress Bars) -->
        <div id="section-explanation" class="mb-8 scroll-mt-36 reveal-on-scroll">
            <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2 mb-4">
                <i data-lucide="bar-chart-2" class="w-5 h-5 text-deepBlue"></i>
                ìƒì„¸ ë¶„ì„ ê²°ê³¼
            </h3>

            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-lg p-5 awwwards-card">
                <div id="analysisContainer" class="space-y-6">
                    <!-- Dynamic Content -->
                </div>

                <!-- Moved: Analysis Criteria Data -->
                <div id="section-diagnosis" class="mt-8 pt-6 border-t border-gray-100 dark:border-gray-700 scroll-mt-48">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-gray-900 dark:text-white text-sm flex items-center gap-2">
                            ë¶„ì„ ê¸°ì¤€ ë°ì´í„°
                        </h4>
                        <button onclick="location.href='loan_input.html'" class="text-xs text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 font-medium transition underline">ìˆ˜ì •</button>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/30 rounded-3xl border border-gray-100 dark:border-gray-600 divide-y divide-gray-200 dark:divide-gray-600">
                        <div class="flex justify-between items-center p-3 text-xs">
                            <span class="text-gray-500 dark:text-gray-400">ì—°ì†Œë“</span>
                            <span id="userIncome" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 text-xs">
                            <span class="text-gray-500 dark:text-gray-400">ì‹ ìš©ì ìˆ˜</span>
                            <span id="userCredit" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 text-xs">
                            <span class="text-gray-500 dark:text-gray-400">ê³ ìš©í˜•íƒœ</span>
                            <span id="userJob" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 text-xs">
                            <div class="flex items-center gap-1">
                                <span class="text-gray-500 dark:text-gray-400">DSR</span>
                                <button onclick="openDsrInfoModal()" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition"><i data-lucide="circle-help" class="w-3 h-3"></i></button>
                            </div>
                            <span id="userDSR" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3.2 Feedback Section (New) -->
        <div id="feedbackSection" class="mb-8 scroll-mt-36 hidden reveal-on-scroll">
            <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2 mb-4">
                <i data-lucide="message-circle-question" class="w-5 h-5 text-deepBlue"></i>
                ì¡°ê±´ì´ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì‹ ê°€ìš”?
            </h3>
            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-lg p-5 awwwards-card">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    í˜„ì¬ ì œì•ˆëœ ê¸ˆë¦¬ì™€ í•œë„ì— ëŒ€í•´ ì˜ê²¬ì„ ì•Œë ¤ì£¼ì„¸ìš”.<br>
                    AIê°€ ê³ ê°ë‹˜ì˜ ë‹ˆì¦ˆì— ë§ì¶° ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„¤ê³„í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="handleFeedback('satisfied')" class="w-full py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">ë§Œì¡±í•´ìš”, ì´ëŒ€ë¡œ ì§„í–‰í• ê²Œìš”</span>
                        <i data-lucide="thumbs-up" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('limit')" class="w-full py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">í•œë„ê°€ ë” í•„ìš”í•´ìš”</span>
                        <i data-lucide="trending-up" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('rate')" class="w-full py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">ê¸ˆë¦¬ê°€ ë” ë‚®ì•˜ìœ¼ë©´ í•´ìš”</span>
                        <i data-lucide="percent" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('period')" class="w-full py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">ëŒ€ì¶œ ê¸°ê°„ì„ ì—°ì¥í•˜ê³  ì‹¶ì–´ìš”</span>
                        <i data-lucide="calendar-clock" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                    <button onclick="handleFeedback('method')" class="w-full py-3 px-4 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-left flex items-center justify-between group transition-all">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-200">ìƒí™˜ ë°©ì‹ì„ ë³€ê²½í•˜ê³  ì‹¶ì–´ìš”</span>
                        <i data-lucide="refresh-ccw" class="w-4 h-4 text-gray-400 group-hover:text-deepBlue transition-colors"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3.5. AI Prescription (Action Plan) - Updated Section -->
        <div id="prescriptionSection" class="mb-8 hidden scroll-mt-36 reveal-on-scroll">
            <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2 mb-4">
                <span class="w-6 h-6 rounded-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 flex items-center justify-center text-xs font-bold">3</span>
                AI Action Plan
            </h3>
            <div id="prescriptionList" class="space-y-3">
                <!-- JS Rendering -->
            </div>
        </div>

        <!-- 4. Comprehensive Opinion (Card UI) -->
        <div class="mb-8 reveal-on-scroll">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-5 h-5 text-deepBlue"></i>
                    AI ì¢…í•© ì˜ê²¬
                </h3>
                <button onclick="shareResult()" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition p-1">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-lg p-5 awwwards-card">
                <p id="aiOpinion" class="text-gray-800 dark:text-gray-200 text-sm leading-relaxed">
                    ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...
                </p>
            </div>
        </div>

    </main>

    <!-- Bottom Fixed Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 max-w-md mx-auto z-40 transition-colors">
        <button onclick="showCompleteModal()" class="w-full btn-awwwards font-bold py-4 rounded-xl shadow-lg active:scale-95">
            ì´ ìƒí’ˆìœ¼ë¡œ ëŒ€ì¶œ ì‹ ì²­í•˜ê¸°
        </button>
    </div>
    </div>

    <!-- DSR Info Modal -->
    <div id="dsrInfoModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeDsrInfoModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">DSRì´ë€?</h3>
            <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-4">
                <strong>ì´ë¶€ì±„ì›ë¦¬ê¸ˆìƒí™˜ë¹„ìœ¨ (Debt Service Ratio)</strong><br><br>
                ì—°ì†Œë“ ëŒ€ë¹„ ì—°ê°„ ê°šì•„ì•¼ í•  ëŒ€ì¶œ ì›ë¦¬ê¸ˆ(ì›ê¸ˆ+ì´ì)ì˜ ë¹„ìœ¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>
                ê¸ˆìœµë‹¹êµ­ ê·œì œì— ë”°ë¼ DSR 40% ì´ˆê³¼ ì‹œ ì¶”ê°€ ëŒ€ì¶œì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-3xl text-xs space-y-2 mb-6">
                <div class="flex justify-between"><span class="text-emerald-600 dark:text-emerald-400 font-bold">40% ë¯¸ë§Œ</span><span class="text-gray-500 dark:text-gray-400">ì•ˆì •ì </span></div>
                <div class="flex justify-between"><span class="text-amber-500 dark:text-amber-400 font-bold">40% ~ 70%</span><span class="text-gray-500 dark:text-gray-400">ì£¼ì˜ (í•œë„ ì œí•œ ê°€ëŠ¥)</span></div>
                <div class="flex justify-between"><span class="text-rose-500 dark:text-rose-400 font-bold">70% ì´ìƒ</span><span class="text-gray-500 dark:text-gray-400">ìœ„í—˜ (ëŒ€ì¶œ ë¶ˆê°€ ê°€ëŠ¥ì„±)</span></div>
            </div>
            <button onclick="closeDsrInfoModal()" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">í™•ì¸</button>
        </div>
    </div>

    <!-- DSR Calculator Modal -->
    <div id="dsrCalculatorModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeDsrCalculatorModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">DSR ê³„ì‚°ê¸°</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">ì—°ì†Œë“ (ë§Œì›)</label>
                    <input type="number" id="calcIncome" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-gray-900 dark:text-white outline-none focus:border-deepBlue transition font-bold" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">ì—°ê°„ ëŒ€ì¶œ ì›ë¦¬ê¸ˆ ìƒí™˜ì•¡ (ë§Œì›)</label>
                    <input type="number" id="calcDebt" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-gray-900 dark:text-white outline-none focus:border-deepBlue transition font-bold" placeholder="ì˜ˆ: 1500">
                    <p class="text-[10px] text-gray-400 mt-1">ì£¼íƒë‹´ë³´ëŒ€ì¶œ, ì‹ ìš©ëŒ€ì¶œ, ì¹´ë“œë¡  ë“±ì˜ ì—°ê°„ ì›ê¸ˆ+ì´ì í•©ê³„</p>
                </div>
            </div>

            <!-- Result Area -->
            <div id="calcResultArea" class="hidden bg-gray-50 dark:bg-gray-800 rounded-3xl p-4 mb-6 text-center border border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ì˜ˆìƒ DSR</p>
                <h2 class="text-3xl font-bold text-deepBlue dark:text-blue-400 mb-2"><span id="calcDsrValue">0</span>%</h2>
                <p id="calcDsrStatus" class="text-sm font-bold text-gray-700 dark:text-gray-300">-</p>
            </div>

            <div class="flex gap-3">
                <button onclick="calculateDSR()" class="flex-1 bg-deepBlue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition shadow-lg active:scale-95">
                    ê³„ì‚°í•˜ê¸°
                </button>
                <button onclick="closeDsrCalculatorModal()" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl flex flex-col items-center transform transition-transform scale-95">
            <div class="w-16 h-16 bg-gray-50 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-deepBlue dark:text-blue-400">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ì‹ ì²­ ì²˜ë¦¬ ì¤‘</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center">ê¸ˆìœµì‚¬ì™€ í†µì‹ í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <!-- Complete Modal -->
    <div id="completeModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md" onclick="closeCompleteModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md text-center shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <div class="w-16 h-16 bg-gray-50 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-deepBlue dark:text-blue-400">
                <i data-lucide="check-circle" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ì‹ ì²­ ì™„ë£Œ</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">ëŒ€ì¶œ ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì‹¬ì‚¬ ê²°ê³¼ëŠ” ê³§ ì•Œë¦¼ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.</p>
            <button onclick="confirmLoan()" class="w-full bg-deepBlue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition">
                í™•ì¸
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null); // ê³µí†µ UI ì´ˆê¸°í™” (í•˜ë‹¨ íƒ­ ì„ íƒ ì•ˆí•¨)

            // 1. ë°ì´í„° ë¡œë“œ
            const userDataStr = localStorage.getItem('trustFinUserData');
            const selectedProductId = localStorage.getItem('selectedProductId');

            if (!userDataStr || !selectedProductId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                location.href = 'index.html';
                return;
            }

            const user = JSON.parse(userDataStr);
            
            // RecommendLogic.jsì˜ loanProducts ë°°ì—´ì—ì„œ ìƒí’ˆ ì°¾ê¸°
            const product = loanProducts.find(p => p.id === selectedProductId);
            if (!product) {
                alert('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                location.href = 'result.html';
                return;
            }

            // í˜ë¥´ì†Œë‚˜ ë°ì´í„°ì—ì„œ ìì‚° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const personaData = localStorage.getItem('trustFinPersona');
            let totalAssets = 0;
            if (personaData) {
                const persona = JSON.parse(personaData);
                if (persona.accounts) {
                    totalAssets = persona.accounts.reduce((sum, acc) => sum + acc.balance, 0);
                }
            }

            // [Fix] AI ë¶„ì„ ë¡œì§ ì‹¤í–‰í•˜ì—¬ counterfactuals(ì²˜ë°©/ë¯¸ì…˜) ë°ì´í„° ìƒì„±
            // ë‹¨ìˆœíˆ static ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í˜„ì¬ ìœ ì € ë°ì´í„°ë¡œ ë¶„ì„ì„ ìˆ˜í–‰í•´ì•¼ í•¨
            const userForAnalysis = {
                ...user,
                income: parseInt(user.income || 0),
                creditScore: parseInt(user.creditScore || 0),
                totalAssets: totalAssets
            };
            
            const analysis = calculateMatchScore(userForAnalysis, product);
            product.matchScore = analysis.score;
            product.contributions = analysis.contributions;
            product.counterfactuals = analysis.counterfactuals;

            // 2. UI ì—…ë°ì´íŠ¸ (ê¸°ë³¸ ì •ë³´)
            document.getElementById('bankName').innerText = product.bankName;
            document.getElementById('productName').innerText = product.productName;
            document.getElementById('bankLogo').src = getBankLogoUrl(product.bankName);
            
            // ì‚¬ìš©ì ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('userIncome').innerText = `${parseInt(user.income).toLocaleString()}ë§Œì›`;
            document.getElementById('userCredit').innerText = `${user.creditScore}ì `;
            
            const jobMap = {
                'regular': 'ì •ê·œì§', 'contract': 'ê³„ì•½ì§', 
                'business_owner': 'ê°œì¸ì‚¬ì—…ì', 'freelancer': 'í”„ë¦¬ëœì„œ', 'unemployed': 'ê¸°íƒ€'
            };
            document.getElementById('userJob').innerText = jobMap[user.employmentType] || 'ê¸°íƒ€';
            
            // DSR ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('userDSR').innerText = user.dsr ? `${user.dsr}%` : '-';

            // 3. XAI ë¶„ì„ ê²°ê³¼ ë Œë”ë§ (contributions ê¸°ë°˜)
            const analysisContainer = document.getElementById('analysisContainer');
            analysisContainer.innerHTML = ''; // ì´ˆê¸°í™”
            
            // ì´ì  í‘œì‹œ (ë°°ì§€ ì œê±°, ì°¨íŠ¸ ì˜ì—­ ì¶”ê°€)
            const totalScoreHtml = `
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <span class="text-sm font-bold text-gray-500 dark:text-gray-400">AI ë§¤ì¹­ ì ìˆ˜</span>
                        <h2 class="text-3xl font-extrabold text-deepBlue dark:text-blue-400 mt-1"><span id="detailMatchScore">0</span><span class="text-lg text-gray-400 dark:text-gray-500 ml-1">/100</span></h2>
                    </div>
                </div>
                <!-- Score Stacked Bar Chart -->
                <div class="mb-6 pt-2 pb-4 border-b border-gray-100 dark:border-gray-700">
                    <div class="w-full h-6 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden flex shadow-inner" id="scoreBarContainer">
                        <!-- Segments injected here -->
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1 px-1 font-medium">
                        <span>0</span>
                        <span>100</span>
                    </div>
                </div>
            `;
            analysisContainer.insertAdjacentHTML('beforeend', totalScoreHtml);
            
            // ì ìˆ˜ ì¹´ìš´íŠ¸ì—… ì• ë‹ˆë©”ì´ì…˜
            const detailScoreEl = document.getElementById('detailMatchScore');
            if (detailScoreEl) {
                let current = 0;
                const target = product.matchScore;
                const interval = setInterval(() => {
                    if (current >= target) {
                        current = target;
                        clearInterval(interval);
                    } else {
                        current += 1;
                    }
                    detailScoreEl.innerText = current;
                }, 15);
            }

            // ìƒ‰ìƒ ë§¤í•‘
            const factorColors = {
                'ê¸°ë³¸ ì ìˆ˜': '#E5E5E5',
                'ì‹ ìš©ì ìˆ˜': '#3B82F6', // Blue
                'ì†Œë“': '#10B981', // Emerald
                'ìì‚°': '#059669', // Emerald Dark
                'ì§ì—…': '#8B5CF6', // Violet
                'AI ë¶„ì„': '#D946EF', // Fuchsia
                'ëŒ€ì¶œëª©ì ': '#F59E0B', // Amber
                'DSR': '#EF4444', // Rose
                'ê·œì œ ë¯¸ì ìš©': '#06B6D4' // Cyan
            };

            // ê¸°ë³¸ ì ìˆ˜ í•­ëª© ì¶”ê°€
            const baseItemHtml = `
                <div class="flex justify-between items-center py-3 border-b border-gray-50 dark:border-gray-700/50 last:border-0">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${factorColors['ê¸°ë³¸ ì ìˆ˜']}"></div>
                        <div>
                            <p class="text-sm font-bold text-gray-900 dark:text-white mb-0.5">ê¸°ë³¸ ì ìˆ˜</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">ëª¨ë“  ì‚¬ìš©ìì˜ ì‹œì‘ ì ìˆ˜</p>
                        </div>
                    </div>
                    <span class="font-bold text-gray-500 dark:text-gray-400 text-base">70ì </span>
                </div>
            `;
            analysisContainer.insertAdjacentHTML('beforeend', baseItemHtml);

            if (!product.contributions || product.contributions.length === 0) {
                 analysisContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">íŠ¹ë³„í•œ ê°€ì‚°/ê°ì  ìš”ì¸ì´ ì—†ì–´<br>ê¸°ë³¸ ì ìˆ˜ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                 `;
            } else {
                product.contributions.forEach((item, index) => {
                    const isPositive = item.value > 0;
                    const colorClass = isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400';
                    const sign = item.value > 0 ? '+' : '';
                    const dotColor = factorColors[item.factor] || '#6B7280';

                    const html = `
                        <div class="flex justify-between items-center py-3 border-b border-gray-50 dark:border-gray-700/50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${dotColor}"></div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900 dark:text-white mb-0.5">${item.factor}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${item.desc}</p>
                                </div>
                            </div>
                            <span class="font-bold ${colorClass} text-base">${sign}${item.value}ì </span>
                        </div>
                    `;
                    analysisContainer.insertAdjacentHTML('beforeend', html);
                });

                // ì°¨íŠ¸ ë Œë”ë§ í˜¸ì¶œ
                renderScoreBar(product.contributions, factorColors, product.matchScore);
            }

            // 3.5. í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ (ì²˜ë°© ë Œë”ë§ì€ í”¼ë“œë°± í›„ë¡œ ì§€ì—°)
            const feedbackSection = document.getElementById('feedbackSection');
            if (feedbackSection) {
                feedbackSection.classList.remove('hidden');
                feedbackSection.classList.add('animate-slide-up');
            }

            // 4. ì¢…í•© ì˜ê²¬ ìƒì„± (Dynamic Text Generation)
            const opinionText = generateOpinion(user, product);
            typeWriterEffect('aiOpinion', opinionText, 30);

            // ëª¨ë‹¬ ë“œë˜ê·¸ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initBottomSheetDrag('completeModal', closeCompleteModal);
            initBottomSheetDrag('dsrInfoModal', closeDsrInfoModal);
            initBottomSheetDrag('dsrCalculatorModal', closeDsrCalculatorModal);
        });

        function handleFeedback(intent) {
            const prescriptionSection = document.getElementById('prescriptionSection');
            const prescriptionList = document.getElementById('prescriptionList');
            const feedbackSection = document.getElementById('feedbackSection');
            
            // í”¼ë“œë°± ì„¹ì…˜ ìˆ¨ê¹€
            feedbackSection.classList.add('hidden');

            // ë°ì´í„° ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  ìƒíƒœ ë°˜ì˜)
            const userDataStr = localStorage.getItem('trustFinUserData');
            const user = JSON.parse(userDataStr);
            const selectedProductId = localStorage.getItem('selectedProductId');
            const product = loanProducts.find(p => p.id === selectedProductId);
            
            const personaData = localStorage.getItem('trustFinPersona');
            let totalAssets = 0;
            if (personaData) {
                const persona = JSON.parse(personaData);
                if (persona.accounts) totalAssets = persona.accounts.reduce((sum, acc) => sum + acc.balance, 0);
            }
            const userForAnalysis = { ...user, income: parseInt(user.income||0), creditScore: parseInt(user.creditScore||0), totalAssets };
            
            // ê¸°ë³¸ ë¶„ì„ ê²°ê³¼
            const analysis = calculateMatchScore(userForAnalysis, product);
            let counterfactuals = analysis.counterfactuals;

            if (intent !== 'satisfied') {
                // ë§ì¶¤í˜• ë¯¸ì…˜ ìƒì„± (RecommendLogic.js í•¨ìˆ˜ í˜¸ì¶œ)
                const tailoredMission = getTailoredMission(userForAnalysis, intent);
                if (tailoredMission) {
                    // ê¸°ì¡´ ë¯¸ì…˜ íƒ€ì… ì œê±°í•˜ê³  ìƒˆ ë¯¸ì…˜ ì¶”ê°€
                    counterfactuals = counterfactuals.filter(c => c.type !== 'mission');
                    counterfactuals.unshift(tailoredMission);
                }
            }

            // ë Œë”ë§
            if (counterfactuals && counterfactuals.length > 0) {
                prescriptionSection.classList.remove('hidden');
                prescriptionSection.classList.add('animate-slide-up');
                
                prescriptionList.innerHTML = counterfactuals.map((item, index) => `
                    ${item.type === 'mission' ? `
                        <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col gap-3 opacity-0 animate-slide-in-right" style="animation-delay: ${100 + (index * 200)}ms">
                            <div class="flex gap-3 items-start">
                                <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 flex items-center justify-center flex-shrink-0 text-xl shadow-sm">
                                    ğŸ¯
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 dark:text-white text-sm mb-1">AI ë§ì¶¤ ë¯¸ì…˜ (${intent === 'limit' ? 'í•œë„ ìƒí–¥' : (intent === 'rate' ? 'ê¸ˆë¦¬ ì¸í•˜' : (intent === 'period' ? 'ê¸°ê°„ ì—°ì¥' : (intent === 'method' ? 'ìƒí™˜ ë³€ê²½' : 'ì¶”ì²œ')))})</h4>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-snug">${item.text}</p>
                                </div>
                            </div>
                            <button onclick="handleAction('${item.action}', '${item.text.replace(/'/g, "\\'")}', '${item.label}')" class="w-full mt-1 bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-bold py-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition flex justify-center items-center gap-2 text-sm shadow-sm">
                                <span>${item.label}</span>
                                <i data-lucide="flag" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` : `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col gap-3 opacity-0 animate-slide-in-right" style="animation-delay: ${100 + (index * 200)}ms">
                            <div class="flex gap-3 items-start">
                                <div class="w-8 h-8 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center flex-shrink-0 text-gray-900 dark:text-white">
                                    <i data-lucide="check-square" class="w-4 h-4"></i>
                                </div>
                                <p class="text-sm text-gray-700 dark:text-gray-300 leading-snug pt-1">${item.text}</p>
                            </div>
                            <button onclick="handleAction('${item.action}')" class="ml-11 text-xs font-bold text-white bg-gray-900 dark:bg-gray-700 hover:bg-gray-700 dark:hover:bg-gray-600 py-2 px-4 rounded-lg transition flex items-center gap-2 w-fit">
                                <span>${item.label}</span>
                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `}
                `).join('');
                
                if (window.lucide) window.lucide.createIcons();
            }
        }

        // ì¢…í•© ì˜ê²¬ í…ìŠ¤íŠ¸ ìƒì„±ê¸°
        function generateOpinion(user, product) {
            let text = "";
            
            // Persona 1 (ì‚¬íšŒì´ˆë…„ìƒ) íƒ€ê²ŸíŒ… ë©”ì‹œì§€
            if (user.creditScore < 800 && user.employmentType === 'regular') {
                text += `ê³ ê°ë‹˜ì˜ ì‹ ìš©ì ìˆ˜ëŠ” <strong>${user.creditScore}ì </strong>ìœ¼ë¡œ ì¼ë°˜ì ì¸ ê¸°ì¤€ì—ì„œëŠ” ì¤‘ì‹ ìš©ì— í•´ë‹¹í•˜ì§€ë§Œ, <br>
                TrustFin AIëŠ” ê³ ê°ë‹˜ì˜ <strong>ì§ì—… ì•ˆì •ì„±</strong>ê³¼ <strong>ë¯¸ë˜ ì†Œë“ ì ì¬ë ¥</strong>ì„ ë†’ê²Œ í‰ê°€í–ˆìŠµë‹ˆë‹¤.<br><br>`;
            } else {
                text += `ê³ ê°ë‹˜ì˜ <strong>ì‹ ìš©ì ìˆ˜(${user.creditScore}ì )</strong>ëŠ” <span class="text-deepBlue dark:text-blue-400 font-bold">${product.bankName}</span>ì˜ ì‹¬ì‚¬ ê¸°ì¤€ì— ë§¤ìš° ë¶€í•©í•©ë‹ˆë‹¤.<br><br>`;
            }

            if (user.loanPurpose === 'living') {
                text += `ì‹ ì²­í•˜ì‹  <strong>ìƒí™œë¹„ ìš©ë„</strong>ëŠ” ì†Œë“ ëŒ€ë¹„ í•œë„ ë‚´ì—ì„œ ì¶©ë¶„íˆ ìŠ¹ì¸ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. íŠ¹íˆ `;
            } else if (user.loanPurpose === 'refinance') {
                text += `<strong>ëŒ€í™˜ ëŒ€ì¶œ</strong>ì„ í†µí•´ ê¸°ì¡´ ê³ ê¸ˆë¦¬ ì±„ë¬´ë¥¼ í†µí•©í•˜ë©´ ì‹ ìš©ì ìˆ˜ ìƒìŠ¹ì—ë„ ê¸ì •ì ì…ë‹ˆë‹¤. ë˜í•œ `;
            } else if (user.loanPurpose === 'housing') {
                text += `<strong>ì£¼ê±° ìê¸ˆ</strong> ëª©ì ì´ ëª…í™•í•˜ê³  ìì‚° ê±´ì „ì„±ì´ ìš°ìˆ˜í•˜ì—¬ ê¸ì •ì ìœ¼ë¡œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ `;
            } else if (user.loanPurpose === 'business') {
                text += `<strong>ì‚¬ì—… ìê¸ˆ</strong> íë¦„ ê°œì„ ì„ ìœ„í•œ ëª©ì ì´ ì¸ì •ë˜ë©°, ì‚¬ì—…ì ìš°ëŒ€ ì¡°ê±´ ì ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë˜í•œ `;
            } else {
                if (user.creditScore < 800 && user.employmentType === 'regular') {
                    // Persona 1 ê°•ì¡°
                    text += `ê¸ˆìœµ ì´ë ¥ì€ ë¶€ì¡±í•˜ì§€ë§Œ <strong>ì„±ì‹¤í•œ ìƒí™˜ ê°€ëŠ¥ì„±</strong>ì´ ë°ì´í„°ë¡œ ì…ì¦ë˜ì–´, `;
                } else if (user.creditScore >= 850) {
                    text += `íŠ¹íˆ ì‹ ìš©ë„ê°€ ë†’ì•„ <strong>ìš°ëŒ€ ê¸ˆë¦¬ ì ìš© ê°€ëŠ¥ì„±</strong>ì´ ë†’ìœ¼ë©°, `;
                } else {
                    text += `í˜„ì¬ ì†Œë“ ìˆ˜ì¤€ì„ ê³ ë ¤í–ˆì„ ë•Œ <strong>ì•ˆì •ì ì¸ ìƒí™˜ ëŠ¥ë ¥</strong>ì´ ì¸ì •ë˜ì–´, `;
                }
            }

            const boostPercent = (user.creditScore < 800 && user.employmentType === 'regular') ? "20%" : "15%";
            text += `ë‹¤ë¥¸ ìƒí’ˆ ëŒ€ë¹„ ìŠ¹ì¸ í™•ë¥ ì´ <strong>ì•½ ${boostPercent} ë” ë†’ê²Œ</strong> ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            return text;
        }

        // HTML íƒœê·¸ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©° í…ìŠ¤íŠ¸ë§Œ íƒ€ì´í•‘í•˜ëŠ” íš¨ê³¼
        function typeWriterEffect(elementId, html, speed) {
            const element = document.getElementById(elementId);
            element.innerHTML = html;
            
            // ëª¨ë“  í…ìŠ¤íŠ¸ ë…¸ë“œ ì¶”ì¶œ (ìŠ¤íƒ€ì¼ íƒœê·¸ ë“±ì€ ìœ ì§€í•˜ê³  ë‚´ìš©ë§Œ ì¡°ì‘)
            const textNodes = [];
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                textNodes.push({
                    node: node,
                    text: node.nodeValue
                });
                node.nodeValue = ''; // ë‚´ìš©ì„ ë¹„ì›€ (í™”ë©´ì—ì„œ ìˆ¨ê¹€)
            }
            
            let nodeIndex = 0;
            let charIndex = 0;
            
            function type() {
                if (nodeIndex >= textNodes.length) return;
                
                const item = textNodes[nodeIndex];
                
                if (charIndex < item.text.length) {
                    item.node.nodeValue += item.text.charAt(charIndex);
                    charIndex++;
                    setTimeout(type, speed);
                } else {
                    nodeIndex++;
                    charIndex = 0;
                    type(); // ë‹¤ìŒ ë…¸ë“œë¡œ ì¦‰ì‹œ ì´ë™
                }
            }
            
            type();
        }

        function renderScoreBar(contributions, colors, finalScore) {
            const container = document.getElementById('scoreBarContainer');
            if (!container) return;
            container.innerHTML = '';

            // 1. ì ìˆ˜ êµ¬ì„± ê³„ì‚° (Net Contribution Logic)
            // ê¸°ë³¸ ì ìˆ˜ì—ì„œ ì‹œì‘í•˜ì—¬ ê°€ì ì€ ì¶”ê°€í•˜ê³ , ê°ì ì€ ê¸°ì¡´ ì˜ì—­ì„ ì¤„ì„
            let segments = [{ factor: 'ê¸°ë³¸ ì ìˆ˜', value: 70, color: colors['ê¸°ë³¸ ì ìˆ˜'] }];
            
            contributions.forEach(item => {
                if (item.value > 0) {
                    segments.push({ factor: item.factor, value: item.value, color: colors[item.factor] || '#6B7280' });
                } else if (item.value < 0) {
                    // ê°ì  ìš”ì¸ì€ ë’¤ì—ì„œë¶€í„° ê¹ì•„ë‚˜ê°
                    let remaining = Math.abs(item.value);
                    while (remaining > 0 && segments.length > 0) {
                        const last = segments[segments.length - 1];
                        if (last.value > remaining) {
                            last.value -= remaining;
                            remaining = 0;
                        } else {
                            remaining -= last.value;
                            segments.pop();
                        }
                    }
                }
            });

            // 1.5. ìµœì¢… ì ìˆ˜ ë³´ì • (Clamping)
            // ê³„ì‚°ëœ ì„¸ê·¸ë¨¼íŠ¸ í•©ê³„ê°€ ìµœì¢… ì ìˆ˜(finalScore)ì™€ ë‹¤ë¥¼ ê²½ìš°(ìƒí•œ/í•˜í•œ ë³´ì • ì‹œ) ê·¸ë˜í”„ë¥¼ ë§ì¶¤
            let currentTotal = segments.reduce((sum, seg) => sum + seg.value, 0);
            
            if (currentTotal > finalScore) {
                // ìƒí•œì„ (99ì ) ì´ˆê³¼ ì‹œ: ë’¤ì—ì„œë¶€í„° ì˜ë¼ëƒ„
                let diff = currentTotal - finalScore;
                while (diff > 0 && segments.length > 0) {
                    const last = segments[segments.length - 1];
                    if (last.value > diff) {
                        last.value -= diff;
                        diff = 0;
                    } else {
                        diff -= last.value;
                        segments.pop();
                    }
                }
            } else if (currentTotal < finalScore) {
                // í•˜í•œì„ (10ì ) ë¯¸ë§Œ ì‹œ: ìµœì†Œ ë³´ì¥ ì˜ì—­ ì¶”ê°€
                segments.push({ factor: 'ìµœì†Œ ë³´ì¥', value: finalScore - currentTotal, color: '#E5E7EB' });
            }

            // 2. ì„¸ê·¸ë¨¼íŠ¸ ë Œë”ë§
            segments.forEach((seg, i) => {
                const el = document.createElement('div');
                el.style.width = '0%'; // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ê°’
                el.style.backgroundColor = seg.color;
                el.className = 'h-full first:rounded-l-full last:rounded-r-full relative group transition-all duration-1000 ease-out cursor-help';
                
                // íˆ´íŒ
                el.innerHTML = `
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block z-10 pointer-events-none">
                        <div class="bg-gray-900/90 dark:bg-white/90 backdrop-blur text-white dark:text-gray-900 text-[10px] font-bold px-2 py-1 rounded shadow-lg whitespace-nowrap">
                            ${seg.factor} ${seg.value}ì 
                        </div>
                        <div class="w-2 h-2 bg-gray-900/90 dark:bg-white/90 rotate-45 absolute -bottom-1 left-1/2 -translate-x-1/2"></div>
                    </div>
                `;

                container.appendChild(el);
                
                // ë„ˆë¹„ ì• ë‹ˆë©”ì´ì…˜
                setTimeout(() => {
                    el.style.width = `${seg.value}%`;
                }, 100 + (i * 150));
            });
        }

        function shareResult() {
            const bankName = document.getElementById('bankName').innerText;
            const productName = document.getElementById('productName').innerText;
            const opinionText = document.getElementById('aiOpinion').innerText;

            const shareData = {
                title: 'TrustFin AI ëŒ€ì¶œ ë¶„ì„ ë¦¬í¬íŠ¸',
                text: `[TrustFin] ${bankName} '${productName}' ë¶„ì„ ê²°ê³¼\n\n${opinionText}`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData).catch(console.error);
            } else {
                copyToClipboard(`${shareData.text}\n${shareData.url}`);
            }
        }

        function handleAction(actionType, missionText, missionTitle) {
            if (actionType === 'mission_challenge') {
                if (confirm('ì´ ë¯¸ì…˜ì— ë„ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¬ì„± ì‹œ ì•Œë¦¼ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.')) {
                    const missionId = `mission_${Date.now()}`;
                    
                    let subMissions = [
                        { id: 'sub1', text: 'ë¯¸ì…˜ ê°€ì´ë“œ í™•ì¸í•˜ê¸°', status: 'ready' },
                        { id: 'sub2', text: 'ì‹¤ì²œ í›„ ì¸ì¦í•˜ê¸°', status: 'ready' }
                    ];

                    // ë¯¸ì…˜ ì œëª©ì— ë”°ë¼ ì„¸ë¶€ ë¯¸ì…˜ ë§ì¶¤ ì„¤ì •
                    if (missionTitle && missionTitle.includes('í•œë„')) {
                        if (missionTitle.includes('ì£¼íƒ')) {
                            subMissions = [
                                { id: 'sub_hl_1', text: 'KBì‹œì„¸ ë° ê³µì‹œì§€ê°€ í™•ì¸', status: 'ready' },
                                { id: 'sub_hl_2', text: 'ì†Œë“ê¸ˆì•¡ì¦ëª…ì› ë°œê¸‰', status: 'ready' }
                            ];
                        } else if (missionTitle.includes('ì‚¬ì—…')) {
                            subMissions = [
                                { id: 'sub_bl_1', text: 'ìµœê·¼ 3ê°œì›” ë§¤ì¶œ ì¥ë¶€ ì •ë¦¬', status: 'ready' },
                                { id: 'sub_bl_2', text: 'ë¶€ê°€ì„¸ ë‚©ë¶€ ë‚´ì—­ ì¤€ë¹„', status: 'ready' }
                            ];
                        } else {
                            subMissions = [
                                { id: 'sub_l_1', text: 'ë¶€ì±„ ë¹„ìœ¨ 5% ì¤„ì´ê¸°', status: 'ready' },
                                { id: 'sub_l_2', text: 'ì‹ ìš©ì ìˆ˜ 20ì  ì˜¬ë¦¬ê¸°', status: 'ready' }
                            ];
                        }
                    } else if (missionTitle && missionTitle.includes('ê¸ˆë¦¬')) {
                        if (missionTitle.includes('ëŒ€í™˜')) {
                            subMissions = [
                                { id: 'sub_rr_1', text: 'ê¸°ì¡´ ëŒ€ì¶œ ì¤‘ë„ìƒí™˜ìˆ˜ìˆ˜ë£Œ í™•ì¸', status: 'ready' },
                                { id: 'sub_rr_2', text: '6ê°œì›”ê°„ ì—°ì²´ ì—†ì´ ìƒí™˜í•˜ê¸°', status: 'ready' }
                            ];
                        } else {
                            subMissions = [
                                { id: 'sub_r_1', text: 'ë§ˆì´ë°ì´í„° ìì‚° ì—°ê²°í•˜ê¸°', status: 'ready' },
                                { id: 'sub_r_2', text: 'ìš°ëŒ€ê¸ˆë¦¬ ì¡°ê±´(ê¸‰ì—¬ì´ì²´ ë“±) ë‹¬ì„±', status: 'ready' }
                            ];
                        }
                    } else if (missionTitle && missionTitle.includes('ê¸°ê°„')) {
                        subMissions = [
                            { id: 'sub_p_1', text: 'ì‹ ìš©ì ìˆ˜ í˜„ì¬ ìˆ˜ì¤€ ìœ ì§€', status: 'ready' },
                            { id: 'sub_p_2', text: 'ë§Œê¸° 1ê°œì›” ì „ ì—°ì¥ ì‹ ì²­', status: 'ready' }
                        ];
                    } else if (missionTitle && missionTitle.includes('ìƒí™˜')) {
                        subMissions = [
                            { id: 'sub_m_1', text: 'ì›” ê°€ìš© ì†Œë“ ê³„ì‚°í•˜ê¸°', status: 'ready' },
                            { id: 'sub_m_2', text: 'ìƒí™˜ ë°©ì‹ ë³€ê²½ ì‹ ì²­ì„œ ì‘ì„±', status: 'ready' }
                        ];
                    }

                    const newMission = {
                        id: missionId,
                        title: missionTitle || 'ê¸ˆìœµ ëª©í‘œ ë„ì „',
                        desc: missionText,
                        dday: 'D-60',
                        deadline: Date.now() + (60 * 24 * 60 * 60 * 1000), // D-day ê³„ì‚°ì„ ìœ„í•œ ë§ˆê°ì¼
                        progress: 0,
                        color: 'purple',
                        subMissions: subMissions
                    };
                    
                    const missions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
                    if (!missions.some(m => m.desc === missionText)) {
                        missions.push(newMission);
                        localStorage.setItem('trustFinMissions', JSON.stringify(missions));
                        location.href = `mission_detail.html?id=${missionId}`;
                    } else {
                        alert('ì´ë¯¸ ë„ì „ ì¤‘ì¸ ë¯¸ì…˜ì…ë‹ˆë‹¤.');
                        const existing = missions.find(m => m.desc === missionText);
                        if (existing) location.href = `mission_detail.html?id=${existing.id}`;
                    }
                }
                return;
            }
            if (actionType === 'dsr_calc') {
                openDsrCalculatorModal();
                return;
            }
            // í”„ë¡œí† íƒ€ì…ìš© ê°„ë‹¨í•œ í”¼ë“œë°±
            alert(`[${actionType}] ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” í•´ë‹¹ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” í˜ì´ì§€ë¡œ ì´ë™í•˜ê±°ë‚˜ ì‹œë®¬ë ˆì´ì…˜ íŒì—…ì„ ë„ì›ë‹ˆë‹¤.`);
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                // ìš”ì†Œê°€ ìˆ¨ê²¨ì ¸ ìˆë‹¤ë©´(ì²˜ë°© ì„¹ì…˜ ë“±) ë³´ì´ê²Œ ì²˜ë¦¬ í›„ ìŠ¤í¬ë¡¤
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    el.classList.add('animate-slide-up');
                }
                
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function openDsrInfoModal() {
            const modal = document.getElementById('dsrInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            toggleBackgroundScale(true);
        }

        function closeDsrInfoModal() {
            const modal = document.getElementById('dsrInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                toggleBackgroundScale(false);
            }, 300);
        }

        function openDsrCalculatorModal() {
            const modal = document.getElementById('dsrCalculatorModal');
            const content = modal.querySelector('.bg-white');
            
            // ê¸°ì¡´ ì…ë ¥ê°’ ì´ˆê¸°í™” ë˜ëŠ” ë¡œë“œ
            const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');
            if (userData.income) {
                document.getElementById('calcIncome').value = userData.income;
            }
            document.getElementById('calcDebt').value = '';
            document.getElementById('calcResultArea').classList.add('hidden');

            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            toggleBackgroundScale(true);
        }

        function closeDsrCalculatorModal() {
            const modal = document.getElementById('dsrCalculatorModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                toggleBackgroundScale(false);
            }, 300);
        }

        function calculateDSR() {
            const income = parseFloat(document.getElementById('calcIncome').value);
            const debt = parseFloat(document.getElementById('calcDebt').value);

            if (!income || !debt) {
                alert('ì—°ì†Œë“ê³¼ ì—°ê°„ ìƒí™˜ì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const dsr = ((debt / income) * 100).toFixed(2);
            document.getElementById('calcDsrValue').innerText = dsr;
            
            const statusEl = document.getElementById('calcDsrStatus');
            if (dsr < 40) statusEl.innerHTML = '<span class="text-emerald-600 dark:text-emerald-400">ì•ˆì •ì ì…ë‹ˆë‹¤.</span> ì¶”ê°€ ëŒ€ì¶œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            else if (dsr < 70) statusEl.innerHTML = '<span class="text-amber-500 dark:text-amber-400">ì£¼ì˜ ë‹¨ê³„ì…ë‹ˆë‹¤.</span> í•œë„ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            else statusEl.innerHTML = '<span class="text-rose-500 dark:text-rose-400">ìœ„í—˜ ë‹¨ê³„ì…ë‹ˆë‹¤.</span> ì¶”ê°€ ëŒ€ì¶œì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';

            document.getElementById('calcResultArea').classList.remove('hidden');
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function showCompleteModal() {
            // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const overlay = document.getElementById('processingOverlay');
            const content = overlay.querySelector('div');
            
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ì ê¸ˆ
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            requestAnimationFrame(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
            
            if (window.lucide) window.lucide.createIcons();

            // 2ì´ˆ í›„ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
            setTimeout(() => {
                overlay.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    
                    const modal = document.getElementById('completeModal');
                    const modalContent = modal.querySelector('.bg-white');
                    modalContent.classList.add('animate-slide-up');
                    modal.classList.remove('hidden');
                    toggleBackgroundScale(true);
                    if (window.lucide) window.lucide.createIcons();
                }, 300);
            }, 2000);
        }

        function closeCompleteModal(animate = true) {
            const modal = document.getElementById('completeModal');
            const content = modal.querySelector('.bg-white');
            
            if (animate) {
                content.classList.remove('animate-slide-up');
                content.classList.add('animate-slide-down');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    content.classList.remove('animate-slide-down');
                    document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ì ê¸ˆ í•´ì œ
                    toggleBackgroundScale(false);
                }, 300);
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ì ê¸ˆ í•´ì œ
                toggleBackgroundScale(false);
            }
        }

        function confirmLoan() {
            // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const selectedProductId = localStorage.getItem('selectedProductId');
            const product = loanProducts.find(p => p.id === selectedProductId);
            const bankName = product ? product.bankName : 'TrustFin';
            
            // ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°ì—ì„œ ì„ íƒí•œ ê³„ì¢Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');

            // ë‚´ ëŒ€ì¶œ ëª©ë¡ì— ì¶”ê°€ (ì‹ ê·œ ë¡œì§)
            const myLoans = JSON.parse(localStorage.getItem('trustFinMyLoans') || '[]');
            const persona = JSON.parse(localStorage.getItem('trustFinPersona') || '{}');
            const newLoan = {
                id: selectedProductId,
                personaId: persona.id,
                bankName: bankName,
                productName: product ? product.productName : 'ì‹ ìš©ëŒ€ì¶œ',
                status: 'pending',
                timestamp: Date.now(),
                depositAccount: userData.selectedAccount // ì…ê¸ˆ ê³„ì¢Œ ì •ë³´ ì €ì¥
            };
            myLoans.unshift(newLoan);
            localStorage.setItem('trustFinMyLoans', JSON.stringify(myLoans));

            // ì•Œë¦¼ ì¶”ê°€
            const now = new Date();
            const dateStr = `${now.getMonth() + 1}.${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const newNoti = {
                type: 'loan',
                title: 'ëŒ€ì¶œ ì‹ ì²­ ì™„ë£Œ',
                message: `${bankName} ëŒ€ì¶œ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¬ì‚¬ ê²°ê³¼ëŠ” 24ì‹œê°„ ë‚´ì— ì•ˆë‚´ë©ë‹ˆë‹¤.`,
                date: dateStr,
                productId: selectedProductId
            };
            const notifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');
            notifications.unshift(newNoti);
            localStorage.setItem('trustFinNotifications', JSON.stringify(notifications));

            location.href = 'home.html';
        }
    </script>

    <!-- PWA Configuration -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <!-- <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
      }
    </script> -->
</body>
</html>
