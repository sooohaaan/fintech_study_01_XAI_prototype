<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - AI 상세 리포트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 데이터 참조를 위해 로직 파일 연결 -->
    <script src="RecommendLogic.js"></script>
    <script src="common.js"></script>
    <style>
        /* Progress Bar 애니메이션을 위한 트랜지션 설정 */
        .progress-bar {
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-gray-50 dark:bg-gray-900">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">

    <!-- Header -->
    <nav class="awwwards-nav">
        <div class="flex items-center gap-2 w-full max-w-md mx-auto relative justify-center">
            <button onclick="history.back()" class="absolute left-0 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
            <h1 class="text-base font-bold text-gray-900 dark:text-white">AI 상세 리포트</h1>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 mt-16">
        
        <!-- 1. Selected Product Header -->
        <div class="flex flex-col items-center mb-6">
            <div class="flex flex-col items-center gap-2 mb-1">
                <div class="w-12 h-12 rounded-xl bg-gray-50 dark:bg-gray-700 flex items-center justify-center border border-gray-100 dark:border-gray-600 overflow-hidden mb-1">
                    <img id="bankLogo" src="" onerror="handleImageError(this)" class="w-full h-full object-cover" alt="bank">
                </div>
                <h2 id="bankName" class="text-lg font-bold text-gray-900 dark:text-white">은행명 로딩중</h2>
            </div>
            <p id="productName" class="text-xs text-gray-500 dark:text-gray-400 mb-2">상품명 로딩중</p>
        </div>

        <!-- 3. XAI Analysis (Progress Bars) -->
        <div id="section-explanation" class="mb-6 scroll-mt-36 reveal-on-scroll">
            <h3 class="font-bold text-sm text-gray-900 dark:text-white flex items-center gap-2 mb-2">
                <i data-lucide="bar-chart-2" class="w-4 h-4 text-deepBlue"></i>
                상세 분석 결과
            </h3>

            <div class="bg-white dark:bg-gray-800 rounded-card border border-gray-200 dark:border-gray-700 shadow-lg p-3">
                <div id="analysisContainer" class="space-y-4">
                    <!-- Dynamic Content -->
                </div>

                <!-- Moved: Analysis Criteria Data -->
                <div id="section-diagnosis" class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 scroll-mt-48">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-900 dark:text-white text-xs flex items-center gap-2">
                            분석 기준 데이터
                        </h4>
                        <button onclick="location.href='loan_input.html'" class="text-[10px] text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 font-medium transition underline">수정</button>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/30 rounded-card border border-gray-100 dark:border-gray-600 divide-y divide-gray-200 dark:divide-gray-600">
                        <div class="flex justify-between items-center p-2 text-[10px]">
                            <span class="text-gray-500 dark:text-gray-400">연소득</span>
                            <span id="userIncome" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-2 text-[10px]">
                            <span class="text-gray-500 dark:text-gray-400">신용점수</span>
                            <span id="userCredit" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-2 text-[10px]">
                            <span class="text-gray-500 dark:text-gray-400">고용형태</span>
                            <span id="userJob" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center p-2 text-[10px]">
                            <div class="flex items-center gap-1">
                                <span class="text-gray-500 dark:text-gray-400">DSR</span>
                                <button onclick="openDsrInfoModal()" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition"><i data-lucide="circle-help" class="w-3 h-3"></i></button>
                            </div>
                            <span id="userDSR" class="font-bold text-gray-900 dark:text-white">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Comprehensive Opinion (Card UI) -->
        <div class="mb-6 reveal-on-scroll">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-bold text-sm text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4 text-deepBlue"></i>
                    AI 종합 의견
                </h3>
                <button onclick="shareResult()" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition p-1">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-card border border-gray-200 dark:border-gray-700 shadow-lg p-3">
                <p id="aiOpinion" class="text-gray-800 dark:text-gray-200 text-xs leading-relaxed">
                    분석 중입니다...
                </p>
            </div>
        </div>

    </main>

    <!-- Bottom Fixed Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 max-w-md mx-auto z-40 transition-colors">
        <button onclick="showCompleteModal()" class="w-full btn-awwwards font-bold py-3 text-sm rounded-xl shadow-lg active:scale-95">
            이 상품으로 대출 신청하기
        </button>
    </div>
    </div>

    <!-- DSR Info Modal -->
    <div id="dsrInfoModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeDsrInfoModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">DSR이란?</h3>
            <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-4">
                <strong>총부채원리금상환비율 (Debt Service Ratio)</strong><br><br>
                연소득 대비 연간 갚아야 할 대출 원리금(원금+이자)의 비율을 의미합니다.<br>
                금융당국 규제에 따라 DSR 40% 초과 시 추가 대출이 제한될 수 있습니다.
            </p>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-3xl text-xs space-y-2 mb-6">
                <div class="flex justify-between"><span class="text-emerald-600 dark:text-emerald-400 font-bold">40% 미만</span><span class="text-gray-500 dark:text-gray-400">안정적</span></div>
                <div class="flex justify-between"><span class="text-amber-500 dark:text-amber-400 font-bold">40% ~ 70%</span><span class="text-gray-500 dark:text-gray-400">주의 (한도 제한 가능)</span></div>
                <div class="flex justify-between"><span class="text-rose-500 dark:text-rose-400 font-bold">70% 이상</span><span class="text-gray-500 dark:text-gray-400">위험 (대출 불가 가능성)</span></div>
            </div>
            <button onclick="closeDsrInfoModal()" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">확인</button>
        </div>
    </div>

    <!-- Factor Info Modal -->
    <div id="factorInfoModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeFactorInfoModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 id="factorModalTitle" class="text-lg font-bold text-gray-900 dark:text-white mb-4">항목 제목</h3>
            <p id="factorModalDesc" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-6">
                항목 설명
            </p>
            <button onclick="closeFactorInfoModal()" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">확인</button>
        </div>
    </div>

    <!-- DSR Calculator Modal -->
    <div id="dsrCalculatorModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeDsrCalculatorModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">DSR 계산기</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">연소득 (만원)</label>
                    <input type="number" id="calcIncome" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-gray-900 dark:text-white outline-none focus:border-deepBlue transition font-bold" placeholder="0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 mb-1">연간 대출 원리금 상환액 (만원)</label>
                    <input type="number" id="calcDebt" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl px-4 py-3 text-gray-900 dark:text-white outline-none focus:border-deepBlue transition font-bold" placeholder="예: 1500">
                    <p class="text-[10px] text-gray-400 mt-1">주택담보대출, 신용대출, 카드론 등의 연간 원금+이자 합계</p>
                </div>
            </div>

            <!-- Result Area -->
            <div id="calcResultArea" class="hidden bg-gray-50 dark:bg-gray-800 rounded-3xl p-4 mb-6 text-center border border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">예상 DSR</p>
                <h2 class="text-3xl font-bold text-deepBlue dark:text-blue-400 mb-2"><span id="calcDsrValue">0</span>%</h2>
                <p id="calcDsrStatus" class="text-sm font-bold text-gray-700 dark:text-gray-300">-</p>
            </div>

            <div class="flex gap-3">
                <button onclick="calculateDSR()" class="flex-1 bg-deepBlue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition shadow-lg active:scale-95">
                    계산하기
                </button>
                <button onclick="closeDsrCalculatorModal()" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white font-bold py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="fixed inset-0 z-50 hidden flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl flex flex-col items-center transform transition-transform scale-95">
            <div class="w-16 h-16 bg-gray-50 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-deepBlue dark:text-blue-400">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">신청 처리 중</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center">금융사와 통신하고 있습니다.<br>잠시만 기다려주세요.</p>
        </div>
    </div>

    <!-- Complete Modal -->
    <div id="completeModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md" onclick="closeCompleteModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md text-center shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <div class="w-16 h-16 bg-gray-50 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4 text-deepBlue dark:text-blue-400">
                <i data-lucide="check-circle" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">신청 완료</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">대출 신청이 성공적으로 접수되었습니다.<br>심사 결과는 곧 알림으로 전송됩니다.</p>
            <button onclick="confirmLoan()" class="w-full bg-deepBlue text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition">
                확인
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null); // 공통 UI 초기화 (하단 탭 선택 안함)

            // 1. 데이터 로드
            const userDataStr = localStorage.getItem('trustFinUserData');
            const selectedProductId = localStorage.getItem('selectedProductId');

            if (!userDataStr || !selectedProductId) {
                alert('잘못된 접근입니다.');
                location.href = 'index.html';
                return;
            }

            const user = JSON.parse(userDataStr);
            
            // RecommendLogic.js의 loanProducts 배열에서 상품 찾기
            const product = loanProducts.find(p => p.id === selectedProductId);
            if (!product) {
                alert('상품 정보를 찾을 수 없습니다.');
                location.href = 'result.html';
                return;
            }

            // 페르소나 데이터에서 자산 정보 가져오기
            const personaData = localStorage.getItem('trustFinPersona');
            let totalAssets = 0;
            if (personaData) {
                const persona = JSON.parse(personaData);
                if (persona.accounts) {
                    totalAssets = persona.accounts.reduce((sum, acc) => sum + acc.balance, 0);
                }
            }

            // [Fix] AI 분석 로직 실행하여 counterfactuals(처방/미션) 데이터 생성
            // 단순히 static 데이터를 가져오는 것이 아니라, 현재 유저 데이터로 분석을 수행해야 함
            const userForAnalysis = {
                ...user,
                income: parseInt(user.income || 0),
                creditScore: parseInt(user.creditScore || 0),
                totalAssets: totalAssets
            };
            
            const analysis = calculateMatchScore(userForAnalysis, product);
            product.matchScore = analysis.score;
            product.contributions = analysis.contributions;
            product.counterfactuals = analysis.counterfactuals;

            // 2. UI 업데이트 (기본 정보)
            document.getElementById('bankName').innerText = product.bankName;
            document.getElementById('productName').innerText = product.productName;
            document.getElementById('bankLogo').src = getBankLogoUrl(product.bankName);
            
            // 사용자 요약 정보 업데이트
            document.getElementById('userIncome').innerText = `${parseInt(user.income).toLocaleString()}만원`;
            document.getElementById('userCredit').innerText = `${user.creditScore}점`;
            
            const jobMap = {
                'regular': '정규직', 'contract': '계약직', 
                'business_owner': '개인사업자', 'freelancer': '프리랜서', 'unemployed': '기타'
            };
            document.getElementById('userJob').innerText = jobMap[user.employmentType] || '기타';
            
            // DSR 정보 업데이트
            document.getElementById('userDSR').innerText = user.dsr ? `${user.dsr}%` : '-';

            // 3. XAI 분석 결과 렌더링 (contributions 기반)
            const analysisContainer = document.getElementById('analysisContainer');
            analysisContainer.innerHTML = ''; // 초기화
            
            // 총점 표시 (배지 제거, 차트 영역 추가)
            const totalScoreHtml = `
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400">AI 매칭 점수</span>
                        <h2 class="text-xl font-extrabold text-deepBlue dark:text-blue-400 mt-1"><span id="detailMatchScore">0</span><span class="text-sm text-gray-400 dark:text-gray-500 ml-1">/100</span></h2>
                    </div>
                </div>
                <!-- Score Stacked Bar Chart -->
                <div class="mb-4 pt-1 pb-3 border-b border-gray-100 dark:border-gray-700">
                    <div class="w-full h-4 bg-gray-100 dark:bg-gray-700 rounded-full flex shadow-inner" id="scoreBarContainer">
                        <!-- Segments injected here -->
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1 px-1 font-medium">
                        <span>0</span>
                        <span>100</span>
                    </div>
                </div>
            `;
            analysisContainer.insertAdjacentHTML('beforeend', totalScoreHtml);
            
            // 점수 카운트업 애니메이션
            const detailScoreEl = document.getElementById('detailMatchScore');
            if (detailScoreEl) {
                let current = 0;
                const target = product.matchScore;
                const interval = setInterval(() => {
                    if (current >= target) {
                        current = target;
                        clearInterval(interval);
                    } else {
                        current += 1;
                    }
                    detailScoreEl.innerText = current;
                }, 15);
            }

            // 색상 매핑
            const factorColors = {
                '기본 점수': '#E5E5E5',
                '신용점수': '#3B82F6', // Blue
                '소득': '#10B981', // Emerald
                '자산': '#059669', // Emerald Dark
                '직업': '#8B5CF6', // Violet
                'AI 분석': '#D946EF', // Fuchsia
                '대출목적': '#F59E0B', // Amber
                'DSR': '#EF4444', // Rose
                '규제 미적용': '#06B6D4' // Cyan
            };

            // 기본 점수 항목 추가
            const baseItemHtml = `
                <div class="flex justify-between items-center py-2 border-b border-gray-50 dark:border-gray-700/50 last:border-0">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${factorColors['기본 점수']}"></div>
                        <div>
                            <div class="flex items-center gap-1 mb-0.5">
                                <p class="text-xs font-bold text-gray-900 dark:text-white">기본 점수</p>
                                <button onclick="openFactorInfoModal('기본 점수')" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition"><i data-lucide="circle-help" class="w-3 h-3"></i></button>
                            </div>
                            <p class="text-[10px] text-gray-500 dark:text-gray-400">모든 사용자의 시작 점수</p>
                        </div>
                    </div>
                    <span class="font-bold text-gray-500 dark:text-gray-400 text-sm">70점</span>
                </div>
            `;
            analysisContainer.insertAdjacentHTML('beforeend', baseItemHtml);

            if (!product.contributions || product.contributions.length === 0) {
                 analysisContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">특별한 가산/감점 요인이 없어<br>기본 점수가 적용되었습니다.</p>
                    </div>
                 `;
            } else {
                product.contributions.forEach((item, index) => {
                    const isPositive = item.value > 0;
                    const colorClass = isPositive ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-500 dark:text-rose-400';
                    const sign = item.value > 0 ? '+' : '';
                    const dotColor = factorColors[item.factor] || '#6B7280';

                    const html = `
                        <div class="flex justify-between items-center py-2 border-b border-gray-50 dark:border-gray-700/50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: ${dotColor}"></div>
                                <div>
                                    <div class="flex items-center gap-1 mb-0.5">
                                        <p class="text-xs font-bold text-gray-900 dark:text-white">${item.factor}</p>
                                        <button onclick="openFactorInfoModal('${item.factor}')" class="text-gray-400 hover:text-deepBlue dark:hover:text-blue-400 transition"><i data-lucide="circle-help" class="w-3 h-3"></i></button>
                                    </div>
                                    <p class="text-[10px] text-gray-500 dark:text-gray-400">${item.desc}</p>
                                </div>
                            </div>
                            <span class="font-bold ${colorClass} text-sm">${sign}${item.value}점</span>
                        </div>
                    `;
                    analysisContainer.insertAdjacentHTML('beforeend', html);
                });

                // 차트 렌더링 호출
                renderScoreBar(product.contributions, factorColors, product.matchScore);
            }
            
            // 4. 종합 의견 생성 (Dynamic Text Generation)
            const opinionText = generateOpinion(user, product);
            typeWriterEffect('aiOpinion', opinionText, 30);

            // 모달 드래그 기능 초기화
            initBottomSheetDrag('completeModal', closeCompleteModal);
            initBottomSheetDrag('dsrInfoModal', closeDsrInfoModal);
            initBottomSheetDrag('dsrCalculatorModal', closeDsrCalculatorModal);
            initBottomSheetDrag('factorInfoModal', closeFactorInfoModal);

            if (window.lucide) window.lucide.createIcons();
        });

        // 종합 의견 텍스트 생성기
        function generateOpinion(user, product) {
            let text = "";
            
            // Persona 1 (사회초년생) 타겟팅 메시지
            if (user.creditScore < 800 && user.employmentType === 'regular') {
                text += `고객님의 신용점수는 <strong>${user.creditScore}점</strong>으로 일반적인 기준에서는 중신용에 해당하지만, <br>
                TrustFin AI는 고객님의 <strong>직업 안정성</strong>과 <strong>미래 소득 잠재력</strong>을 높게 평가했습니다.<br><br>`;
            } else {
                text += `고객님의 <strong>신용점수(${user.creditScore}점)</strong>는 <span class="text-deepBlue dark:text-blue-400 font-bold">${product.bankName}</span>의 심사 기준에 매우 부합합니다.<br><br>`;
            }

            if (user.loanPurpose === 'living') {
                text += `신청하신 <strong>생활비 용도</strong>는 소득 대비 한도 내에서 충분히 승인 가능성이 높습니다. 특히 `;
            } else if (user.loanPurpose === 'refinance') {
                text += `<strong>대환 대출</strong>을 통해 기존 고금리 채무를 통합하면 신용점수 상승에도 긍정적입니다. 또한 `;
            } else if (user.loanPurpose === 'housing') {
                text += `<strong>주거 자금</strong> 목적이 명확하고 자산 건전성이 우수하여 긍정적으로 평가되었습니다. 특히 `;
            } else if (user.loanPurpose === 'business') {
                text += `<strong>사업 자금</strong> 흐름 개선을 위한 목적이 인정되며, 사업자 우대 조건 적용이 가능합니다. 또한 `;
            } else {
                if (user.creditScore < 800 && user.employmentType === 'regular') {
                    // Persona 1 강조
                    text += `금융 이력은 부족하지만 <strong>성실한 상환 가능성</strong>이 데이터로 입증되어, `;
                } else if (user.creditScore >= 850) {
                    text += `특히 신용도가 높아 <strong>우대 금리 적용 가능성</strong>이 높으며, `;
                } else {
                    text += `현재 소득 수준을 고려했을 때 <strong>안정적인 상환 능력</strong>이 인정되어, `;
                }
            }

            const boostPercent = (user.creditScore < 800 && user.employmentType === 'regular') ? "20%" : "15%";
            text += `다른 상품 대비 승인 확률이 <strong>약 ${boostPercent} 더 높게</strong> 분석되었습니다.`;
            
            return text;
        }

        // HTML 태그 구조를 유지하며 텍스트만 타이핑하는 효과
        function typeWriterEffect(elementId, html, speed) {
            const element = document.getElementById(elementId);
            element.innerHTML = html;
            
            // 모든 텍스트 노드 추출 (스타일 태그 등은 유지하고 내용만 조작)
            const textNodes = [];
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                textNodes.push({
                    node: node,
                    text: node.nodeValue
                });
                node.nodeValue = ''; // 내용을 비움 (화면에서 숨김)
            }
            
            let nodeIndex = 0;
            let charIndex = 0;
            
            function type() {
                if (nodeIndex >= textNodes.length) return;
                
                const item = textNodes[nodeIndex];
                
                if (charIndex < item.text.length) {
                    item.node.nodeValue += item.text.charAt(charIndex);
                    charIndex++;
                    setTimeout(type, speed);
                } else {
                    nodeIndex++;
                    charIndex = 0;
                    type(); // 다음 노드로 즉시 이동
                }
            }
            
            type();
        }

        function renderScoreBar(contributions, colors, finalScore) {
            const container = document.getElementById('scoreBarContainer');
            if (!container) return;
            container.innerHTML = '';

            // 1. 점수 구성 계산 (Net Contribution Logic)
            // 기본 점수에서 시작하여 가점은 추가하고, 감점은 기존 영역을 줄임
            let segments = [{ factor: '기본 점수', value: 70, color: colors['기본 점수'] }];
            
            contributions.forEach(item => {
                if (item.value > 0) {
                    segments.push({ factor: item.factor, value: item.value, color: colors[item.factor] || '#6B7280' });
                } else if (item.value < 0) {
                    // 감점 요인은 뒤에서부터 깎아나감
                    let remaining = Math.abs(item.value);
                    while (remaining > 0 && segments.length > 0) {
                        const last = segments[segments.length - 1];
                        if (last.value > remaining) {
                            last.value -= remaining;
                            remaining = 0;
                        } else {
                            remaining -= last.value;
                            segments.pop();
                        }
                    }
                }
            });

            // 1.5. 최종 점수 보정 (Clamping)
            // 계산된 세그먼트 합계가 최종 점수(finalScore)와 다를 경우(상한/하한 보정 시) 그래프를 맞춤
            let currentTotal = segments.reduce((sum, seg) => sum + seg.value, 0);
            
            if (currentTotal > finalScore) {
                // 상한선(99점) 초과 시: 뒤에서부터 잘라냄
                let diff = currentTotal - finalScore;
                while (diff > 0 && segments.length > 0) {
                    const last = segments[segments.length - 1];
                    if (last.value > diff) {
                        last.value -= diff;
                        diff = 0;
                    } else {
                        diff -= last.value;
                        segments.pop();
                    }
                }
            } else if (currentTotal < finalScore) {
                // 하한선(10점) 미만 시: 최소 보장 영역 추가
                segments.push({ factor: '최소 보장', value: finalScore - currentTotal, color: '#E5E7EB' });
            }

            // 2. 세그먼트 렌더링
            segments.forEach((seg, i) => {
                const el = document.createElement('div');
                el.style.width = '0%'; // 애니메이션 시작값
                el.style.backgroundColor = seg.color;
                el.className = 'h-full first:rounded-l-full last:rounded-r-full relative group transition-all duration-1000 ease-out cursor-help';
                
                // 툴팁
                el.innerHTML = `
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block z-20 pointer-events-none">
                        <div class="bg-gray-900/90 dark:bg-white/90 backdrop-blur text-white dark:text-gray-900 text-[10px] font-bold px-2 py-1 rounded shadow-lg whitespace-nowrap">
                            ${seg.factor} ${seg.value}점
                        </div>
                        <div class="w-2 h-2 bg-gray-900/90 dark:bg-white/90 rotate-45 absolute -bottom-1 left-1/2 -translate-x-1/2"></div>
                    </div>
                `;

                container.appendChild(el);
                
                // 너비 애니메이션
                setTimeout(() => {
                    el.style.width = `${seg.value}%`;
                }, 100 + (i * 150));
            });
        }

        function shareResult() {
            const bankName = document.getElementById('bankName').innerText;
            const productName = document.getElementById('productName').innerText;
            const opinionText = document.getElementById('aiOpinion').innerText;

            const shareData = {
                title: 'TrustFin AI 대출 분석 리포트',
                text: `[TrustFin] ${bankName} '${productName}' 분석 결과\n\n${opinionText}`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData).catch(console.error);
            } else {
                copyToClipboard(`${shareData.text}\n${shareData.url}`);
            }
        }

        function handleAction(actionType, missionText, missionTitle) {
            if (actionType === 'mission_challenge') {
                if (confirm('이 미션에 도전하시겠습니까?\n달성 시 알림을 보내드립니다.')) {
                    const missionId = `mission_${Date.now()}`;
                    
                    let subMissions = [
                        { id: 'sub1', text: '미션 가이드 확인하기', status: 'ready' },
                        { id: 'sub2', text: '실천 후 인증하기', status: 'ready' }
                    ];

                    // 미션 제목에 따라 세부 미션 맞춤 설정
                    if (missionTitle && missionTitle.includes('한도')) {
                        if (missionTitle.includes('주택')) {
                            subMissions = [
                                { id: 'sub_hl_1', text: 'KB시세 및 공시지가 확인', status: 'ready' },
                                { id: 'sub_hl_2', text: '소득금액증명원 발급', status: 'ready' }
                            ];
                        } else if (missionTitle.includes('사업')) {
                            subMissions = [
                                { id: 'sub_bl_1', text: '최근 3개월 매출 장부 정리', status: 'ready' },
                                { id: 'sub_bl_2', text: '부가세 납부 내역 준비', status: 'ready' }
                            ];
                        } else {
                            subMissions = [
                                { id: 'sub_l_1', text: '부채 비율 5% 줄이기', status: 'ready' },
                                { id: 'sub_l_2', text: '신용점수 20점 올리기', status: 'ready' }
                            ];
                        }
                    } else if (missionTitle && missionTitle.includes('금리')) {
                        if (missionTitle.includes('대환')) {
                            subMissions = [
                                { id: 'sub_rr_1', text: '기존 대출 중도상환수수료 확인', status: 'ready' },
                                { id: 'sub_rr_2', text: '6개월간 연체 없이 상환하기', status: 'ready' }
                            ];
                        } else {
                            subMissions = [
                                { id: 'sub_r_1', text: '마이데이터 자산 연결하기', status: 'ready' },
                                { id: 'sub_r_2', text: '우대금리 조건(급여이체 등) 달성', status: 'ready' }
                            ];
                        }
                    } else if (missionTitle && missionTitle.includes('기간')) {
                        subMissions = [
                            { id: 'sub_p_1', text: '신용점수 현재 수준 유지', status: 'ready' },
                            { id: 'sub_p_2', text: '만기 1개월 전 연장 신청', status: 'ready' }
                        ];
                    } else if (missionTitle && missionTitle.includes('상환')) {
                        subMissions = [
                            { id: 'sub_m_1', text: '월 가용 소득 계산하기', status: 'ready' },
                            { id: 'sub_m_2', text: '상환 방식 변경 신청서 작성', status: 'ready' }
                        ];
                    }

                    const newMission = {
                        id: missionId,
                        title: missionTitle || '금융 목표 도전',
                        desc: missionText,
                        dday: 'D-60',
                        deadline: Date.now() + (60 * 24 * 60 * 60 * 1000), // D-day 계산을 위한 마감일
                        progress: 0,
                        color: 'purple',
                        subMissions: subMissions
                    };
                    
                    const missions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
                    if (!missions.some(m => m.desc === missionText)) {
                        missions.push(newMission);
                        localStorage.setItem('trustFinMissions', JSON.stringify(missions));
                        location.href = `mission_detail.html?id=${missionId}`;
                    } else {
                        alert('이미 도전 중인 미션입니다.');
                        const existing = missions.find(m => m.desc === missionText);
                        if (existing) location.href = `mission_detail.html?id=${existing.id}`;
                    }
                }
                return;
            }
            if (actionType === 'dsr_calc') {
                openDsrCalculatorModal();
                return;
            }
            // 프로토타입용 간단한 피드백
            alert(`[${actionType}] 기능은 준비 중입니다.\n실제 서비스에서는 해당 기능을 수행하는 페이지로 이동하거나 시뮬레이션 팝업을 띄웁니다.`);
        }

        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) {
                // 요소가 숨겨져 있다면(처방 섹션 등) 보이게 처리 후 스크롤
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    el.classList.add('animate-slide-up');
                }
                
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function openDsrInfoModal() {
            const modal = document.getElementById('dsrInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            toggleBackgroundScale(true);
        }

        const factorDescriptions = {
            '기본 점수': '모든 사용자에게 공통적으로 적용되는 대출 심사 시작 점수입니다.',
            '신용점수': '개인의 신용도를 평가한 점수로, 상환 이력과 부채 수준이 주요하게 반영됩니다.',
            '소득': '대출 상환 능력을 평가하는 핵심 지표로, 연소득이 높을수록 유리합니다.',
            '자산': '보유한 자산(부동산, 예적금 등) 규모로, 경제적 안정성을 나타냅니다.',
            '직업': '고용 형태와 직군에 따른 소득 안정성을 평가합니다.',
            'AI 분석': 'TrustFin만의 AI 알고리즘이 분석한 잠재적 상환 능력과 금융 패턴입니다.',
            '대출목적': '대출금의 사용 용도에 따른 리스크와 적합성을 평가합니다.',
            'DSR': '총부채원리금상환비율로, 소득 대비 갚아야 할 원리금의 비율입니다.',
            '규제 미적용': '정부의 대출 규제(DSR 등) 적용 예외 상품 여부입니다.'
        };

        function openFactorInfoModal(factor) {
            const desc = factorDescriptions[factor] || '해당 항목에 대한 상세 설명이 없습니다.';
            document.getElementById('factorModalTitle').innerText = factor;
            document.getElementById('factorModalDesc').innerText = desc;
            
            const modal = document.getElementById('factorInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            toggleBackgroundScale(true);
        }

        function closeFactorInfoModal() {
            const modal = document.getElementById('factorInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                toggleBackgroundScale(false);
            }, 300);
        }

        function closeDsrInfoModal() {
            const modal = document.getElementById('dsrInfoModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                toggleBackgroundScale(false);
            }, 300);
        }

        function openDsrCalculatorModal() {
            const modal = document.getElementById('dsrCalculatorModal');
            const content = modal.querySelector('.bg-white');
            
            // 기존 입력값 초기화 또는 로드
            const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');
            if (userData.income) {
                document.getElementById('calcIncome').value = userData.income;
            }
            document.getElementById('calcDebt').value = '';
            document.getElementById('calcResultArea').classList.add('hidden');

            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            toggleBackgroundScale(true);
        }

        function closeDsrCalculatorModal() {
            const modal = document.getElementById('dsrCalculatorModal');
            const content = modal.querySelector('.bg-white');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                toggleBackgroundScale(false);
            }, 300);
        }

        function calculateDSR() {
            const income = parseFloat(document.getElementById('calcIncome').value);
            const debt = parseFloat(document.getElementById('calcDebt').value);

            if (!income || !debt) {
                alert('연소득과 연간 상환액을 모두 입력해주세요.');
                return;
            }

            const dsr = ((debt / income) * 100).toFixed(2);
            document.getElementById('calcDsrValue').innerText = dsr;
            
            const statusEl = document.getElementById('calcDsrStatus');
            if (dsr < 40) statusEl.innerHTML = '<span class="text-emerald-600 dark:text-emerald-400">안정적입니다.</span> 추가 대출이 가능합니다.';
            else if (dsr < 70) statusEl.innerHTML = '<span class="text-amber-500 dark:text-amber-400">주의 단계입니다.</span> 한도가 제한될 수 있습니다.';
            else statusEl.innerHTML = '<span class="text-rose-500 dark:text-rose-400">위험 단계입니다.</span> 추가 대출이 어려울 수 있습니다.';

            document.getElementById('calcResultArea').classList.remove('hidden');
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function showCompleteModal() {
            // 로딩 오버레이 표시
            const overlay = document.getElementById('processingOverlay');
            const content = overlay.querySelector('div');
            
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 스크롤 잠금
            
            // 애니메이션 시작
            requestAnimationFrame(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
            
            if (window.lucide) window.lucide.createIcons();

            // 2초 후 완료 모달 표시
            setTimeout(() => {
                overlay.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    
                    const modal = document.getElementById('completeModal');
                    const modalContent = modal.querySelector('.bg-white');
                    modalContent.classList.add('animate-slide-up');
                    modal.classList.remove('hidden');
                    toggleBackgroundScale(true);
                    if (window.lucide) window.lucide.createIcons();
                }, 300);
            }, 2000);
        }

        function closeCompleteModal(animate = true) {
            const modal = document.getElementById('completeModal');
            const content = modal.querySelector('.bg-white');
            
            if (animate) {
                content.classList.remove('animate-slide-up');
                content.classList.add('animate-slide-down');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    content.classList.remove('animate-slide-down');
                    document.body.style.overflow = ''; // 스크롤 잠금 해제
                    toggleBackgroundScale(false);
                }, 300);
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // 스크롤 잠금 해제
                toggleBackgroundScale(false);
            }
        }

        function confirmLoan() {
            // 상품 정보 가져오기
            const selectedProductId = localStorage.getItem('selectedProductId');
            const product = loanProducts.find(p => p.id === selectedProductId);
            const bankName = product ? product.bankName : 'TrustFin';
            
            // 사용자 입력 데이터에서 선택한 계좌 정보 가져오기
            const userData = JSON.parse(localStorage.getItem('trustFinUserData') || '{}');

            // 내 대출 목록에 추가 (신규 로직)
            const myLoans = JSON.parse(localStorage.getItem('trustFinMyLoans') || '[]');
            const persona = JSON.parse(localStorage.getItem('trustFinPersona') || '{}');
            const newLoan = {
                id: selectedProductId,
                personaId: persona.id,
                bankName: bankName,
                productName: product ? product.productName : '신용대출',
                status: 'pending',
                timestamp: Date.now(),
                depositAccount: userData.selectedAccount // 입금 계좌 정보 저장
            };
            myLoans.unshift(newLoan);
            localStorage.setItem('trustFinMyLoans', JSON.stringify(myLoans));

            // 알림 추가
            const now = new Date();
            const dateStr = `${now.getMonth() + 1}.${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const newNoti = {
                type: 'loan',
                title: '대출 신청 완료',
                message: `${bankName} 대출 신청이 접수되었습니다. 심사 결과는 24시간 내에 안내됩니다.`,
                date: dateStr,
                productId: selectedProductId
            };
            const notifications = JSON.parse(localStorage.getItem('trustFinNotifications') || '[]');
            notifications.unshift(newNoti);
            localStorage.setItem('trustFinNotifications', JSON.stringify(notifications));

            location.href = 'home.html';
        }
    </script>

    <!-- PWA Configuration -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <!-- <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
      }
    </script> -->
</body>
</html>
