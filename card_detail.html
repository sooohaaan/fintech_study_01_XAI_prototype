<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 카드 명세서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="common.js"></script>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 h-16 sticky top-0 z-20 flex items-center justify-center shadow-sm dark:shadow-gray-900/50 px-4 relative transition-colors duration-300">
            <button onclick="history.back()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-900 dark:text-white">카드 명세서</h1>
        </header>

        <main class="p-5 max-w-md mx-auto">
            <!-- Card Info -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-6 text-center transition-colors">
                <p id="cardName" class="text-sm text-gray-500 dark:text-gray-400 mb-1 font-bold">카드명</p>
                <p class="text-xs text-gray-400 mb-4 tracking-tight" id="cardNumber">0000</p>
                
                <div class="border-t border-gray-100 dark:border-gray-700 pt-4">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">이번 달 결제 예정 금액</p>
                    <p id="totalAmount" class="text-3xl font-bold text-gray-900 dark:text-white">0원</p>
                    <p class="text-xs text-gray-400 mt-1">결제일: 11월 25일</p>
                </div>
            </div>

            <!-- Spending Analysis Chart -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-sm border border-gray-100 dark:border-gray-700 mb-6 transition-colors">
                <h3 class="font-bold text-gray-900 dark:text-white mb-4 text-sm">이번 달 소비 패턴</h3>
                <div class="flex items-center gap-6">
                    <div id="categoryChart" onclick="toggleChartMode()" class="w-24 h-24 rounded-full relative flex-shrink-0 transition-all duration-1000 cursor-pointer active:scale-95" style="background: conic-gradient(#e5e7eb 0% 100%);">
                        <div class="absolute inset-0 m-auto w-16 h-16 bg-white dark:bg-gray-800 rounded-full flex flex-col items-center justify-center transition-colors">
                            <span id="chartCenterText" class="text-[10px] text-gray-400 text-center leading-tight">TOP 3</span>
                        </div>
                    </div>
                    <div id="chartLegend" class="flex-1 space-y-2 text-xs"></div>
                </div>
            </div>

            <!-- Transaction List -->
            <h3 class="font-bold text-gray-900 dark:text-white mb-4 px-1">상세 내역</h3>
            <div id="transactionList" class="space-y-0 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 transition-colors">
                <!-- JS Rendering -->
            </div>
        </main>
    </div>

    <script>
        let currentTotalAmount = 0;
        let isChartAmountMode = false;
        let allTransactions = [];
        let currentCategoryFilter = null;

        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);
            renderCardDetail();
        });

        function renderCardDetail() {
            const cardDataStr = localStorage.getItem('selectedCard');
            if (!cardDataStr) {
                alert('카드 정보를 찾을 수 없습니다.');
                history.back();
                return;
            }
            const cardData = JSON.parse(cardDataStr);

            document.getElementById('cardName').innerText = cardData.name;
            document.getElementById('cardNumber').innerText = cardData.number;

            // Mock Transactions
            const transactions = generateMockTransactions();
            allTransactions = transactions;
            const total = transactions.reduce((sum, tx) => sum + tx.amount, 0);
            currentTotalAmount = total;

            animateCountUp(document.getElementById('totalAmount'), total);
            renderCategoryChart(transactions, total);
            renderTransactions();
        }

        function generateMockTransactions() {
            const titles = ['스타벅스', '쿠팡', 'GS25', '배달의민족', '카카오택시', '넷플릭스', 'CGV', '올리브영'];
            const categories = ['cafe', 'shopping', 'store', 'food', 'transport', 'sub', 'culture', 'shopping'];
            const list = [];
            
            for (let i = 0; i < 15; i++) {
                const randIdx = Math.floor(Math.random() * titles.length);
                const amount = Math.floor(Math.random() * 50) * 1000 + 2000;
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                list.push({
                    date: `${date.getMonth() + 1}.${date.getDate()}`,
                    desc: titles[randIdx],
                    amount: amount,
                    category: categories[randIdx],
                    installment: Math.random() > 0.8 ? '3개월' : '일시불'
                });
            }
            return list;
        }

        function renderCategoryChart(transactions, total) {
            const categorySum = {};
            transactions.forEach(tx => {
                categorySum[tx.category] = (categorySum[tx.category] || 0) + tx.amount;
            });

            const sorted = Object.entries(categorySum)
                .map(([cat, amount]) => ({ cat, amount, ratio: (amount / total) * 100 }))
                .sort((a, b) => b.amount - a.amount);

            const colors = ['#1D4ED8', '#7C3AED', '#10B981', '#F59E0B', '#EC4899', '#6B7280'];
            let gradient = '';
            let currentDeg = 0;
            let legendHtml = '';

            const catNames = {
                'cafe': '카페/간식', 'shopping': '쇼핑', 'store': '편의점', 
                'food': '식비', 'transport': '교통', 'sub': '구독', 'culture': '문화'
            };

            sorted.forEach((item, i) => {
                const color = colors[i % colors.length];
                const deg = (item.ratio / 100) * 360;
                gradient += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `;
                currentDeg += deg;

                if (i < 4) {
                    legendHtml += `
                        <div onclick="filterByCategory('${item.cat}')" class="legend-item flex justify-between items-center cursor-pointer transition-opacity hover:opacity-80" data-category="${item.cat}">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full" style="background-color: ${color}"></div>
                                <span class="text-gray-600 dark:text-gray-300">${catNames[item.cat] || '기타'}</span>
                            </div>
                            <span class="font-bold text-gray-900 dark:text-white">${Math.round(item.ratio)}%</span>
                        </div>
                    `;
                }
            });

            gradient = gradient.slice(0, -2);
            
            const chart = document.getElementById('categoryChart');
            const legend = document.getElementById('chartLegend');
            
            setTimeout(() => {
                chart.style.background = `conic-gradient(${gradient})`;
            }, 300);
            
            legend.innerHTML = legendHtml;
        }

        function toggleChartMode() {
            isChartAmountMode = !isChartAmountMode;
            const centerText = document.getElementById('chartCenterText');
            
            if (isChartAmountMode) {
                centerText.innerHTML = `<span class="text-gray-500 dark:text-gray-400 text-[10px]">총 지출</span><br><span class="text-gray-900 dark:text-white font-bold text-xs">${Math.floor(currentTotalAmount / 10000).toLocaleString()}만원</span>`;
            } else {
                centerText.innerHTML = 'TOP 3';
            }
            
            // 햅틱 피드백
            if (navigator.vibrate) navigator.vibrate(5);
        }

        function filterByCategory(category) {
            if (currentCategoryFilter === category) {
                currentCategoryFilter = null;
            } else {
                currentCategoryFilter = category;
            }

            // Update Legend UI
            const items = document.querySelectorAll('.legend-item');
            items.forEach(item => {
                if (currentCategoryFilter && item.dataset.category !== currentCategoryFilter) {
                    item.classList.add('opacity-30');
                    item.classList.remove('hover:opacity-80');
                } else {
                    item.classList.remove('opacity-30');
                    item.classList.add('hover:opacity-80');
                }
            });

            renderTransactions();
        }

        function renderTransactions() {
            const listEl = document.getElementById('transactionList');
            let filtered = allTransactions;

            if (currentCategoryFilter) {
                filtered = allTransactions.filter(tx => tx.category === currentCategoryFilter);
            }
            
            listEl.innerHTML = filtered.map(tx => {
                const category = getCategoryIcon(tx.category);
                return `
                    <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${category.bg} flex items-center justify-center ${category.text} flex-shrink-0">
                                <i data-lucide="${category.icon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-0.5">${tx.date} · ${tx.installment}</p>
                                <p class="font-bold text-gray-900 dark:text-white">${tx.desc}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-900 dark:text-white">${tx.amount.toLocaleString()}원</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function getCategoryIcon(category) {
            const map = {
                'cafe': { icon: 'coffee', bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-600 dark:text-orange-400' },
                'shopping': { icon: 'shopping-bag', bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-600 dark:text-purple-400' },
                'store': { icon: 'store', bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-600 dark:text-blue-400' },
                'food': { icon: 'utensils', bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-600 dark:text-green-400' },
                'transport': { icon: 'bus', bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-600 dark:text-yellow-400' },
                'sub': { icon: 'play-circle', bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-600 dark:text-red-400' },
                'culture': { icon: 'film', bg: 'bg-pink-100 dark:bg-pink-900/30', text: 'text-pink-600 dark:text-pink-400' }
            };
            return map[category] || { icon: 'credit-card', bg: 'bg-gray-100 dark:bg-gray-700', text: 'text-gray-600 dark:text-gray-400' };
        }

        function animateCountUp(element, endValue) {
            const duration = 1000;
            const startValue = 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const current = Math.floor(startValue + (endValue - startValue) * ease);
                if (element) element.innerText = current.toLocaleString() + '원';

                if (progress < 1) requestAnimationFrame(update);
                else if (element) element.innerText = endValue.toLocaleString() + '원';
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>