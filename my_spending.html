<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 내 소비</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="common.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
        <!-- Header -->
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md h-14 sticky top-0 z-20 shadow-sm dark:shadow-gray-900/50 transition-colors duration-300">
            <div class="max-w-md mx-auto h-full flex items-center justify-center px-4 relative">
                <button onclick="history.back()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
                </button>
                <h1 class="text-lg font-bold text-gray-900 dark:text-white">내 소비</h1>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-6">
            <!-- Total Spending Summary -->
            <div class="text-center py-4">
                <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">이번 달 총 소비</p>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white"><span id="totalSpending">0</span>원</h2>
            </div>

            <div id="cardList" class="space-y-3">
                <!-- JS로 카드 목록 렌더링 -->
            </div>

            <!-- Spending History Filter -->
            <div class="mt-4">
                <h3 class="font-bold text-sm text-gray-900 dark:text-white mb-4">최근 소비 내역</h3>
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                    <button onclick="setFilter('all')" id="filter-all" class="px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all whitespace-nowrap flex-shrink-0">전체</button>
                    <button onclick="setFilter('food')" id="filter-food" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">식비</button>
                    <button onclick="setFilter('shopping')" id="filter-shopping" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">쇼핑</button>
                    <button onclick="setFilter('transport')" id="filter-transport" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0">교통</button>
                </div>
                <div id="spendingList" class="space-y-0 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 transition-colors">
                    <!-- JS Rendering -->
                </div>
                <div id="loadingSentinel" class="py-6 flex justify-center hidden">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-gray-200 border-t-blue-600 dark:border-gray-700 dark:border-t-blue-400"></div>
                </div>
                <div id="scrollTrigger" class="h-1 w-full"></div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);
            renderCards();
            renderSpendingList();
            initInfiniteScroll();
        });

        function renderCards() {
            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            const cardListEl = document.getElementById('cardList');

            // 게스트 모드 처리
            if (persona.id === 'guest') {
                document.getElementById('totalSpending').innerText = '0';
                cardListEl.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 text-center">
                        <div class="w-16 h-16 bg-gray-50 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 dark:text-gray-500">
                            <i data-lucide="credit-card" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-2">카드 정보가 없습니다</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-6">카드를 연결하고 똑똑한 소비 관리를<br>시작해보세요.</p>
                        <button onclick="alert('준비 중인 기능입니다.')" class="w-full btn-awwwards font-bold py-3 rounded-card transition">
                            카드 연결하기
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // 퍼소나 데이터에서 카드 정보 가져오기
            const cards = persona.cards || [];

            let total = 0;

            cardListEl.innerHTML = cards.map((card, index) => {
                total += card.amount;
                return `
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center transition-all cursor-pointer active:scale-95 hover:shadow-md" onclick="goToCardDetail('${card.name}', '${card.number}', event)">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-gray-50 dark:bg-gray-700 flex items-center justify-center border border-gray-100 dark:border-gray-600 overflow-hidden">
                                <img src="${getBankLogoUrl(card.bank)}" onerror="handleImageError(this, '${card.bank[0]}')" class="w-6 h-6 object-contain" alt="${card.bank}">
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">
                                    ${card.name} (${card.number})
                                </p>
                                <p class="font-bold text-gray-900 dark:text-white text-lg"><span class="count-up" data-value="${card.amount}">0</span>원</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 dark:text-gray-500"></i>
                    </div>
                `;
            }).join('');

            animateCountUp(document.getElementById('totalSpending'), total);
            
            document.querySelectorAll('.count-up').forEach(el => {
                animateCountUp(el, parseInt(el.dataset.value));
            });
            
            lucide.createIcons();
        }

        function goToCardDetail(name, number, event) {
            if (event) event.stopPropagation();
            localStorage.setItem('selectedCard', JSON.stringify({ name, number }));
            location.href = 'card_detail.html';
        }

        // Mock Data for Spending History
        let spendingData = [
            { id: 1, date: '오늘', desc: '스타벅스 강남점', amount: 4500, category: 'food', card: '현대카드' },
            { id: 2, date: '오늘', desc: 'GS25 역삼점', amount: 3200, category: 'food', card: '신한카드' },
            { id: 3, date: '어제', desc: '쿠팡', amount: 28500, category: 'shopping', card: '현대카드' },
            { id: 4, date: '어제', desc: '지하철', amount: 1250, category: 'transport', card: '후불교통' },
            { id: 5, date: '10.25', desc: '배달의민족', amount: 22000, category: 'food', card: '현대카드' },
            { id: 6, date: '10.24', desc: '카카오택시', amount: 11500, category: 'transport', card: '신한카드' },
            { id: 7, date: '10.23', desc: '무신사', amount: 56000, category: 'shopping', card: '현대카드' },
            { id: 8, date: '10.22', desc: 'CGV 강남', amount: 15000, category: 'culture', card: '신한카드' },
        ];

        let currentFilter = 'all';
        let isLoading = false;

        function setFilter(filter) {
            currentFilter = filter;
            
            const buttons = ['all', 'food', 'shopping', 'transport'];
            buttons.forEach(btn => {
                const el = document.getElementById(`filter-${btn}`);
                if (btn === filter) {
                    el.className = 'px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all whitespace-nowrap flex-shrink-0';
                } else {
                    el.className = 'px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all whitespace-nowrap flex-shrink-0';
                }
            });
            renderSpendingList();
        }

        function renderSpendingList() {
            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            const listEl = document.getElementById('spendingList');
            
            // 게스트 모드 처리
            if (persona.id === 'guest') {
                listEl.innerHTML = `<div class="p-8 text-center text-gray-400 dark:text-gray-500">소비 내역이 없습니다.</div>`;
                return;
            }

            let filtered = spendingData;
            
            if (currentFilter !== 'all') {
                filtered = spendingData.filter(item => item.category === currentFilter);
            }

            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="p-8 text-center text-gray-400 dark:text-gray-500">내역이 없습니다.</div>`;
                return;
            }

            let lastMonth = '';
            
            listEl.innerHTML = filtered.map(item => {
                const month = getMonthFromDate(item.date);
                let headerHtml = '';

                if (month !== lastMonth) {
                    lastMonth = month;
                    headerHtml = `<div class="sticky top-14 z-10 bg-gray-50/95 dark:bg-gray-700/95 backdrop-blur-sm px-4 py-2 text-xs font-bold text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-gray-700 shadow-sm">${month}</div>`;
                }

                const categoryInfo = getCategoryInfo(item.category);
                return `
                    ${headerHtml}
                    <div class="flex justify-between items-center p-4 border-b border-gray-50 dark:border-gray-700/50 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer active:scale-95">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full ${categoryInfo.bg} flex items-center justify-center ${categoryInfo.text} flex-shrink-0">
                                <i data-lucide="${categoryInfo.icon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-0.5">${item.date} · ${item.card}</p>
                                <p class="text-sm font-bold text-gray-900 dark:text-white">${item.desc}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-900 dark:text-white">-${item.amount.toLocaleString()}원</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function initInfiniteScroll() {
            const trigger = document.getElementById('scrollTrigger');
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadMoreItems();
                }
            }, { rootMargin: '100px' });
            
            if(trigger) observer.observe(trigger);
        }

        function loadMoreItems() {
            if (isLoading) return;
            isLoading = true;
            
            const sentinel = document.getElementById('loadingSentinel');
            sentinel.classList.remove('hidden');

            setTimeout(() => {
                const newItems = generateMockData(5);
                spendingData = [...spendingData, ...newItems];
                renderSpendingList();
                
                isLoading = false;
                sentinel.classList.add('hidden');
            }, 800);
        }

        function generateMockData(count) {
            const categories = ['food', 'shopping', 'transport', 'culture'];
            const cards = ['현대카드', '신한카드', '토스뱅크', '카카오뱅크'];
            const descs = ['이마트', '스타벅스', '택시', '쿠팡', '배달의민족', 'CGV', '올리브영'];
            
            return Array.from({ length: count }, (_, i) => {
                const cat = categories[Math.floor(Math.random() * categories.length)];
                const day = Math.floor(Math.random() * 20) + 1;
                return {
                    id: Date.now() + i,
                    date: `10.${day}`,
                    desc: descs[Math.floor(Math.random() * descs.length)],
                    amount: (Math.floor(Math.random() * 50) + 1) * 1000,
                    category: cat,
                    card: cards[Math.floor(Math.random() * cards.length)]
                };
            });
        }

        function getMonthFromDate(dateStr) {
            const now = new Date();
            if (dateStr === '오늘') return (now.getMonth() + 1) + '월';
            if (dateStr === '어제') {
                const d = new Date(now);
                d.setDate(d.getDate() - 1);
                return (d.getMonth() + 1) + '월';
            }
            const parts = dateStr.split('.');
            return parts.length >= 1 ? parseInt(parts[0]) + '월' : '기타';
        }

        function getCategoryInfo(category) {
            switch(category) {
                case 'food': return { icon: 'utensils', bg: 'bg-orange-100 dark:bg-orange-900/20', text: 'text-orange-600 dark:text-orange-400' };
                case 'shopping': return { icon: 'shopping-bag', bg: 'bg-purple-100 dark:bg-purple-900/20', text: 'text-purple-600 dark:text-purple-400' };
                case 'transport': return { icon: 'bus', bg: 'bg-blue-100 dark:bg-blue-900/20', text: 'text-blue-600 dark:text-blue-400' };
                case 'culture': return { icon: 'film', bg: 'bg-pink-100 dark:bg-pink-900/20', text: 'text-pink-600 dark:text-pink-400' };
                default: return { icon: 'credit-card', bg: 'bg-gray-100 dark:bg-gray-700', text: 'text-gray-600 dark:text-gray-400' };
            }
        }

        function animateCountUp(element, endValue) {
            const duration = 1500;
            const startTime = performance.now();
            const startValue = 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const current = Math.floor(startValue + (endValue - startValue) * ease);
                if (element) element.innerText = current.toLocaleString();

                if (progress < 1) requestAnimationFrame(update);
                else if (element) element.innerText = endValue.toLocaleString();
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>