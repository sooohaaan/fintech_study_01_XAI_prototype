<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - ë¯¸ì…˜ ìƒì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="common.js"></script>
    <style>
        .progress-bar-bounce {
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes scaleUpCheck {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-scale-up-check {
            animation: scaleUpCheck 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
    <!-- Header -->
    <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md h-14 sticky top-0 z-20 shadow-sm dark:shadow-gray-900/50 transition-colors duration-300">
        <div class="max-w-md mx-auto h-full flex items-center justify-center px-4 relative">
            <button onclick="handleBack()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
            <h1 class="text-lg font-bold text-gray-900 dark:text-white">ë¯¸ì…˜ ìƒì„¸</h1>
            <button id="headerListBtn" onclick="location.href='mission_list.html'" class="absolute right-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                <i data-lucide="list" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
            </button>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-6">
        <!-- Mission Info Card -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 text-center relative overflow-hidden">
            <div id="completedBadge" class="hidden absolute top-0 right-0 bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm z-10">
                MISSION CLEAR
            </div>
            <div id="highRewardBadge" class="hidden absolute top-0 left-0 bg-gradient-to-r from-orange-400 to-red-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-xl shadow-sm z-10 flex items-center gap-1">
                <i data-lucide="flame" class="w-3 h-3"></i> High Reward
            </div>
            
            <div id="missionIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl bg-blue-50 dark:bg-blue-900/30 text-blue-500">
                ğŸ¯
            </div>
            <h2 id="missionTitle" class="text-xl font-bold text-gray-900 dark:text-white mb-2">ë¯¸ì…˜ ì œëª©</h2>
            <div class="flex justify-center gap-3 mb-6">
                <div class="flex flex-col items-center justify-center w-28 py-2.5 bg-gray-50 dark:bg-gray-700/30 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <span class="text-[10px] text-gray-500 dark:text-gray-400 mb-0.5">ì´ íšë“ ê°€ëŠ¥</span>
                    <span class="text-sm font-bold text-gray-900 dark:text-white"><span id="totalReward">0</span> P</span>
                </div>
                <div class="flex flex-col items-center justify-center w-28 py-2.5 bg-purple-50 dark:bg-purple-900/20 rounded-2xl border border-purple-100 dark:border-purple-800/50">
                    <span class="text-[10px] text-purple-600 dark:text-purple-400 font-bold mb-0.5">í˜„ì¬ íšë“</span>
                    <span class="text-sm font-bold text-electricPurple dark:text-purple-400"><span id="earnedReward">0</span> P</span>
                </div>
            </div>
            <p id="missionDesc" class="text-sm text-gray-500 dark:text-gray-400 mb-6">ë¯¸ì…˜ ì„¤ëª…</p>
            
            <div class="flex justify-between items-center text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 px-1">
                <span id="missionDday">D-Day</span>
                <span id="missionProgressText">0%</span>
            </div>
            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden shadow-inner p-0.5">
                <div id="missionProgressBar" class="bg-gradient-to-r from-blue-400 to-deepBlue dark:from-blue-400 dark:to-blue-600 h-full rounded-full progress-bar-bounce shadow-sm relative overflow-hidden" style="width: 0%">
                    <div class="absolute inset-0 bg-white/10"></div>
                </div>
            </div>
        </div>

        <!-- Sub Missions -->
        <div>
            <h3 class="font-bold text-sm text-gray-900 dark:text-white mb-4 px-1">ì„¸ë¶€ ë¯¸ì…˜</h3>
            <div id="subMissionList" class="space-y-3">
                <!-- JS Rendering -->
            </div>
        </div>

        <!-- Point Contribution Graph -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="font-bold text-sm text-gray-900 dark:text-white mb-4">í¬ì¸íŠ¸ ê¸°ì—¬ë„</h3>
            <div class="relative pt-1">
                <div class="flex mb-2 items-center justify-between">
                    <div>
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-electricPurple bg-purple-50 dark:bg-purple-900/20 dark:text-purple-400">
                            ë‹¤ìŒ ë ˆë²¨ê¹Œì§€
                        </span>
                    </div>
                    <div class="text-right">
                        <span id="contributionPercent" class="text-xs font-semibold inline-block text-electricPurple dark:text-purple-400">
                            0%
                        </span>
                    </div>
                </div>
                <div class="overflow-hidden h-4 mb-4 text-xs flex rounded-full bg-gray-100 dark:bg-gray-700">
                    <div id="currentPointBar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gray-400 dark:bg-gray-500 transition-all duration-1000"></div>
                    <div id="rewardPointBar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-electricPurple dark:bg-purple-500 transition-all duration-1000 relative">
                         <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span>í˜„ì¬ <span id="currentPointText">0</span>P</span>
                    <span>ëª©í‘œ <span id="goalPointText">0</span>P</span>
                </div>
                <p class="text-xs text-gray-400 mt-3 text-center">
                    ì´ ë¯¸ì…˜ì„ ì™„ë£Œí•˜ë©´ ëª©í‘œì˜ <span id="contributionText" class="font-bold text-electricPurple dark:text-purple-400">0%</span>ë¥¼ ë” ì±„ìš¸ ìˆ˜ ìˆì–´ìš”!
                </p>
            </div>
        </div>

        <!-- Give Up Button -->
        <button id="actionBtn" onclick="giveUpMission()" class="w-full py-4 text-sm text-red-500 font-bold hover:bg-red-50 dark:hover:bg-red-900/20 rounded-2xl transition">
            ë¯¸ì…˜ í¬ê¸°í•˜ê¸°
        </button>

        <div id="listLink" class="text-center pb-4">
            <button onclick="location.href='mission_list.html'" class="text-xs text-gray-400 dark:text-gray-500 font-medium hover:text-gray-600 dark:hover:text-gray-300 transition underline decoration-gray-300 dark:decoration-gray-600 underline-offset-4">
                ë‹¤ë¥¸ ë¯¸ì…˜ ëª©ë¡ ë³´ê¸°
            </button>
        </div>
    </main>
    </div>

    <!-- Give Up Confirmation Modal -->
    <div id="giveUpModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeGiveUpModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-3xl p-8 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-8"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">í˜„ì¬ê¹Œì§€ì˜ ì§„í–‰ ìƒí™©ì´ ëª¨ë‘ ì‚­ì œë˜ë©°,<br>ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex gap-3">
                <button onclick="closeGiveUpModal()" class="flex-1 py-4 rounded-2xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì·¨ì†Œ</button>
                <button onclick="confirmGiveUp()" class="flex-1 py-4 rounded-2xl bg-red-500 text-white font-bold hover:bg-red-600 transition">í¬ê¸°í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let currentMission = null;
        let isDefaultMission = false;

        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);
            loadMission();
            initBottomSheetDrag('giveUpModal', closeGiveUpModal);
        });

        function handleBack() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') === 'result') {
                location.href = 'mission_list.html';
            } else {
                history.back();
            }
        }

        function loadMission() {
            const urlParams = new URLSearchParams(window.location.search);
            const missionId = urlParams.get('id');

            if (!missionId) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                history.back();
                return;
            }

            // 1. ê¸°ë³¸ ë¯¸ì…˜ í™•ì¸
            if (missionId === 'mission_housing') {
                isDefaultMission = true;
                currentMission = {
                    id: 'mission_housing',
                    title: 'ì£¼íƒ ë§ˆë ¨ 3ì–µ ëŒ€ì¶œ ë„ì „',
                    desc: 'ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ AI ë§ì¶¤ í”Œëœ',
                    deadline: Date.now() + (90 * 24 * 60 * 60 * 1000), // D-day ê¸°ì¤€ì¼ ì„¤ì •
                    progress: 0,
                    color: 'blue',
                    subMissions: [
                        { id: 'sub1', text: '2ë‹¬ ë™ì•ˆ ì‹ ìš© ì¹´ë“œ ì‚¬ìš©ìœ¼ë¡œ ì‹ ìš© ì ìˆ˜ 20ì  ì˜¬ë¦¬ê¸°', status: 'active' },
                        { id: 'sub2', text: '3ë‹¬ ë™ì•ˆ 300ë§Œì› ëª¨ì•„ ìì‚° ëŠ¥ë ¥ 30% ë†’ì´ê¸°', status: 'ready' }
                    ]
                };
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ìƒíƒœê°€ ì €ì¥ë˜ì–´ ìˆë‹¤ë©´ ë®ì–´ì“°ê¸° (ê¸°ë³¸ ë¯¸ì…˜ë„ ìƒíƒœ ì €ì¥ì„ ìœ„í•´)
                const storedMissions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
                const saved = storedMissions.find(m => m.id === missionId);
                if (saved) currentMission = saved;
            } else {
                // 2. ì €ì¥ëœ ë¯¸ì…˜ í™•ì¸
                const storedMissions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
                currentMission = storedMissions.find(m => m.id === missionId);
            }

            if (!currentMission) {
                alert('ë¯¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                history.back();
                return;
            }

            // D-day ì‹¤ì‹œê°„ ê³„ì‚°
            if (!currentMission.deadline) {
                currentMission.deadline = Date.now() + (30 * 24 * 60 * 60 * 1000); // ê¸°ë³¸ 30ì¼
            }

            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const deadline = new Date(currentMission.deadline);
            deadline.setHours(0, 0, 0, 0);

            const diffTime = deadline - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            currentMission.dday = diffDays > 0 ? `D-${diffDays}` : (diffDays === 0 ? 'D-Day' : 'ì¢…ë£Œ');

            renderUI(0, null);
        }

        function getMissionLink(text) {
            if (text.includes('ì‹ ìš©')) return 'home.html';
            if (text.includes('ìì‚°') || text.includes('ë§ˆì´ë°ì´í„°') || text.includes('ëª¨ì•„')) return 'assets.html';
            if (text.includes('ë¶€ì±„') || text.includes('ëŒ€ì¶œ') || text.includes('ìƒí™˜')) return 'my_loans.html';
            if (text.includes('ì†Œë¹„') || text.includes('ì§€ì¶œ') || text.includes('ì¹´ë“œ')) return 'my_spending.html';
            return null;
        }

        function getMissionRewards(mission) {
            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            
            let difficulty = 1.0;
            
            // í¼ì†Œë‚˜ ìƒí™©ì— ë”°ë¥¸ ë‚œì´ë„ ê°€ì¤‘ì¹˜ ê³„ì‚°
            if (mission.title.includes('ì‹ ìš©')) {
                const score = persona.creditScore || 0;
                if (score < 650) difficulty += 0.5; // ì €ì‹ ìš©ì: ê°œì„  ë‚œì´ë„/í•„ìš”ì„± ë†’ìŒ
                else if (score > 900) difficulty += 0.2; // ê³ ì‹ ìš©ì: ì¶”ê°€ ìƒìŠ¹ ë‚œì´ë„
            }
            
            if (mission.title.includes('ëŒ€ì¶œ') || mission.title.includes('ìƒí™˜') || mission.title.includes('ë¶€ì±„')) {
                const dsr = persona.dsr || 0;
                if (dsr > 40) difficulty += 0.4; // ê³ ë¶€ì±„: ê´€ë¦¬ ë‚œì´ë„ ë†’ìŒ
            }
            
            if (mission.title.includes('ì£¼íƒ') || mission.title.includes('ìì‚°')) {
                const income = persona.income || 0;
                if (income < 3500) difficulty += 0.3; // ìì‚° í˜•ì„± ë…¸ë ¥ ê°€ì¤‘ì¹˜
            }

            // ê¸°ë³¸ í¬ì¸íŠ¸ ì„¤ì •
            const baseSubPoint = 100;
            const baseFinalPoint = 300;
            
            const subPoint = Math.round(baseSubPoint * difficulty / 10) * 10;
            const finalPoint = Math.round(baseFinalPoint * difficulty / 10) * 10;
            
            return { subPoint, finalPoint, isHighReward: difficulty >= 1.3 };
        }

        function renderUI(prevProgress = 0, completedSubId = null) {
            document.getElementById('missionTitle').innerText = currentMission.title;
            document.getElementById('missionDesc').innerText = currentMission.desc;
            document.getElementById('missionDday').innerText = currentMission.dday;
            
            // ë³´ìƒ í¬ì¸íŠ¸ í‘œì‹œ
            const rewards = getMissionRewards(currentMission);
            const subMissionCount = currentMission.subMissions ? currentMission.subMissions.length : 0;
            const totalReward = rewards.finalPoint + (subMissionCount * rewards.subPoint);
            
            const completedCount = currentMission.subMissions ? currentMission.subMissions.filter(s => s.status === 'completed').length : 0;
            let earnedReward = completedCount * rewards.subPoint;
            if (currentMission.completedAt) earnedReward += rewards.finalPoint;

            animatePoint(document.getElementById('totalReward'), totalReward);
            animatePoint(document.getElementById('earnedReward'), earnedReward);
            
            // High Reward ë°°ì§€ í‘œì‹œ
            const highRewardBadge = document.getElementById('highRewardBadge');
            if (highRewardBadge) {
                if (rewards.isHighReward) highRewardBadge.classList.remove('hidden');
                else highRewardBadge.classList.add('hidden');
            }
            
            renderContributionGraph(rewards);
            
            // ì§„í–‰ë¥  ì¬ê³„ì‚°
            const total = currentMission.subMissions.length;
            const completed = currentMission.subMissions.filter(s => s.status === 'completed').length;
            const progress = total === 0 ? 0 : Math.round((completed / total) * 100);
            currentMission.progress = progress;

            animateProgressText(document.getElementById('missionProgressText'), progress, prevProgress);
            
            const progressBar = document.getElementById('missionProgressBar');
            let gradientClass = 'bg-gradient-to-r from-blue-400 to-deepBlue dark:from-blue-400 dark:to-blue-600';

            if (currentMission.color === 'purple') {
                gradientClass = 'bg-gradient-to-r from-purple-400 to-electricPurple dark:from-purple-400 dark:to-purple-600';
            } else if (currentMission.color === 'red') {
                gradientClass = 'bg-gradient-to-r from-red-400 to-red-600 dark:from-red-400 dark:to-red-600';
            }
            progressBar.className = `${gradientClass} h-full rounded-full progress-bar-bounce shadow-sm relative overflow-hidden`;
            progressBar.style.width = `${progress}%`;

            // ì™„ë£Œ ìƒíƒœ ì²˜ë¦¬
            const isCompleted = progress >= 100;
            const badge = document.getElementById('completedBadge');
            const actionBtn = document.getElementById('actionBtn');
            const iconEl = document.getElementById('missionIcon');
            const headerListBtn = document.getElementById('headerListBtn');

            if (headerListBtn) {
                headerListBtn.onclick = () => location.href = isCompleted ? 'mission_list.html?tab=completed' : 'mission_list.html';
            }

            if (isCompleted) {
                badge.classList.remove('hidden');
                iconEl.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400";
                iconEl.innerHTML = '<i data-lucide="trophy" class="w-8 h-8"></i>';
                
                actionBtn.innerText = 'ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
                actionBtn.className = 'w-full py-4 text-sm text-white dark:text-gray-900 font-bold bg-gray-900 dark:bg-white hover:bg-black dark:hover:bg-gray-200 rounded-2xl transition shadow-lg';
                actionBtn.onclick = () => location.href = 'mission_list.html?tab=completed';
                
                const listLink = document.getElementById('listLink');
                if (listLink) listLink.classList.add('hidden');
            } else {
                let iconBgClass = 'bg-blue-50 dark:bg-blue-900/30 text-blue-500 dark:text-blue-400';
                if (currentMission.color === 'purple') {
                    iconBgClass = 'bg-purple-50 dark:bg-purple-900/30 text-electricPurple dark:text-purple-400';
                } else if (currentMission.color === 'red') {
                    iconBgClass = 'bg-red-50 dark:bg-red-900/30 text-red-500 dark:text-red-400';
                }
                
                iconEl.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl ${iconBgClass}`;
                iconEl.innerHTML = 'ğŸ¯';
            }

            const listEl = document.getElementById('subMissionList');
            
            // ì •ë ¬: ì§„í–‰ì¤‘(active) -> ì¤€ë¹„(ready) -> ì™„ë£Œ(completed)
            const sortedSubMissions = [...currentMission.subMissions].sort((a, b) => {
                const statusOrder = { 'active': 0, 'ready': 1, 'completed': 2 };
                return (statusOrder[a.status] || 3) - (statusOrder[b.status] || 3);
            });

            listEl.innerHTML = sortedSubMissions.map(sub => {
                let btnHtml = '';
                let statusClass = '';
                let icon = 'circle';
                let iconClass = 'text-gray-400';

                if (sub.status === 'completed') {
                    statusClass = 'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800/50 opacity-80';
                    icon = 'check-circle-2';
                    
                    if (sub.id === completedSubId) {
                        iconClass = 'text-green-500 dark:text-green-400 animate-scale-up-check';
                    } else {
                        iconClass = 'text-green-500 dark:text-green-400';
                    }
                    
                    btnHtml = `<span class="text-xs font-bold text-green-600 dark:text-green-400 flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> ì™„ë£Œ</span>`;
                } else if (sub.status === 'active') {
                    statusClass = 'bg-blue-50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-800 shadow-sm';
                    icon = 'play-circle';
                    iconClass = 'text-deepBlue dark:text-blue-400';
                    btnHtml = `<button onclick="updateSubMission('${sub.id}', 'completed')" class="bg-gray-900 dark:bg-white text-white dark:text-gray-900 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-black dark:hover:bg-gray-200 transition shadow-sm">ì™„ë£Œí•˜ê¸°</button>`;
                } else {
                    statusClass = 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700';
                    icon = 'circle';
                    iconClass = 'text-gray-400';
                    btnHtml = `<button onclick="updateSubMission('${sub.id}', 'active')" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">ì‹œì‘</button>`;
                }

                // Link Logic
                const linkUrl = getMissionLink(sub.text);
                let textContent = `<span class="text-sm font-medium text-gray-900 dark:text-white ${sub.status === 'completed' ? 'line-through text-gray-400' : ''}">${sub.text}</span>`;
                
                if (linkUrl && sub.status !== 'completed') {
                    textContent = `
                        <a href="${linkUrl}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-deepBlue dark:hover:text-blue-400 underline decoration-dotted underline-offset-4 transition-colors flex items-center gap-1 group">
                            ${sub.text}
                            <i data-lucide="external-link" class="w-3 h-3 text-gray-400 group-hover:text-deepBlue dark:group-hover:text-blue-400"></i>
                        </a>
                    `;
                }

                // Point Badge
                let pointBadge = '';
                if (sub.status !== 'completed') {
                    pointBadge = `<span class="text-[10px] font-bold text-electricPurple dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20 px-1.5 py-0.5 rounded ml-2 flex-shrink-0">+${rewards.subPoint}P</span>`;
                }

                return `
                    <div class="p-4 rounded-2xl border ${statusClass} flex justify-between items-center transition-all">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <i data-lucide="${icon}" class="w-5 h-5 ${iconClass} flex-shrink-0"></i>
                            <div class="flex items-center flex-wrap gap-y-1">
                                ${textContent}
                                ${pointBadge}
                            </div>
                        </div>
                        <div class="ml-3 flex-shrink-0">
                            ${btnHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function renderContributionGraph(rewards) {
            const personaData = localStorage.getItem('trustFinPersona');
            const persona = JSON.parse(personaData || '{}');
            const currentPoints = persona.points || 0;
            
            // Calculate remaining potential reward from this mission
            let remainingReward = 0;
            if (currentMission.progress < 100) {
                const remainingSubCount = currentMission.subMissions.filter(s => s.status !== 'completed').length;
                remainingReward += remainingSubCount * rewards.subPoint;
                if (!currentMission.completedAt) {
                    remainingReward += rewards.finalPoint;
                }
            }

            // Goal calculation (Next 3000 points milestone)
            const baseGoal = 3000;
            let goal = Math.ceil((currentPoints + 0.1) / baseGoal) * baseGoal;
            if (currentPoints + remainingReward > goal) {
                goal = Math.ceil((currentPoints + remainingReward) / baseGoal) * baseGoal;
            }

            const currentPercent = (currentPoints / goal) * 100;
            const rewardPercent = (remainingReward / goal) * 100;
            const totalPercent = Math.min(100, currentPercent + rewardPercent);

            document.getElementById('currentPointBar').style.width = `${currentPercent}%`;
            document.getElementById('rewardPointBar').style.width = `${rewardPercent}%`;
            
            document.getElementById('currentPointText').innerText = currentPoints.toLocaleString();
            document.getElementById('goalPointText').innerText = goal.toLocaleString();
            
            document.getElementById('contributionPercent').innerText = `${Math.round(totalPercent)}% ë‹¬ì„± ì˜ˆì •`;
            document.getElementById('contributionText').innerText = `+${Math.round(rewardPercent)}%`;
        }

        function updateSubMission(subId, newStatus) {
            const sub = currentMission.subMissions.find(s => s.id === subId);
            if (sub) {
                const rewards = getMissionRewards(currentMission);

                const prevStatus = sub.status;
                if (prevStatus === newStatus) return;

                const prevProgress = currentMission.progress;
                sub.status = newStatus;
                
                // ì§„í–‰ë¥  ê³„ì‚° ë° ì™„ë£Œ ë‚ ì§œ ì €ì¥
                const total = currentMission.subMissions.length;
                const completedCount = currentMission.subMissions.filter(s => s.status === 'completed').length;
                const newProgress = total === 0 ? 0 : Math.round((completedCount / total) * 100);
                
                currentMission.progress = newProgress;

                // 1. ì„¸ë¶€ ë¯¸ì…˜ ì™„ë£Œ ë³´ìƒ (ë™ì  ê³„ì‚°)
                if (newStatus === 'completed') {
                    awardPoints(rewards.subPoint, 'ì„¸ë¶€ ë¯¸ì…˜ ì™„ë£Œ');
                }

                // 2. ìµœì¢… ì™„ë£Œ ë³´ìƒ (ë™ì  ê³„ì‚°)
                if (newProgress >= 100 && !currentMission.completedAt) {
                    currentMission.completedAt = Date.now();
                    awardPoints(rewards.finalPoint, 'ë¯¸ì…˜ ìµœì¢… ì™„ë£Œ ë³´ìƒ');
                } else if (newProgress < 100) {
                    delete currentMission.completedAt;
                }

                // í¸ì˜ ê¸°ëŠ¥: ì§„í–‰ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ê³  ë¯¸ì™„ë£Œ ìƒíƒœì¼ ë•Œ, ë‹¤ìŒ 'ì¤€ë¹„' ë¯¸ì…˜ì„ ìë™ìœ¼ë¡œ 'ì§„í–‰ì¤‘'ìœ¼ë¡œ ë³€ê²½
                const hasActive = currentMission.subMissions.some(s => s.status === 'active');
                if (!hasActive && currentMission.progress < 100 && newStatus === 'completed') {
                    const nextReady = currentMission.subMissions.find(s => s.status === 'ready');
                    if (nextReady) nextReady.status = 'active';
                }

                saveMission();
                renderUI(prevProgress, newStatus === 'completed' ? subId : null);

                // ë¯¸ì…˜ ì™„ë£Œ ì‹œ í­ì£½ íš¨ê³¼
                if (newProgress >= 100 && newStatus === 'completed') {
                    let confettiColors = ['#1D4ED8', '#7C3AED', '#10B981', '#F59E0B']; // ê¸°ë³¸ (ì•Œë¡ë‹¬ë¡)

                    if (currentMission.color === 'blue') {
                        confettiColors = ['#4353FF', '#3B82F6', '#60A5FA', '#2563EB'];
                    } else if (currentMission.color === 'red') {
                        confettiColors = ['#EF4444', '#DC2626', '#F87171', '#B91C1C'];
                    } else if (currentMission.color === 'purple') {
                        confettiColors = ['#7C3AED', '#8B5CF6', '#A78BFA', '#C4B5FD'];
                    }

                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: confettiColors
                    });
                }
            }
        }

        function saveMission() {
            let missions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
            const index = missions.findIndex(m => m.id === currentMission.id);
            
            if (index >= 0) {
                missions[index] = currentMission;
            } else {
                missions.push(currentMission);
            }
            localStorage.setItem('trustFinMissions', JSON.stringify(missions));
        }

        function giveUpMission() {
            const modal = document.getElementById('giveUpModal');
            const content = modal.querySelector('.bg-white');
            content.classList.add('animate-slide-up');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(true);
        }

        function closeGiveUpModal() {
            const modal = document.getElementById('giveUpModal');
            const content = modal.querySelector('.bg-white');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('animate-slide-down');
                document.body.style.overflow = '';
                if (typeof toggleBackgroundScale === 'function') toggleBackgroundScale(false);
            }, 300);
        }

        function awardPoints(amount, title) {
            const personaData = localStorage.getItem('trustFinPersona');
            if (personaData) {
                const persona = JSON.parse(personaData);
                persona.points = (persona.points || 0) + amount;
                localStorage.setItem('trustFinPersona', JSON.stringify(persona));
                
                const history = JSON.parse(localStorage.getItem('trustFinPointHistory') || '[]');
                const now = new Date();
                const dateStr = `${now.getMonth() + 1}.${now.getDate()}`;
                history.unshift({
                    title: title,
                    date: dateStr,
                    amount: amount,
                    type: 'earn'
                });
                localStorage.setItem('trustFinPointHistory', JSON.stringify(history));

                setTimeout(() => showGlobalToast(`${title}! ${amount}Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`), 800);
            }
        }

        function confirmGiveUp() {
            let missions = JSON.parse(localStorage.getItem('trustFinMissions') || '[]');
            missions = missions.filter(m => m.id !== currentMission.id);
            localStorage.setItem('trustFinMissions', JSON.stringify(missions));
            location.href = 'home.html';
        }

        function animateProgressText(element, endValue, startValue) {
            const duration = 1200;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3); // Ease-out cubic
                
                const current = Math.floor(startValue + (endValue - startValue) * ease);
                element.innerText = `${current}% ë‹¬ì„±`;

                if (progress < 1) requestAnimationFrame(update);
                else element.innerText = `${endValue}% ë‹¬ì„±`;
            }
            requestAnimationFrame(update);
        }

        function animatePoint(element, endValue) {
            const duration = 1000;
            const startTime = performance.now();
            const startValue = parseInt(element.innerText.replace(/[^0-9]/g, '')) || 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const current = Math.floor(startValue + (endValue - startValue) * ease);
                element.innerText = current.toLocaleString();

                if (progress < 1) requestAnimationFrame(update);
                else element.innerText = endValue.toLocaleString();
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>