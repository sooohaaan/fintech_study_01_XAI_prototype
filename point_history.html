<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 포인트 내역</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="common.js"></script>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
        <!-- Header -->
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md h-14 sticky top-0 z-20 shadow-sm dark:shadow-gray-900/50 transition-colors duration-300">
            <div class="max-w-md mx-auto h-full flex items-center justify-center px-4 relative">
                <button onclick="history.back()" class="absolute left-4 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i>
                </button>
                <h1 class="text-lg font-bold text-gray-900 dark:text-white">포인트 내역</h1>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-6">
            <!-- Summary -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 text-center transition-colors">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">현재 보유 포인트</p>
                <h2 class="text-3xl font-bold text-electricPurple dark:text-purple-400"><span id="currentPoints">0</span> P</h2>
                <button onclick="location.href='point_shop.html'" class="mt-4 bg-gray-900 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-md hover:bg-black transition active:scale-95 flex items-center gap-2 mx-auto"><i data-lucide="shopping-bag" class="w-4 h-4"></i>포인트 사용하기</button>
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2">
                <button onclick="filterHistory('all')" id="filter-all" class="px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all">전체</button>
                <button onclick="filterHistory('earn')" id="filter-earn" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">적립</button>
                <button onclick="filterHistory('use')" id="filter-use" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">사용</button>
            </div>

            <!-- History List -->
            <div>
                <h3 class="font-bold text-gray-900 dark:text-white mb-4 px-1 text-sm">최근 내역</h3>
                <div id="historyList" class="space-y-0 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 transition-colors">
                    <!-- JS Rendering -->
                </div>
                <div id="loadingSentinel" class="py-6 flex justify-center hidden">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-gray-200 border-t-blue-600 dark:border-gray-700 dark:border-t-blue-400"></div>
                </div>
                <div id="scrollTrigger" class="h-1 w-full"></div>
            </div>
        </main>
    </div>

    <script>
        let allHistory = [];
        let currentFilter = 'all';
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI(null);
            loadPointData();
            initInfiniteScroll();
        });

        function filterHistory(filter) {
            currentFilter = filter;
            
            const buttons = ['all', 'earn', 'use'];
            buttons.forEach(btn => {
                const el = document.getElementById(`filter-${btn}`);
                if (btn === filter) {
                    el.className = 'px-4 py-2 rounded-full text-sm font-bold bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-md transition-all';
                } else {
                    el.className = 'px-4 py-2 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all';
                }
            });
            renderHistoryList();
        }

        function loadPointData() {
            const personaData = localStorage.getItem('trustFinPersona');
            if (!personaData) return;
            
            const persona = JSON.parse(personaData);
            const currentPoints = persona.points || 0;
            
            // Animate Points
            animateCountUp(document.getElementById('currentPoints'), currentPoints);

            // Load History
            let history = JSON.parse(localStorage.getItem('trustFinPointHistory') || '[]');
            
            // 가상 데이터 생성 (기록이 없는데 포인트가 있는 경우 등)
            if (history.length === 0 && currentPoints > 0) {
                history = [
                    { title: '신규 가입 축하', date: '2023.10.20', amount: 1000, type: 'earn' },
                    { title: '커피 쿠폰 구매', date: '2023.10.25', amount: -500, type: 'use' }
                ];
                // 현재 포인트에 맞춰 보정 (단순 예시)
                if (currentPoints !== 500) {
                     history.unshift({ title: '이벤트 참여', date: '최근', amount: currentPoints - 500, type: 'earn' });
                }
            }
            allHistory = history;
            renderHistoryList();
        }

        function renderHistoryList() {
            let filtered = allHistory;
            if (currentFilter === 'earn') {
                filtered = allHistory.filter(item => item.type === 'earn' || item.amount > 0);
            } else if (currentFilter === 'use') {
                filtered = allHistory.filter(item => item.type === 'use' || item.amount < 0);
            }

            const listEl = document.getElementById('historyList');
            if (filtered.length === 0) {
                 listEl.innerHTML = `<div class="p-8 text-center text-gray-400 dark:text-gray-500">내역이 없습니다.</div>`;
                 return;
            }

            let lastMonth = '';

            listEl.innerHTML = filtered.map(item => {
                const month = getMonthFromDate(item.date);
                let headerHtml = '';

                if (month !== lastMonth) {
                    lastMonth = month;
                    headerHtml = `<div class="sticky top-14 z-10 bg-gray-50/95 dark:bg-gray-700/95 backdrop-blur-sm px-4 py-2 text-xs font-bold text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-gray-700 shadow-sm">${month}</div>`;
                }

                const isEarn = item.type === 'earn' || item.amount > 0;
                const amountClass = isEarn ? 'text-deepBlue dark:text-blue-400' : 'text-gray-900 dark:text-white';
                const sign = isEarn ? '+' : '';
                const icon = isEarn ? 'plus-circle' : 'minus-circle';
                const iconColor = isEarn ? 'text-deepBlue dark:text-blue-400' : 'text-gray-400';
                const bg = isEarn ? 'bg-blue-50 dark:bg-blue-900/30' : 'bg-gray-100 dark:bg-gray-700';

                return `
                    ${headerHtml}
                    <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center ${iconColor} flex-shrink-0">
                                <i data-lucide="${icon}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 mb-0.5">${item.date}</p>
                                <p class="font-bold text-gray-900 dark:text-white">${item.title}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${amountClass}">${sign}${item.amount.toLocaleString()} P</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function getMonthFromDate(dateStr) {
            if (dateStr === '최근') return '최근';
            const parts = dateStr.split('.');
            return parts.length >= 2 ? parseInt(parts[1]) + '월' : '기타';
        }

        function initInfiniteScroll() {
            const trigger = document.getElementById('scrollTrigger');
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadMoreItems();
                }
            }, { rootMargin: '100px' });
            
            if(trigger) observer.observe(trigger);
        }

        function loadMoreItems() {
            if (isLoading) return;
            isLoading = true;
            
            const sentinel = document.getElementById('loadingSentinel');
            if(sentinel) sentinel.classList.remove('hidden');

            setTimeout(() => {
                const newItems = generateMockHistory(5);
                allHistory = [...allHistory, ...newItems];
                renderHistoryList();
                
                isLoading = false;
                if(sentinel) sentinel.classList.add('hidden');
            }, 800);
        }

        function generateMockHistory(count) {
            const titles = ['친구 초대 보상', '쇼핑 적립', '이벤트 참여', '포인트 사용', '기프티콘 구매'];
            return Array.from({ length: count }, () => {
                const isEarn = Math.random() > 0.4;
                return {
                    title: titles[Math.floor(Math.random() * titles.length)],
                    date: `2023.${Math.floor(Math.random() * 12) + 1}.${Math.floor(Math.random() * 28) + 1}`,
                    amount: (Math.floor(Math.random() * 10) + 1) * (isEarn ? 100 : -100),
                    type: isEarn ? 'earn' : 'use'
                };
            });
        }

        function animateCountUp(element, endValue) {
            const duration = 1000;
            const startTime = performance.now();
            const startValue = 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const current = Math.floor(startValue + (endValue - startValue) * ease);
                if (element) element.innerText = current.toLocaleString();

                if (progress < 1) requestAnimationFrame(update);
                else if (element) element.innerText = endValue.toLocaleString();
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>