<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustFin - 자산</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="common.js"></script>
    <style>
        @property --chart-ratio {
            syntax: '<number>';
            inherits: false;
            initial-value: 0;
        }
        .animate-donut {
            background: conic-gradient(#1D4ED8 0% calc(var(--chart-ratio) * 1%), #7C3AED calc(var(--chart-ratio) * 1%) 100%);
            animation: drawChart 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes drawChart {
            to { --chart-ratio: var(--target-ratio); }
        }
        @keyframes shimmer-slide {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }
        .animate-shimmer {
            animation: shimmer-slide 2s infinite linear;
        }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 font-sans select-none transition-colors duration-300 bg-black">
    <div id="app-content" class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-all duration-300 ease-out origin-top pb-24">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 h-16 sticky top-0 z-20 flex items-center justify-center shadow-sm dark:shadow-gray-900/50 px-4 relative transition-colors duration-300">
        <h1 class="text-lg font-bold text-gray-900 dark:text-white">자산</h1>
        <a href="notification.html" class="absolute right-4 p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition">
            <div class="relative">
                <i data-lucide="bell" class="w-6 h-6"></i>
                <span id="badge-notification" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[1.25rem] flex items-center justify-center hidden border-2 border-white dark:border-gray-800"></span>
            </div>
        </a>
    </header>

    <!-- Main Content -->
    <main class="p-5 max-w-md mx-auto space-y-6">
        
        <!-- Total Asset Summary -->
        <div class="text-center py-4">
            <p class="text-gray-500 text-sm mb-1">내 총 자산</p>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white"><span id="totalAsset">0</span>원</h2>
        </div>

        <!-- Asset Graph (Donut Chart) -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-card shadow-lg border border-gray-100 dark:border-gray-700 transition-colors">
            <h3 class="font-bold text-gray-900 dark:text-white mb-6">자산 구성</h3>
            
            <div class="flex items-center justify-center mb-8">
                <div id="donutChart" class="w-48 h-48 rounded-full relative shadow-inner">
                    <div id="chartCenter" onclick="toggleChartDisplay()" class="absolute inset-0 m-auto w-32 h-32 bg-white dark:bg-gray-800 rounded-full flex flex-col items-center justify-center shadow-sm transition-colors cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <p id="chartLabel" class="text-xs text-gray-400 mb-1">총 자산</p>
                        <p id="chartValueContainer" class="font-bold text-gray-900 dark:text-white text-lg"><span id="chartTotal">0</span>만원</p>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-deepBlue"></div>
                        <span class="text-gray-600 dark:text-gray-300 text-sm">예적금</span>
                        <span id="depositRatioText" class="text-xs text-gray-400 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">0%</span>
                    </div>
                    <span class="font-bold text-gray-900 dark:text-white"><span id="depositAmount">0</span>원</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-electricPurple"></div>
                        <span class="text-gray-600 dark:text-gray-300 text-sm">투자</span>
                        <span id="investRatioText" class="text-xs text-gray-400 bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded">0%</span>
                    </div>
                    <span class="font-bold text-gray-900 dark:text-white"><span id="investAmount">0</span>원</span>
                </div>
            </div>
        </div>

        <!-- Account List -->
        <div>
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white">입출금 계좌</h3>
                <button class="text-xs text-gray-500 hover:text-deepBlue font-medium">거래내역 전체보기</button>
            </div>
            <div id="assetList" class="space-y-3">
                <!-- JS Rendering -->
            </div>
        </div>

    </main>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onclick="closeTransferModal()"></div>
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-6 w-full max-w-md shadow-2xl relative z-10 animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">송금하기</h3>
            <p id="transferBankName" class="text-sm text-gray-500 mb-4">은행 계좌에서 송금</p>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">보낼 금액</label>
                <div class="flex items-center border-b-2 border-gray-200 dark:border-gray-600 focus-within:border-deepBlue transition">
                    <input type="number" id="transferAmount" placeholder="금액 입력" class="w-full text-lg font-bold py-2 outline-none bg-transparent dark:text-white">
                    <span class="text-gray-900 dark:text-white font-bold">원</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeTransferModal()" class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">취소</button>
                <button onclick="submitTransfer()" class="flex-1 py-3 rounded-xl bg-black text-white font-bold hover:bg-gray-700 transition">보내기</button>
            </div>
        </div>
    </div>

    <script>
        let chartMode = 0; // 0: 금액, 1: 비율

        function renderAssets() {
            const personaData = localStorage.getItem('trustFinPersona');
            if (!personaData) {
                location.href = 'login.html';
                return;
            }

            const persona = JSON.parse(personaData);
            const assetListEl = document.getElementById('assetList');
            
            // 게스트 모드 처리
            if (persona.id === 'guest') {
                // 총 자산 0원 처리
                animateCountUp(document.getElementById('totalAsset'), 0);
                
                // 도넛 차트 초기화 (0%)
                const chartEl = document.getElementById('donutChart');
                chartEl.style.setProperty('--target-ratio', 0);
                chartEl.classList.remove('animate-donut');
                
                // 차트 센터 텍스트
                const chartCenter = document.getElementById('chartCenter');
                if (chartCenter) {
                    chartCenter.dataset.total = 0;
                    chartCenter.dataset.ratio = 0;
                    updateChartCenter(false);
                }
                
                // 범례 초기화
                animateCountUp(document.getElementById('depositAmount'), 0);
                animateCountUp(document.getElementById('investAmount'), 0);
                document.getElementById('depositRatioText').innerText = '0%';
                document.getElementById('investRatioText').innerText = '0%';

                assetListEl.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-card p-6 shadow-lg border border-gray-100 dark:border-gray-700 text-center">
                        <div class="w-16 h-16 bg-gray-50 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 dark:text-gray-500">
                            <i data-lucide="wallet" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">자산 정보가 없습니다</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">계좌를 연결하고 내 자산을<br>한눈에 관리해보세요.</p>
                        <button onclick="alert('준비 중인 기능입니다.')" class="w-full bg-black text-white font-bold py-3 rounded-xl hover:bg-gray-700 transition">
                            계좌 연결하기
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            let depositTotal = 0;
            const newDepositAmount = localStorage.getItem('newDepositAmount');

            assetListEl.innerHTML = persona.accounts.map((acc, index) => {
                depositTotal += acc.balance;
                
                // 방금 입금된 계좌(첫 번째) 강조 효과
                const isTarget = newDepositAmount && index === 0;
                const containerClass = isTarget ? 'bg-green-50 dark:bg-green-900/20 ring-2 ring-green-500 transform scale-[1.02] relative overflow-hidden' : 'bg-white dark:bg-gray-800';
                const badge = isTarget ? `<span class="ml-2 text-xs font-bold text-green-600 dark:text-green-400 animate-bounce">+${parseInt(newDepositAmount).toLocaleString()}</span>` : '';
                const shimmerEffect = isTarget ? `<div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 dark:via-white/10 to-transparent animate-shimmer pointer-events-none z-0"></div>` : '';

                return `
                    <div onclick="goToAccountDetail('${acc.bank}')" class="${containerClass} p-6 rounded-card border border-gray-100 dark:border-gray-700 shadow-lg flex justify-between items-center transition-all duration-500 cursor-pointer active:scale-95 transform transition-transform">
                        ${shimmerEffect}
                        <div class="flex items-center gap-4 relative z-10">
                            <div class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center border border-gray-100 dark:border-gray-600 overflow-hidden">
                                <img src="${getBankLogoUrl(acc.bank)}" onerror="handleImageError(this, '${acc.bank[0]}')" class="w-full h-full object-cover" alt="${acc.bank}">
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-0.5">
                                    <span class="text-gray-400 text-[10px] tracking-tight">${acc.accountNumber}</span>
                                </p>
                                <p class="font-bold text-gray-900 dark:text-white text-lg flex items-center"><span class="count-up" data-value="${acc.balance}">0</span>원 ${badge}</p>
                            </div>
                        </div>
                        <button onclick="openTransferModal('${acc.bank}', event)" class="relative z-10 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">송금</button>
                    </div>
                `;
            }).join('');

            // 가상 투자 자산 생성 (예적금의 40% 수준)
            const investTotal = Math.floor(depositTotal * 0.4);
            const totalAsset = depositTotal + investTotal;

            // 상단 총 자산 업데이트
            animateCountUp(document.getElementById('totalAsset'), totalAsset);
            
            // 도넛 차트 업데이트
            const depositRatio = totalAsset > 0 ? (depositTotal / totalAsset) * 100 : 0;
            const chartEl = document.getElementById('donutChart');
            
            // CSS Animation 적용
            chartEl.style.setProperty('--target-ratio', depositRatio);
            chartEl.classList.remove('animate-donut');
            void chartEl.offsetWidth; // Trigger reflow
            chartEl.classList.add('animate-donut');
            
            // 차트 데이터 저장 및 업데이트
            const chartCenter = document.getElementById('chartCenter');
            if (chartCenter) {
                chartCenter.dataset.total = totalAsset;
                chartCenter.dataset.ratio = depositRatio;
                updateChartCenter(true); // true: 초기 로딩 (애니메이션 적용)
            }

            // 범례 업데이트
            animateCountUp(document.getElementById('depositAmount'), depositTotal);
            animateCountUp(document.getElementById('investAmount'), investTotal);
            
            document.getElementById('depositRatioText').innerText = Math.round(depositRatio) + '%';
            document.getElementById('investRatioText').innerText = Math.round(100 - depositRatio) + '%';
            
            // 리스트 애니메이션
            document.querySelectorAll('.count-up').forEach(el => {
                animateCountUp(el, parseInt(el.dataset.value));
            });

            // 강조 효과 후 정리 (3초 뒤 리렌더링하여 효과 제거)
            if (newDepositAmount) {
                // 축하 폭죽 애니메이션 실행
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#1D4ED8', '#7C3AED', '#10B981', '#F59E0B']
                });

                setTimeout(() => {
                    localStorage.removeItem('newDepositAmount');
                    renderAssets();
                }, 3000);
            }
        }

        function toggleChartDisplay() {
            chartMode = (chartMode + 1) % 2;
            updateChartCenter(false);
        }

        function updateChartCenter(animate = false) {
            const centerDiv = document.getElementById('chartCenter');
            const labelEl = document.getElementById('chartLabel');
            const valueContainer = document.getElementById('chartValueContainer');
            
            const totalAsset = parseInt(centerDiv.dataset.total || 0);
            const depositRatio = parseFloat(centerDiv.dataset.ratio || 0);

            if (chartMode === 0) {
                labelEl.innerText = '총 자산';
                valueContainer.innerHTML = `<span id="chartTotal">${Math.floor(totalAsset / 10000).toLocaleString()}</span>만원`;
                if (animate) animateCountUp(document.getElementById('chartTotal'), Math.floor(totalAsset / 10000));
            } else {
                labelEl.innerText = '예적금 비중';
                valueContainer.innerHTML = `<span class="text-deepBlue dark:text-blue-400">${Math.round(depositRatio)}</span>%`;
            }
        }

        function animateCountUp(element, endValue) {
            const duration = 2500;
            const startTime = performance.now();
            const startValue = 0;
            let lastHapticTime = 0;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);

                const current = Math.floor(startValue + (endValue - startValue) * ease);
                element.innerText = current.toLocaleString();

                // 애니메이션 진행 중 일정 간격으로 햅틱 피드백
                if (progress < 1 && currentTime - lastHapticTime > 80) {
                    if (navigator.vibrate) navigator.vibrate(5);
                    lastHapticTime = currentTime;
                }

                if (progress < 1) requestAnimationFrame(update);
                else element.innerText = endValue.toLocaleString();
            }
            requestAnimationFrame(update);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCommonUI('assets'); // 공통 UI 초기화
            renderAssets();
            window.refreshData = renderAssets; // 공통 송금 로직에서 호출할 갱신 함수 연결
            
            // 모달 드래그 기능 초기화
            initBottomSheetDrag('transferModal', closeTransferModal);
        });

    </script>
</body>
</html>